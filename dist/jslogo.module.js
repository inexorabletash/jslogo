function deg2rad(e){return e/180*Math.PI}function rad2deg(e){return 180*e/Math.PI}function font(e,t){return e=Number(e),t=String(t).toLowerCase(),-1===["serif","sans-serif","cursive","fantasy","monospace"].indexOf(t)&&(t=JSON.stringify(t)),String(e)+"px "+t}function mod(e,t){var r=e%t;return r<0?r+t:r}function CanvasTurtle(e,t,r,n,i){if(e.fillText=e.fillText||function(e,t,r){},this.canvas_ctx=e,this.turtle_ctx=t,this.width=Number(r),this.height=Number(n),this.x=this.py=0,this.y=this.py=0,this.r=Math.PI/2,this.sx=this.sy=1,this.color="#000000",this.bgcolor="#ffffff",this.penwidth=1,this.penmode="paint",this.fontsize=14,this.fontname="sans-serif",this.turtlemode="wrap",this.visible=!0,this.pendown=!0,this.was_oob=!1,this.filling=0,this._clickx=this._clicky=0,this._mousex=this._mousey=0,this._buttons=0,this._touches=[],this._init(),this._tick(),i){var s=function(e){var t=i.getBoundingClientRect();this._mousemove(e.clientX-t.left,e.clientY-t.top,e.buttons)}.bind(this);["mousemove","mousedown","mouseup"].forEach(function(e){i.addEventListener(e,s)});var o=function(e){var t=i.getBoundingClientRect(),r=Array.from(e.touches).map(function(e){return{x:e.clientX-t.left,y:e.clientY-t.top}});this._touch(r)}.bind(this);["touchstart","touchmove","touchend"].forEach(function(e){i.addEventListener(e,o)})}}function LogoInterpreter(turtle,stream,savehook){var self=this,UNARY_MINUS="<UNARYMINUS>",ERRORS={BAD_INPUT:4,NO_OUTPUT:5,NOT_ENOUGH_INPUTS:6,TOO_MANY_INPUTS:8,BAD_OUTPUT:9,MISSING_PAREN:10,BAD_VAR:11,BAD_PAREN:12,ALREADY_DEFINED:15,THROW_ERROR:21,IS_PRIMITIVE:22,BAD_PROC:24,NO_TEST:25,BAD_BRACKET:26,BAD_BRACE:27,USER_GENERATED:35,MISSING_SPACE:39};function saveproc(e,t){savehook&&savehook(String(e).toLowerCase(),t)}function format(e,t){return e.replace(/{(\w+)(:[UL])?}/g,function(e,r,n){var i="_PROC_"===r?self.stack[self.stack.length-1]:String(t[r]);switch(n){case":U":return i.toUpperCase();case":L":return i.toLowerCase();default:return i}})}function __(e){return self.localize&&self.localize(e)||e}function err(e,t,r){"number"==typeof t&&(r=t,t=void 0);var n=new LogoError("ERROR",void 0,format(__(e),t));return void 0!==r&&(n.code=r),n}function LogoError(e,t,r){this.name="LogoError",this.message=r||format(__("No CATCH for tag {tag}"),{tag:e}),this.tag=e,this.value=t,this.proc=self.stack[self.stack.length-1],this.code=-1,this.line=-1}function isKeyword(e,t){return"word"===Type(e)&&(e=String(e).toUpperCase(),self.keywordAlias&&(e=self.keywordAlias(e)||e),e===t)}function promiseLoop(e){return new Promise(function(t,r){!function n(){try{e(n,t,r)}catch(e){r(e)}}()})}function serialExecute(e){var t=[];return promiseLoop(function(r,n,i){e.length?Promise.resolve(e.shift()()).then(function(e){t.push(e),r()},i):n(t)})}function promiseFinally(e,t){return e.then(function(e){return Promise.resolve(t()).then(function(){return e})},function(e){return Promise.resolve(t()).then(function(){throw e})})}this.localize=null,this.keywordAlias=null;var lastTimeYielded=Date.now();function promiseYield(){var e=Date.now();return e-lastTimeYielded>20?(lastTimeYielded=e,new Promise(function(e){setTimeout(e,0)})):Promise.resolve()}function promiseYieldTime(e){return lastTimeYielded=Date.now()+2*e,new Promise(function(t){setTimeout(t,e)})}function to_arity($$func$$,arity){var parms=[];if($$func$$.length===arity)return $$func$$;for(var i=0;i<arity;++i)parms.push("a"+i);var f=eval("(function "+$$func$$.name+"("+parms.join(",")+"){ return $$func$$.apply(this, arguments); })");return f}function PRNG(e){var t=2147483647&e,r=2147483647,n=r/48271;this.next=function(){var e=t%n*48271-t/n*3399;return this.last=(t=e>0?e:e+r)/r,this.last},this.seed=function(e){t=2147483647&e},this.next()}function StringMap(e){this._map=new Map,this._case_fold=e}function LogoArray(e,t){this._array=[],this._array.length=e;for(var r=0;r<this._array.length;++r)this._array[r]=[];this._origin=t}function Stream(e){this._string=e,this._index=0,this._skip()}function Output(e){this.output=e}function Bye(){}function Type(e){if(void 0===e)throw err("No output from procedure",ERRORS.NO_OUTPUT);if("string"==typeof e||"number"==typeof e)return"word";if(Array.isArray(e))return"list";if(e instanceof LogoArray)return"array";throw"then"in Object(e)?new Error("Internal error: Unexpected value: a promise"):e?new Error("Internal error: Unexpected value: unknown type"):new Error("Internal error: Unexpected value: null")}function parse(e){if(void 0!==e){for(var t,r=[],n=new Stream(e);n.peek();){for(var i,s=isWS(n.peek());isWS(n.peek());)n.get();if(!n.peek())break;if("["===n.peek())n.get(),i=parseList(n);else{if("]"===n.peek())throw err("Unexpected ']'",ERRORS.BAD_BRACKET);if("{"===n.peek())n.get(),i=parseArray(n);else{if("}"===n.peek())throw err("Unexpected '}'",ERRORS.BAD_BRACE);if('"'===n.peek())i=parseQuoted(n);else if(isOwnWord(n.peek()))i=n.get();else if(inRange(n.peek(),"0","9"))i=parseNumber(n);else if(inChars(n.peek(),OPERATOR_CHARS)){if("-"===(i=parseOperator(n))){var o=isWS(n.peek());(void 0===t||"word"===Type(t)&&isInfix(t)||"word"===Type(t)&&"("===t||s&&!o)&&(i=UNARY_MINUS)}}else{if(inChars(n.peek(),WORD_DELIMITER))throw err("Couldn't parse: '{string}'",{string:n.rest});i=parseWord(n)}}}r.push(i),t=i}return r}}function inRange(e,t,r){return t<=e&&e<=r}function inChars(e,t){return e&&-1!==t.indexOf(e)}Object.defineProperties(StringMap.prototype,{get:{value:function(e){return e=this._case_fold?String(e).toLowerCase():String(e),this._map.get(e)}},set:{value:function(e,t){e=this._case_fold?String(e).toLowerCase():String(e),this._map.set(e,t)}},has:{value:function(e){return e=this._case_fold?String(e).toLowerCase():String(e),this._map.has(e)}},delete:{value:function(e){return e=this._case_fold?String(e).toLowerCase():String(e),this._map.delete(e)}},keys:{value:function(){var e=[];return this._map.forEach(function(t,r){e.push(r)}),e}},empty:{value:function(){return 0===this._map.size}},forEach:{value:function(e){return this._map.forEach(function(t,r){e(r,t)})}}}),LogoArray.from=function(e,t){var r=new LogoArray(0,t);return r._array=Array.from(e),r},Object.defineProperties(LogoArray.prototype,{item:{value:function(e){if(e=0|Number(e),(e-=this._origin)<0||e>=this._array.length)throw err("{_PROC_}: Index out of bounds",ERRORS.BAD_INPUT);return this._array[e]}},setItem:{value:function(e,t){if(e=0|Number(e),(e-=this._origin)<0||e>=this._array.length)throw err("{_PROC_}: Index out of bounds",ERRORS.BAD_INPUT);this._array[e]=t}},list:{get:function(){return this._array}},origin:{get:function(){return this._origin}},length:{get:function(){return this._array.length}}}),Object.defineProperties(Stream.prototype,{eof:{get:function(){return this._index>=this._string.length}},peek:{value:function(){var e=this._string.charAt(this._index);return"\\"===e&&(e+=this._string.charAt(this._index+1)),e}},get:{value:function(){var e=this._next();return this._skip(),e}},_next:{value:function(){var e=this._string.charAt(this._index++);return"\\"===e&&(e+=this._string.charAt(this._index++)),e}},_skip:{value:function(){for(;!this.eof;){var e=this.peek();if("~"===e&&"\n"===this._string.charAt(this._index+1))this._index+=2;else{if(";"!==e)return;do{e=this._next()}while(!this.eof&&"\n"!==this.peek());"~"===e&&this._next()}}}},rest:{get:function(){return this._string.substring(this._index)}}}),self.turtle=turtle,self.stream=stream,self.routines=new StringMap(!0),self.scopes=[new StringMap(!0)],self.plists=new StringMap(!0),self.prng=new PRNG(2147483647*Math.random()),self.forceBye=!1,Output.prototype.toString=function(){return this.output},Output.prototype.valueOf=function(){return this.output};var WS_CHARS=" \f\n\r\t\v";function isWS(e){return inChars(e,WS_CHARS)}var QUOTED_DELIMITER=WS_CHARS+"[](){}";function parseQuoted(e){for(var t="";!e.eof&&-1===QUOTED_DELIMITER.indexOf(e.peek());){var r=e.get();t+="\\"===r.charAt(0)?r.charAt(1):r.charAt(0)}return t}var OWNWORD_CHARS="←↑→↓";function isOwnWord(e){return inChars(e,OWNWORD_CHARS)}var WORD_DELIMITER=WS_CHARS+"[](){}+-*/%^=<>";function parseWord(e){for(var t="";!e.eof&&-1===WORD_DELIMITER.indexOf(e.peek());){var r=e.get();t+="\\"===r.charAt(0)?r.charAt(1):r.charAt(0)}return t}var OPERATOR_CHARS="+-*/%^=<>[]{}()";function parseOperator(e){var t="";return inChars(e.peek(),OPERATOR_CHARS)&&(t+=e.get()),("<"===t&&"="===e.peek()||">"===t&&"="===e.peek()||"<"===t&&">"===e.peek())&&(t+=e.get()),t}function isInfix(e){return["+","-","*","/","%","^","=","<",">","<=",">=","<>"].includes(e)}function isOperator(e){return isInfix(e)||["[","]","{","}","(",")"].includes(e)}function parseNumber(e){for(var t="";inRange(e.peek(),"0","9");)t+=e.get();if("."===e.peek()&&(t+=e.get()),inRange(e.peek(),"0","9"))for(;inRange(e.peek(),"0","9");)t+=e.get();if("E"===e.peek()||"e"===e.peek())for(t+=e.get(),"-"!==e.peek()&&"+"!==e.peek()||(t+=e.get());inRange(e.peek(),"0","9");)t+=e.get();return t}function isNumber(e){return String(e).match(/^-?([0-9]*\.?[0-9]+(?:[eE][\-+]?[0-9]+)?)$/)}function parseInteger(e){var t="";for("-"===e.peek()&&(t+=e.get());inRange(e.peek(),"0","9");)t+=e.get();return t}function parseList(e){for(var t,r=[],n="";;){do{t=e.get()}while(isWS(t));for(;t&&!isWS(t)&&-1==="[]{}".indexOf(t);)n+=t,t=e.get();if(n.length&&(r.push(n),n=""),!t)throw err("Expected ']'",ERRORS.BAD_BRACKET);if(!isWS(t)){if("]"===t)return r;if("["!==t){if("{"!==t){if("}"===t)throw err("Unexpected '}'",ERRORS.BAD_BRACE);throw err("Unexpected '{c}'",{c:t})}r.push(parseArray(e))}else r.push(parseList(e))}}}function parseArray(e){for(var t,r=[],n=1,i="";;){do{t=e.get()}while(isWS(t));for(;t&&!isWS(t)&&-1==="[]{}".indexOf(t);)i+=t,t=e.get();if(i.length&&(r.push(i),i=""),!t)throw err("Expected '}'",ERRORS.BAD_BRACE);if(!isWS(t)){if("}"===t){for(;isWS(e.peek());)e.get();if("@"===e.peek()){for(e.get();isWS(e.peek());)e.get();n=Number(parseInteger(e)||0)}return LogoArray.from(r,n)}if("["!==t){if("]"===t)throw err("Unexpected ']'",ERRORS.BAD_BRACKET);if("{"!==t)throw err("Unexpected '{c}'",{c:t});r.push(parseArray(e))}else r.push(parseList(e))}}}function reparse(e){return parse(stringify_nodecorate(e).replace(/([\\;])/g,"\\$1"))}function maybegetvar(e){var t=lvalue(e);return t?t.value:void 0}function getvar(e){var t=maybegetvar(e);if(void 0!==t)return t;throw err("Don't know about variable {name:U}",{name:e},ERRORS.BAD_VAR)}function lvalue(e){for(var t=self.scopes.length-1;t>=0;--t)if(self.scopes[t].has(e))return self.scopes[t].get(e)}function setvar(e,t){t=copy(t);var r=lvalue(e);r?r.value=t:self.scopes[0].set(e,r={value:t})}function local(e){self.scopes[self.scopes.length-1].set(sexpr(e),{value:void 0})}function setlocal(e,t){t=copy(t),self.scopes[self.scopes.length-1].set(sexpr(e),{value:t})}function peek(e,t){if(e.length<1)return!1;var r=e[0];return t.some(function(e){return r===e})}function evaluateExpression(e){return expression(e)()}function expression(e){return relationalExpression(e)}function relationalExpression(e){for(var t,r=additiveExpression(e);peek(e,["=","<",">","<=",">=","<>"]);)t=e.shift(),r=function(r){var n=additiveExpression(e);switch(t){case"<":return defer(function(e,t){return aexpr(e)<aexpr(t)?1:0},r,n);case">":return defer(function(e,t){return aexpr(e)>aexpr(t)?1:0},r,n);case"=":return defer(function(e,t){return equal(e,t)?1:0},r,n);case"<=":return defer(function(e,t){return aexpr(e)<=aexpr(t)?1:0},r,n);case">=":return defer(function(e,t){return aexpr(e)>=aexpr(t)?1:0},r,n);case"<>":return defer(function(e,t){return equal(e,t)?0:1},r,n);default:throw new Error("Internal error in expression parser")}}(r);return r}function defer(e){var t=[].slice.call(arguments,1);return function(){return serialExecute(t.slice()).then(function(t){return e.apply(null,t)})}}function additiveExpression(e){for(var t,r=multiplicativeExpression(e);peek(e,["+","-"]);)t=e.shift(),r=function(r){var n=multiplicativeExpression(e);switch(t){case"+":return defer(function(e,t){return aexpr(e)+aexpr(t)},r,n);case"-":return defer(function(e,t){return aexpr(e)-aexpr(t)},r,n);default:throw new Error("Internal error in expression parser")}}(r);return r}function multiplicativeExpression(e){for(var t,r=powerExpression(e);peek(e,["*","/","%"]);)t=e.shift(),r=function(r){var n=powerExpression(e);switch(t){case"*":return defer(function(e,t){return aexpr(e)*aexpr(t)},r,n);case"/":return defer(function(e,t){var r=aexpr(e),n=aexpr(t);if(0===n)throw err("Division by zero",ERRORS.BAD_INPUT);return r/n},r,n);case"%":return defer(function(e,t){var r=aexpr(e),n=aexpr(t);if(0===n)throw err("Division by zero",ERRORS.BAD_INPUT);return r%n},r,n);default:throw new Error("Internal error in expression parser")}}(r);return r}function powerExpression(e){for(var t=unaryExpression(e);peek(e,["^"]);)e.shift(),t=function(t){return defer(function(e,t){return Math.pow(aexpr(e),aexpr(t))},t,unaryExpression(e))}(t);return t}function unaryExpression(e){return peek(e,[UNARY_MINUS])?(e.shift(),defer(function(e){return-aexpr(e)},unaryExpression(e))):finalExpression(e)}function finalExpression(e){if(!e.length)throw err("Unexpected end of instructions",ERRORS.MISSING_PAREN);var t,r,n,i=e.shift();switch(Type(i)){case"array":case"list":return function(){return i};case"word":if(isNumber(i))return i=parseFloat(i),function(){return i};if('"'===(i=String(i)).charAt(0)||"'"===i.charAt(0))return r=i.substring(1),function(){return r};if(":"===i.charAt(0))return n=i.substring(1),function(){return getvar(n)};if("("===i){if(e.length&&"word"===Type(e[0])&&self.routines.has(String(e[0]))&&!(e.length>1&&"word"===Type(e[1])&&isInfix(String(e[1]))))return i=e.shift(),self.dispatch(i,e,!1);if(t=expression(e),!e.length)throw err("Expected ')'",ERRORS.MISSING_PAREN);if(!peek(e,[")"]))throw err("Expected ')', saw {word}",{word:e.shift()},ERRORS.MISSING_PAREN);return e.shift(),t}if(")"===i)throw err("Unexpected ')'",ERRORS.BAD_PAREN);return self.dispatch(i,e,!0);default:throw new Error("Internal error in expression parser")}}function aexpr(e){if(void 0===e)throw err("Expected number",ERRORS.BAD_INPUT);switch(Type(e)){case"word":if(isNumber(e))return parseFloat(e)}throw err("Expected number",ERRORS.BAD_INPUT)}function sexpr(e){if(void 0===e)throw err("Expected string",ERRORS.BAD_INPUT);if(e===UNARY_MINUS)return"-";if("word"===Type(e))return String(e);throw new err("Expected string",ERRORS.BAD_INPUT)}function lexpr(e){if(void 0===e)throw err("{_PROC_}: Expected list",ERRORS.BAD_INPUT);switch(Type(e)){case"word":return Array.from(String(e));case"list":return copy(e)}throw err("{_PROC_}: Expected list",ERRORS.BAD_INPUT)}function sifw(e,t){return"word"===Type(e)?t.join(""):t}function copy(e){switch(Type(e)){case"list":return e.map(copy);default:return e}}function equal(e,t){if(Type(e)!==Type(t))return!1;switch(Type(e)){case"word":return"number"==typeof e||"number"==typeof t?Number(e)===Number(t):String(e)===String(t);case"list":if(e.length!==t.length)return!1;for(var r=0;r<e.length;++r)if(!equal(e[r],t[r]))return!1;return!0;case"array":return e===t}}self.stack=[],self.dispatch=function(e,t,r){e=e.toUpperCase();var n=self.routines.get(e);if(!n){var i;if((i=/^(\w+?)(\d+)$/.exec(e))&&self.routines.get(i[1]))throw err("Need a space between {name:U} and {value}",{name:i[1],value:i[2]},ERRORS.MISSING_SPACE);throw err("Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC)}if(n.special){self.stack.push(e);try{return n.call(self,t),function(){}}finally{self.stack.pop()}}var s=[];if(r)for(var o=0;o<n.default;++o)s.push(expression(t));else{for(;t.length&&!peek(t,[")"]);)s.push(expression(t));if(t.shift(),s.length<n.minimum)throw err("Not enough inputs for {name:U}",{name:e},ERRORS.NOT_ENOUGH_INPUTS);if(-1!==n.maximum&&s.length>n.maximum)throw err("Too many inputs for {name:U}",{name:e},ERRORS.TOO_MANY_INPUTS)}return n.noeval?function(){return self.stack.push(e),promiseFinally(n.apply(self,s),function(){self.stack.pop()})}:function(){return self.stack.push(e),promiseFinally(serialExecute(s.slice()).then(function(e){return n.apply(self,e)}),function(){self.stack.pop()})}},self.execute=function(e,t){var r;return t=Object(t),e=e.slice(),promiseLoop(function(n,i,s){if(self.forceBye)return self.forceBye=!1,void s(new Bye);e.length?Promise.resolve(evaluateExpression(e)).then(function(e){void 0===e||t.returnResult?(r=e,n()):s(err("Don't know what to do with {result}",{result:e},ERRORS.BAD_OUTPUT))},s):i(r)})},self.bye=function(){self.forceBye=!0};var lastRun=Promise.resolve();function stringify(e){switch(Type(e)){case"list":return"["+e.map(stringify).join(" ")+"]";case"array":return"{"+e.list.map(stringify).join(" ")+"}"+(1===e.origin?"":"@"+e.origin);default:return sexpr(e)}}function stringify_nodecorate(e){switch(Type(e)){case"list":return e.map(stringify).join(" ");case"array":return e.list.map(stringify).join(" ");default:return sexpr(e)}}function def(e,t,r){t.minimum=t.default=t.maximum=t.length,r&&Object.keys(r).forEach(function(e){t[e]=r[e]}),t.primitive=!0,Array.isArray(e)?e.forEach(function(e){self.routines.set(e,t)}):self.routines.set(e,t)}function defineProc(e,t,r,n,i,s){if(self.routines.has(e)&&self.routines.get(e).primitive)throw err("{_PROC_}: Can't redefine primitive {name:U}",{name:e},ERRORS.IS_PRIMITIVE);if(void 0!==i&&(i<t.length||!n&&i>t.length+r.length))throw err("{_PROC_}: Bad default number of inputs for {name:U}",{name:e},ERRORS.BAD_INPUT);var o=void 0===i?t.length:i,u=to_arity(function(){var e=new StringMap(!0);self.scopes.push(e);for(var i,o=0;o<t.length&&o<arguments.length;++o)e.set(t[o],{value:arguments[o]});for(;o<t.length+r.length&&o<arguments.length;++o)e.set((i=r[o-t.length])[0],{value:arguments[o]});for(;o<t.length+r.length;++o)e.set((i=r[o-t.length])[0],{value:evaluateExpression(reparse(i[1]))});return n&&e.set(n,{value:[].slice.call(arguments,o)}),promiseFinally(self.execute(s).then(promiseYield,function(e){if(e instanceof Output)return e.output;throw e}),function(){self.scopes.pop()})},o);self.routines.set(e,u),u.inputs=t,u.optional_inputs=r,u.rest=n,u.def=i,u.block=s,u.minimum=t.length,u.default=o,u.maximum=n?-1:t.length+r.length,saveproc(e,self.definition(e,u))}function item(e,t){switch(Type(t)){case"list":if(e<1||e>t.length)throw err("{_PROC_}: Index out of bounds",ERRORS.BAD_INPUT);return t[e-1];case"array":return t.item(e);default:if(t=sexpr(t),e<1||e>t.length)throw err("{_PROC_}: Index out of bounds",ERRORS.BAD_INPUT);return t.charAt(e-1)}}function contains(e,t){if(e===t)return!0;switch(Type(e)){case"list":return e.some(function(e){return contains(e,t)});case"array":return e.list.some(function(e){return contains(e,t)});default:return!1}}function deg2rad(e){return e/180*Math.PI}function rad2deg(e){return 180*e/Math.PI}function truncate(e){return parseInt(e,10)}function booleanReduce(e,t,r){return promiseLoop(function(n,i,s){e.length?Promise.resolve(e.shift()()).then(function(e){t(e)?(r=e,n()):i(e)}):i(r)})}self.queueTask=function(e){var t=lastRun.then(function(){return Promise.resolve(e())});return lastRun=t.catch(function(){}),t},self.run=function(e,t){return t=Object(t),self.queueTask(function(){var r=parse(e);return self.execute(r,t).catch(function(e){if(!(e instanceof Bye))throw e})})},self.definition=function(e,t){function r(e){switch(Type(e)){case"word":return String(e);case"list":return"[ "+e.map(r).join(" ")+" ]";case"array":return"{ "+e.list.map(r).join(" ")+" }"+(1===e.origin?"":"@"+e.origin);default:throw new Error("Internal error: unknown type")}}var n="to "+e;return n+=t.inputs.map(function(e){return" :"+e}).join(""),n+=t.optional_inputs.map(function(e){return" [:"+e[0]+" "+e[1].map(r).join(" ")+"]"}).join(""),t.rest&&(n+=" [:"+t.rest+"]"),void 0!==t.def&&(n+=" "+t.def),n+="\n",(n+="  "+t.block.map(r).join(" ").replace(new RegExp(UNARY_MINUS+" ","g"),"-"))+"\nend"},self.procdefs=function(){var e=[];return self.routines.forEach(function(t,r){r.primitive||e.push(self.definition(t,r))}),e.join("\n\n")},self.copydef=function(e,t){self.routines.set(e,self.routines.get(t))},def("to",function(e){var t=sexpr(e.shift());if(isNumber(t)||isOperator(t))throw err("TO: Expected identifier",ERRORS.BAD_INPUT);for(var r=[],n=[],i=void 0,s=void 0,o=[],u=0,a=!1;e.length;){var f=e.shift();if(isKeyword(f,"END")){a=!0;break}if(0===u){if("word"===Type(f)&&":"===String(f).charAt(0)){r.push(f.substring(1));continue}u=1}if(1===u){if("list"===Type(f)&&f.length>1&&":"===String(f[0]).charAt(0)){n.push([f.shift().substring(1),f]);continue}u=2}2!==u||(u=3,"list"!==Type(f)||1!==f.length||":"!==String(f[0]).charAt(0))?3===u&&(u=4,"word"===Type(f)&&isNumber(f))?s=parseFloat(f):o.push(f):i=f[0].substring(1)}if(!a)throw err("TO: Expected END",ERRORS.BAD_INPUT);defineProc(t,r,n,i,s,o)},{special:!0}),def("def",function(e){var t=sexpr(e),r=this.routines.get(t);if(!r)throw err("{_PROC_}: Don't know how to {name:U}",{name:t},ERRORS.BAD_PROC);if(!r.inputs)throw err("{_PROC_}: Can't show definition of primitive {name:U}",{name:t},ERRORS.IS_PRIMITIVE);return this.definition(t,r)}),def("word",function(e,t){return arguments.length?Array.from(arguments).map(sexpr).reduce(function(e,t){return e+t}):""},{minimum:0,maximum:-1}),def("list",function(e,t){return Array.from(arguments).map(function(e){return e})},{minimum:0,maximum:-1}),def(["sentence","se"],function(e,t){for(var r=[],n=0;n<arguments.length;++n){var i=arguments[n];"list"===Type(i)?(i=lexpr(i),r=r.concat(i)):r.push(i)}return r},{minimum:0,maximum:-1}),def("fput",function(e,t){var r=lexpr(t);return r.unshift(e),sifw(t,r)}),def("lput",function(e,t){var r=lexpr(t);return r.push(e),sifw(t,r)}),def("array",function(e){if((e=aexpr(e))<1)throw err("{_PROC_}: Array size must be positive integer",ERRORS.BAD_INPUT);var t=arguments.length<2?1:aexpr(arguments[1]);return new LogoArray(e,t)},{maximum:2}),def("mdarray",function(e){if((e=lexpr(e).map(aexpr).map(function(e){return 0|e})).some(function(e){return e<1}))throw err("{_PROC_}: Array size must be positive integer",ERRORS.BAD_INPUT);var t=arguments.length<2?1:aexpr(arguments[1]);function r(n){var i=e[n],s=new LogoArray(i,t);if(n+1<e.length)for(var o=0;o<i;++o)s.setItem(o+t,r(n+1));return s}return r(0)},{maximum:2}),def("listtoarray",function(e){e=lexpr(e);var t=1;return arguments.length>1&&(t=aexpr(arguments[1])),LogoArray.from(e,t)},{maximum:2}),def("arraytolist",function(e){if("array"!==Type(e))throw err("{_PROC_}: Expected array",ERRORS.BAD_INPUT);return e.list.slice()}),def("combine",function(e,t){return"list"!==Type(t)?this.routines.get("word")(e,t):this.routines.get("fput")(e,t)}),def("reverse",function(e){var t=arguments.length>1?arguments[1]:"list"===Type(e)?[]:"";return sifw(t,lexpr(e).reverse().concat(lexpr(t)))},{maximum:2}),this.gensym_index=0,def("gensym",function(){return++this.gensym_index,"G"+this.gensym_index}),def("first",function(e){return lexpr(e)[0]}),def("firsts",function(e){return lexpr(e).map(function(e){return e[0]})}),def("last",function(e){return(e=lexpr(e))[e.length-1]}),def(["butfirst","bf"],function(e){return sifw(e,lexpr(e).slice(1))}),def(["butfirsts","bfs"],function(e){return lexpr(e).map(function(e){return sifw(e,lexpr(e).slice(1))})}),def(["butlast","bl"],function(e){return"word"===Type(e)?String(e).slice(0,-1):lexpr(e).slice(0,-1)}),def("item",function(e,t){return item(e=0|aexpr(e),t)}),def("mditem",function(e,t){for(e=lexpr(e).map(aexpr).map(function(e){return 0|e});e.length;)t=item(e.shift(),t);return t}),def("pick",function(e){return(e=lexpr(e))[Math.floor(this.prng.next()*e.length)]}),def("remove",function(e,t){return sifw(t,lexpr(t).filter(function(t){return!equal(t,e)}))}),def("remdup",function(e){var t=new Set;return sifw(e,lexpr(e).filter(function(e){return!t.has(e)&&(t.add(e),!0)}))}),def("split",function(e,t){return lexpr(t),lexpr(t).reduce(function(t,r){return equal(r,e)?t.push([]):t[t.length-1].push(r),t},[[]]).filter(function(e){return e.length>0}).map(function(e){return sifw(t,e)})}),def("quoted",function(e){return"word"===Type(e)?'"'+e:e}),def("setitem",function(e,t,r){if(e=aexpr(e),"array"!==Type(t))throw err("{_PROC_}: Expected array",ERRORS.BAD_INPUT);if(contains(r,t))throw err("{_PROC_}: Can't create circular array",ERRORS.BAD_INPUT);t.setItem(e,r)}),def("mdsetitem",function(e,t,r){if(e=lexpr(e).map(aexpr).map(function(e){return 0|e}),"array"!==Type(t))throw err("{_PROC_}: Expected array",ERRORS.BAD_INPUT);if(contains(r,t))throw err("{_PROC_}: Can't create circular array",ERRORS.BAD_INPUT);for(;e.length>1;)if("array"!==Type(t=item(e.shift(),t)))throw err("{_PROC_}: Expected array",ERRORS.BAD_INPUT);t.setItem(e.shift(),r)}),def(".setfirst",function(e,t){if("list"!==Type(e))throw err("{_PROC_}: Expected list",ERRORS.BAD_INPUT);e[0]=t}),def(".setbf",function(e,t){if("list"!==Type(e))throw err("{_PROC_}: Expected non-empty list",ERRORS.BAD_INPUT);if(e.length<1)throw err("{_PROC_}: Expected non-empty list",ERRORS.BAD_INPUT);t=lexpr(t),e.length=1,e.push.apply(e,t)}),def(".setitem",function(e,t,r){if(e=aexpr(e),"array"!==Type(t))throw err("{_PROC_}: Expected array",ERRORS.BAD_INPUT);t.setItem(e,r)}),def("push",function(e,t){var r=getvar(e),n=lexpr(r);n.unshift(t),setvar(e,sifw(r,n))}),def("pop",function(e){var t=getvar(e),r=lexpr(t),n=r.shift();return setvar(e,sifw(t,r)),n}),def("queue",function(e,t){var r=getvar(e),n=lexpr(r);n.push(t),setvar(e,sifw(r,n))}),def("dequeue",function(e){var t=getvar(e),r=lexpr(t),n=r.pop();return setvar(e,sifw(t,r)),n}),def(["wordp","word?"],function(e){return"word"===Type(e)?1:0}),def(["listp","list?"],function(e){return"list"===Type(e)?1:0}),def(["arrayp","array?"],function(e){return"array"===Type(e)?1:0}),def(["numberp","number?"],function(e){return"word"===Type(e)&&isNumber(e)?1:0}),def(["numberwang"],function(e){return this.prng.next()<.5?1:0}),def(["equalp","equal?"],function(e,t){return equal(e,t)?1:0}),def(["notequalp","notequal?"],function(e,t){return equal(e,t)?0:1}),def(["emptyp","empty?"],function(e){switch(Type(e)){case"word":return 0===String(e).length?1:0;case"list":return 0===e.length?1:0;default:return 0}}),def(["beforep","before?"],function(e,t){return sexpr(e)<sexpr(t)?1:0}),def(".eq",function(e,t){return e===t&&e&&"object"==typeof e}),def(["memberp","member?"],function(e,t){return lexpr(t).some(function(t){return equal(t,e)})?1:0}),def(["substringp","substring?"],function(e,t){return-1!==sexpr(t).indexOf(sexpr(e))?1:0}),def("count",function(e){return"array"===Type(e)?e.length:lexpr(e).length}),def("ascii",function(e){return sexpr(e).charCodeAt(0)}),def("char",function(e){return String.fromCharCode(aexpr(e))}),def("member",function(e,t){var r=lexpr(t),n=r.findIndex(function(t){return equal(t,e)});return sifw(t,r=-1===n?[]:r.slice(n))}),def("lowercase",function(e){return sexpr(e).toLowerCase()}),def("uppercase",function(e){return sexpr(e).toUpperCase()}),def("standout",function(e){return sexpr(e).split("").map(function(e){var t=e.charCodeAt(0);if("A"<=e&&e<="Z")t=t-65+119808;else if("a"<=e&&e<="z")t=t-97+119834;else{if(!("0"<=e&&e<="9"))return e;t=t-48+120782}return String.fromCharCode(55296+(t-65536>>10),56320+(t-65536&1023))}).join("")}),def("parse",function(e){return parse("["+sexpr(e)+"]")[0]}),def("runparse",function(e){return parse(sexpr(e))}),def(["print","pr"],function(e){var t=Array.from(arguments).map(stringify_nodecorate).join(" ");return this.stream.write(t,"\n")},{minimum:0,maximum:-1}),def("type",function(e){var t=Array.from(arguments).map(stringify_nodecorate).join("");return this.stream.write(t)},{minimum:0,maximum:-1}),def("show",function(e){var t=Array.from(arguments).map(stringify).join(" ");return this.stream.write(t,"\n")},{minimum:0,maximum:-1}),def("readlist",function(){return(arguments.length>0?stream.read(stringify_nodecorate(arguments[0])):stream.read()).then(function(e){return parse("["+e+"]")[0]})},{maximum:1}),def("readword",function(){return arguments.length>0?stream.read(stringify_nodecorate(arguments[0])):stream.read()},{maximum:1}),def(["cleartext","ct"],function(){return this.stream.clear()}),def("settextcolor",function(e){this.stream.color=parseColor(e)}),def("textcolor",function(){return this.stream.color}),def("increasefont",function(){this.stream.textsize=Math.round(1.25*this.stream.textsize)}),def("decreasefont",function(){this.stream.textsize=Math.round(this.stream.textsize/1.25)}),def("settextsize",function(e){this.stream.textsize=aexpr(e)}),def("textsize",function(){return this.stream.textsize}),def("setfont",function(e){this.stream.font=sexpr(e)}),def("font",function(){return this.stream.font}),def("sum",function(e,t){return Array.from(arguments).map(aexpr).reduce(function(e,t){return e+t},0)},{minimum:0,maximum:-1}),def("difference",function(e,t){return aexpr(e)-aexpr(t)}),def("minus",function(e){return-aexpr(e)}),def("product",function(e,t){return Array.from(arguments).map(aexpr).reduce(function(e,t){return e*t},1)},{minimum:0,maximum:-1}),def("quotient",function(e,t){return void 0!==t?aexpr(e)/aexpr(t):1/aexpr(e)},{minimum:1}),def("remainder",function(e,t){return aexpr(e)%aexpr(t)}),def("modulo",function(e,t){return e=aexpr(e),t=aexpr(t),Math.abs(e%t)*(t<0?-1:1)}),def("power",function(e,t){return Math.pow(aexpr(e),aexpr(t))}),def("sqrt",function(e){return Math.sqrt(aexpr(e))}),def("exp",function(e){return Math.exp(aexpr(e))}),def("log10",function(e){return Math.log(aexpr(e))/Math.LN10}),def("ln",function(e){return Math.log(aexpr(e))}),def("arctan",function(e){if(arguments.length>1){var t=aexpr(arguments[0]),r=aexpr(arguments[1]);return rad2deg(Math.atan2(r,t))}return rad2deg(Math.atan(aexpr(e)))},{maximum:2}),def("sin",function(e){return Math.sin(deg2rad(aexpr(e)))}),def("cos",function(e){return Math.cos(deg2rad(aexpr(e)))}),def("tan",function(e){return Math.tan(deg2rad(aexpr(e)))}),def("radarctan",function(e){if(arguments.length>1){var t=aexpr(arguments[0]),r=aexpr(arguments[1]);return Math.atan2(r,t)}return Math.atan(aexpr(e))},{maximum:2}),def("radsin",function(e){return Math.sin(aexpr(e))}),def("radcos",function(e){return Math.cos(aexpr(e))}),def("radtan",function(e){return Math.tan(aexpr(e))}),def("abs",function(e){return Math.abs(aexpr(e))}),def("int",function(e){return truncate(aexpr(e))}),def("round",function(e){return Math.round(aexpr(e))}),def("iseq",function(e,t){for(var r=(e=truncate(aexpr(e)))<(t=truncate(aexpr(t)))?1:-1,n=[],i=e;r>0?i<=t:i>=t;i+=r)n.push(i);return n}),def("rseq",function(e,t,r){e=aexpr(e);for(var n=((t=aexpr(t))-e)/((r=truncate(aexpr(r)))-1),i=[],s=e;n>0?s<=t:s>=t;s+=n)i.push(s);return i}),def(["greaterp","greater?"],function(e,t){return aexpr(e)>aexpr(t)?1:0}),def(["greaterequalp","greaterequal?"],function(e,t){return aexpr(e)>=aexpr(t)?1:0}),def(["lessp","less?"],function(e,t){return aexpr(e)<aexpr(t)?1:0}),def(["lessequalp","lessequal?"],function(e,t){return aexpr(e)<=aexpr(t)?1:0}),def("random",function(e){if(arguments.length<2)return e=aexpr(e),Math.floor(this.prng.next()*e);var t=aexpr(arguments[0]),r=aexpr(arguments[1]);return Math.floor(this.prng.next()*(r-t+1))+t},{maximum:2}),def("rerandom",function(){var e=arguments.length>0?aexpr(arguments[0]):2345678901;return this.prng.seed(e)},{maximum:1}),def("form",function(e,t,r){e=aexpr(e),t=aexpr(t),r=aexpr(r);var n=e.toFixed(r);return n.length<t&&(n=Array(1+t-n.length).join(" ")+n),n}),def("bitand",function(e,t){return Array.from(arguments).map(aexpr).reduce(function(e,t){return e&t},-1)},{minimum:0,maximum:-1}),def("bitor",function(e,t){return Array.from(arguments).map(aexpr).reduce(function(e,t){return e|t},0)},{minimum:0,maximum:-1}),def("bitxor",function(e,t){return Array.from(arguments).map(aexpr).reduce(function(e,t){return e^t},0)},{minimum:0,maximum:-1}),def("bitnot",function(e){return~aexpr(e)}),def("ashift",function(e,t){return e=truncate(aexpr(e)),(t=truncate(aexpr(t)))>=0?e<<t:e>>-t}),def("lshift",function(e,t){return e=truncate(aexpr(e)),(t=truncate(aexpr(t)))>=0?e<<t:e>>>-t}),def("true",function(){return 1}),def("false",function(){return 0}),def("and",function(e,t){var r=Array.from(arguments);return booleanReduce(r,function(e){return e},1)},{noeval:!0,minimum:0,maximum:-1}),def("or",function(e,t){var r=Array.from(arguments);return booleanReduce(r,function(e){return!e},0)},{noeval:!0,minimum:0,maximum:-1}),def("xor",function(e,t){return Array.from(arguments).map(aexpr).reduce(function(e,t){return Boolean(e)!==Boolean(t)},0)?1:0},{minimum:0,maximum:-1}),def("not",function(e){return aexpr(e)?0:1}),def(["forward","fd"],function(e){return turtle.move(aexpr(e))}),def(["back","bk"],function(e){return turtle.move(-aexpr(e))}),def(["left","lt"],function(e){return turtle.turn(-aexpr(e))}),def(["right","rt"],function(e){return turtle.turn(aexpr(e))}),def(["←"],function(){return turtle.turn(-15)}),def(["→"],function(){return turtle.turn(15)}),def(["↑"],function(){return turtle.move(10)}),def(["↓"],function(){return turtle.move(-10)}),def("setpos",function(e){if(2!==(e=lexpr(e)).length)throw err("{_PROC_}: Expected list of length 2",ERRORS.BAD_INPUT);turtle.position=[aexpr(e[0]),aexpr(e[1])]}),def("setxy",function(e,t){turtle.position=[aexpr(e),aexpr(t)]}),def("setx",function(e){turtle.position=[aexpr(e),void 0]}),def("sety",function(e){turtle.position=[void 0,aexpr(e)]}),def(["setheading","seth"],function(e){turtle.heading=aexpr(e)}),def("home",function(){return turtle.home()}),def("arc",function(e,t){return turtle.arc(aexpr(e),aexpr(t))}),def("pos",function(){return turtle.position}),def("xcor",function(){return turtle.position[0]}),def("ycor",function(){return turtle.position[1]}),def("heading",function(){return turtle.heading}),def("towards",function(e){if(2!==(e=lexpr(e)).length)throw err("{_PROC_}: Expected list of length 2",ERRORS.BAD_INPUT);return turtle.towards(aexpr(e[0]),aexpr(e[1]))}),def("scrunch",function(){return turtle.scrunch}),def(["showturtle","st"],function(){turtle.visible=!0}),def(["hideturtle","ht"],function(){turtle.visible=!1}),def("clean",function(){turtle.clear()}),def(["clearscreen","cs"],function(){turtle.clearscreen()}),def("wrap",function(){turtle.turtlemode="wrap"}),def("window",function(){turtle.turtlemode="window"}),def("fence",function(){turtle.turtlemode="fence"}),def("fill",function(){turtle.fill()}),def("filled",function(e,t){return e=parseColor(e),t=reparse(lexpr(t)),turtle.beginpath(),promiseFinally(this.execute(t),function(){turtle.fillpath(e)})}),def("label",function(e){var t=Array.from(arguments).map(stringify_nodecorate).join(" ");return turtle.drawtext(t)},{maximum:-1}),def("setlabelheight",function(e){turtle.fontsize=aexpr(e)}),def("setlabelfont",function(e){turtle.fontname=sexpr(e)}),def("setscrunch",function(e,t){if(e=aexpr(e),t=aexpr(t),!isFinite(e)||0===e||!isFinite(t)||0===t)throw err("{_PROC_}: Expected non-zero values",ERRORS.BAD_INPUT);turtle.scrunch=[e,t]}),def(["shownp","shown?"],function(){return turtle.visible?1:0}),def("turtlemode",function(){return turtle.turtlemode.toUpperCase()}),def("labelsize",function(){return[turtle.fontsize,turtle.fontsize]}),def("labelfont",function(){return turtle.fontname}),def(["pendown","pd"],function(){turtle.pendown=!0}),def(["penup","pu"],function(){turtle.pendown=!1}),def(["penpaint","ppt"],function(){turtle.penmode="paint"}),def(["penerase","pe"],function(){turtle.penmode="erase"}),def(["penreverse","px"],function(){turtle.penmode="reverse"}),this.colorAlias=null;var PALETTE={0:"black",1:"blue",2:"lime",3:"cyan",4:"red",5:"magenta",6:"yellow",7:"white",8:"brown",9:"tan",10:"green",11:"aquamarine",12:"salmon",13:"purple",14:"orange",15:"gray"};function parseColor(e){function t(e){return e=Math.min(99,Math.max(0,Math.floor(e))),Math.floor(255*e/99)}if("list"===Type(e)){var r=t(aexpr(e[0])),n=t(aexpr(e[1])),i=t(aexpr(e[2]));return"#"+(r<16?"0":"")+r.toString(16)+(n<16?"0":"")+n.toString(16)+(i<16?"0":"")+i.toString(16)}return e=sexpr(e),PALETTE.hasOwnProperty(e)?PALETTE[e]:self.colorAlias&&self.colorAlias(e)||e}function checkevalblock(e){if("list"===Type(e=e()))return e;throw err("{_PROC_}: Expected block",ERRORS.BAD_INPUT)}def(["setpencolor","setpc","setcolor"],function(e){turtle.color=parseColor(e)}),def("setpalette",function(e,t){if((e=aexpr(e))<8)throw err("{_PROC_}: Expected number greater than 8",ERRORS.BAD_INPUT);PALETTE[e]=parseColor(t)}),def(["setpensize","setwidth","setpw"],function(e){turtle.penwidth="list"===Type(e)?aexpr(e[0]):aexpr(e)}),def(["setbackground","setbg","setscreencolor","setsc"],function(e){turtle.bgcolor=parseColor(e)}),def(["pendownp","pendown?"],function(){return turtle.pendown?1:0}),def("penmode",function(){return turtle.penmode.toUpperCase()}),def(["pencolor","pc"],function(){return turtle.color}),def("palette",function(e){return PALETTE[aexpr(e)]}),def("pensize",function(){return[turtle.penwidth,turtle.penwidth]}),def(["background","bg","getscreencolor","getsc"],function(){return turtle.bgcolor}),def("mousepos",function(){return turtle.mousepos}),def("clickpos",function(){return turtle.clickpos}),def(["buttonp","button?"],function(){return turtle.button>0?1:0}),def("button",function(){return turtle.button}),def("touches",function(){return turtle.touches}),def("define",function(e,t){if(e=sexpr(e),2!=(t=lexpr(t)).length)throw err("{_PROC_}: Expected list of length 2",ERRORS.BAD_INPUT);for(var r=[],n=[],i=void 0,s=void 0,o=reparse(lexpr(t[1])),u=lexpr(t[0]),a=0;u.length;){var f=u.shift();if(0===a){if("word"===Type(f)){r.push(f);continue}a=1}if(1===a){if("list"===Type(f)&&f.length>1&&"word"===Type(f[0])){n.push([f.shift(),f]);continue}a=2}if(2!==a||(a=3,"list"!==Type(f)||1!==f.length||"word"!==Type(f[0]))){if(3!==a||(a=4,"word"!==Type(f)||!isNumber(f)))throw err("{_PROC_}: Unexpected inputs",ERRORS.BAD_INPUT);s=parseFloat(f)}else i=f[0]}defineProc(e,r,n,i,s,o)}),def("text",function(e){var t=this.routines.get(sexpr(e));if(!t)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(!t.inputs)throw err("{_PROC_}: Can't show definition of primitive {name:U}",{name:e},ERRORS.IS_PRIMITIVE);var r=t.inputs.concat(t.optional_inputs);return t.rest&&r.push([t.rest]),void 0!==t.def&&r.push(t.def),[r,t.block]}),def("copydef",function(e,t){if(e=sexpr(e),t=sexpr(t),!this.routines.has(t))throw err("{_PROC_}: Don't know how to {name:U}",{name:t},ERRORS.BAD_PROC);if(this.routines.has(e)){if(this.routines.get(e).special)throw err("{_PROC_}: Can't overwrite special {name:U}",{name:e},ERRORS.BAD_INPUT);if(this.routines.get(e).primitive&&!maybegetvar("redefp"))throw err("{_PROC_}: Can't overwrite primitives unless REDEFP is TRUE",ERRORS.BAD_INPUT)}this.routines.set(e,this.routines.get(t))}),def("make",function(e,t){setvar(sexpr(e),t)}),def("name",function(e,t){setvar(sexpr(t),e)}),def("local",function(e){Array.from(arguments).forEach(function(e){local(sexpr(e))})},{maximum:-1}),def("localmake",function(e,t){setlocal(sexpr(e),t)}),def("thing",function(e){return getvar(sexpr(e))}),def("global",function(e){var t=this.scopes[0];Array.from(arguments).forEach(function(e){t.set(sexpr(e),{value:void 0})})},{maximum:-1}),def("pprop",function(e,t,r){e=sexpr(e),t=sexpr(t);var n=this.plists.get(e);n||(n=new StringMap(!0),this.plists.set(e,n)),n.set(t,r)}),def("gprop",function(e,t){e=sexpr(e),t=sexpr(t);var r=this.plists.get(e);return r&&r.has(t)?r.get(t):[]}),def("remprop",function(e,t){e=sexpr(e),t=sexpr(t);var r=this.plists.get(e);r&&(r.delete(t),r.empty()&&this.plists.delete(e))}),def("plist",function(e){e=sexpr(e);var t=this.plists.get(e);if(!t)return[];var r=[];return t.forEach(function(e,t){r.push(e),r.push(copy(t))}),r}),def(["procedurep","procedure?"],function(e){return e=sexpr(e),this.routines.has(e)?1:0}),def(["primitivep","primitive?"],function(e){return e=sexpr(e),this.routines.has(e)&&this.routines.get(e).primitive?1:0}),def(["definedp","defined?"],function(e){return e=sexpr(e),this.routines.has(e)&&!this.routines.get(e).primitive?1:0}),def(["namep","name?"],function(e){try{return void 0!==getvar(sexpr(e))?1:0}catch(e){return 0}}),def(["plistp","plist?"],function(e){return e=sexpr(e),this.plists.has(e)?1:0}),def("contents",function(){return[this.routines.keys().filter(function(e){return!this.routines.get(e).primitive&&!this.routines.get(e).buried}.bind(this)),this.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return!t.get(e).buried}))},[]),this.plists.keys().filter(function(e){return!this.plists.get(e).buried}.bind(this))]}),def("buried",function(){return[this.routines.keys().filter(function(e){return!this.routines.get(e).primitive&&this.routines.get(e).buried}.bind(this)),this.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return t.get(e).buried}))},[]),this.plists.keys().filter(function(e){return this.plists.get(e).buried}.bind(this))]}),def("traced",function(){return[this.routines.keys().filter(function(e){return!this.routines.get(e).primitive&&this.routines.get(e).traced}.bind(this)),this.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return t.get(e).traced}))},[]),this.plists.keys().filter(function(e){return this.plists.get(e).traced}.bind(this))]}),def(["stepped"],function(){return[this.routines.keys().filter(function(e){return!this.routines.get(e).primitive&&this.routines.get(e).stepped}.bind(this)),this.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return t.get(e).stepped}))},[]),this.plists.keys().filter(function(e){return this.plists.get(e).stepped}.bind(this))]}),def("procedures",function(){return this.routines.keys().filter(function(e){return!this.routines.get(e).primitive&&!this.routines.get(e).buried}.bind(this))}),def("primitives",function(){return this.routines.keys().filter(function(e){return this.routines.get(e).primitive&!this.routines.get(e).buried}.bind(this))}),def("globals",function(){var e=this.scopes[0];return e.keys().filter(function(t){return!e.get(t).buried})}),def("names",function(){return[[],this.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return!t.get(e).buried}))},[])]}),def("plists",function(){return[[],[],this.plists.keys().filter(function(e){return!this.plists.get(e).buried}.bind(this))]}),def("namelist",function(e){return[[],e="list"===Type(e)?lexpr(e):[sexpr(e)]]}),def("pllist",function(e){return[[],[],e="list"===Type(e)?lexpr(e):[sexpr(e)]]}),def("arity",function(e){e=sexpr(e);var t=this.routines.get(e);if(!t)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);return t.special?[-1,-1,-1]:[t.minimum,t.default,t.maximum]}),def("erase",function(e){if((e=lexpr(e)).length&&lexpr(e.shift()).forEach(function(e){if(e=sexpr(e),this.routines.has(e)){if(this.routines.get(e).special)throw err("Can't {_PROC_} special {name:U}",{name:e},ERRORS.BAD_INPUT);if(this.routines.get(e).primitive&&!maybegetvar("redefp"))throw err("Can't {_PROC_} primitives unless REDEFP is TRUE",ERRORS.BAD_INPUT);this.routines.delete(e),saveproc(e)}}.bind(this)),e.length){var t=lexpr(e.shift());this.scopes.forEach(function(e){t.forEach(function(t){t=sexpr(t),e.delete(t)})})}e.length&&lexpr(e.shift()).forEach(function(e){e=sexpr(e),this.plists.delete(e)}.bind(this))}),def("erall",function(){this.routines.keys().filter(function(e){return!this.routines.get(e).primitive&&!this.routines.get(e).buried}.bind(this)).forEach(function(e){this.routines.delete(e),saveproc(e)}.bind(this)),this.scopes.forEach(function(e){e.keys().filter(function(t){return!e.get(t).buried}).forEach(function(t){e.delete(t)})}),this.plists.keys().filter(function(e){return!this.plists.get(e).buried}.bind(this)).forEach(function(e){this.plists.delete(e)}.bind(this))}),def("erps",function(){this.routines.keys().filter(function(e){return!this.routines.get(e).primitive&&!this.routines.get(e).buried}.bind(this)).forEach(function(e){this.routines.delete(e),saveproc(e)}.bind(this))}),def("erns",function(){this.scopes.forEach(function(e){e.keys().filter(function(t){return!e.get(t).buried}).forEach(function(t){e.delete(t)})})}),def("erpls",function(){this.plists.keys().filter(function(e){return!this.plists.get(e).buried}.bind(this)).forEach(function(e){this.plists.delete(e)}.bind(this))}),def("ern",function(e){var t;t="list"===Type(e)?lexpr(e):[sexpr(e)],this.scopes.forEach(function(e){t.forEach(function(t){t=sexpr(t),e.delete(t)})})}),def("erpl",function(e){("list"===Type(e)?lexpr(e):[sexpr(e)]).forEach(function(e){e=sexpr(e),this.plists.delete(e)}.bind(this))}),def("bury",function(e){if((e=lexpr(e)).length&&lexpr(e.shift()).forEach(function(e){e=sexpr(e),this.routines.has(e)&&(this.routines.get(e).buried=!0)}.bind(this)),e.length){var t=lexpr(e.shift());this.scopes.forEach(function(e){t.forEach(function(t){t=sexpr(t),e.has(t)&&(e.get(t).buried=!0)})})}e.length&&lexpr(e.shift()).forEach(function(e){e=sexpr(e),this.plists.has(e)&&(this.plists.get(e).buried=!0)}.bind(this))}),def("buryall",function(){this.routines.forEach(function(e,t){t.buried=!0}),this.scopes.forEach(function(e){e.forEach(function(e,t){t.buried=!0})}),this.plists.forEach(function(e,t){t.buried=!0})}),def("buryname",function(e){var t=this.routines.get("bury"),r=this.routines.get("namelist");return t.call(this,r.call(this,e))}),def("unbury",function(e){if((e=lexpr(e)).length&&lexpr(e.shift()).forEach(function(e){e=sexpr(e),this.routines.has(e)&&(this.routines.get(e).buried=!1)}.bind(this)),e.length){var t=lexpr(e.shift());this.scopes.forEach(function(e){t.forEach(function(t){t=sexpr(t),e.has(t)&&(e.get(t).buried=!1)})})}e.length&&lexpr(e.shift()).forEach(function(e){e=sexpr(e),this.plists.has(e)&&(this.plists.get(e).buried=!1)}.bind(this))}),def("unburyall",function(){this.routines.forEach(function(e,t){t.buried=!1}),this.scopes.forEach(function(e){e.forEach(function(e,t){t.buried=!1})}),this.plists.forEach(function(e,t){t.buried=!1})}),def("unburyname",function(e){var t=this.routines.get("unbury"),r=this.routines.get("namelist");return t.call(this,r.call(this,e))}),def(["buriedp","buried?"],function(e){var t;if((e=lexpr(e)).length){var r=lexpr(e.shift());if(r.length)return t=sexpr(r[0]),this.routines.has(t)&&this.routines.get(t).buried?1:0}if(e.length){var n=lexpr(e.shift());if(n.length)return t=sexpr(n[0]),this.scopes[0].has(t)&&this.scopes[0].get(t).buried?1:0}if(e.length){var i=lexpr(e.shift());if(i.length)return t=sexpr(i[0]),this.plists.has(t)&&this.plists.get(t).buried?1:0}return 0}),def("run",function(e){return e=reparse(lexpr(e)),this.execute(e,{returnResult:!0})}),def("runresult",function(e){return e=reparse(lexpr(e)),this.execute(e,{returnResult:!0}).then(function(e){return void 0!==e?[e]:[]})}),def("repeat",function(e,t){e=aexpr(e),t=reparse(lexpr(t));var r=this.repcount,n=1;return promiseFinally(promiseLoop(function(r,i,s){n>e?i():(this.repcount=n++,this.execute(t).then(promiseYield).then(r,s))}.bind(this)),function(){this.repcount=r}.bind(this))}),def("forever",function(e){e=reparse(lexpr(e));var t=this.repcount,r=1;return promiseFinally(promiseLoop(function(t,n,i){this.repcount=r++,this.execute(e).then(promiseYield).then(t,i)}.bind(this)),function(){this.repcount=t}.bind(this))}),def(["repcount","#"],function(){return this.repcount}),def("if",function(e,t){"list"===Type(e)&&(e=evaluateExpression(reparse(e)));var r=arguments[2];return Promise.resolve(e).then(function(e){return e=aexpr(e),t=reparse(lexpr(t)),r?(r=reparse(lexpr(r)),this.execute(e?t:r,{returnResult:!0})):e?this.execute(t,{returnResult:!0}):void 0}.bind(this))},{maximum:3}),def("ifelse",function(e,t,r){return"list"===Type(e)&&(e=evaluateExpression(reparse(e))),Promise.resolve(e).then(function(e){return e=aexpr(e),t=reparse(lexpr(t)),r=reparse(lexpr(r)),this.execute(e?t:r,{returnResult:!0})}.bind(this))}),def("test",function(e){return"list"===Type(e)&&(e=evaluateExpression(reparse(e))),Promise.resolve(e).then(function(e){e=aexpr(e),this.scopes[this.scopes.length-1]._test=e}.bind(this))}),def(["iftrue","ift"],function(e){e=reparse(lexpr(e));var t=this.scopes[this.scopes.length-1]._test;if(void 0===t)throw err("{_PROC_}: Called without TEST",ERRORS.NO_TEST);return t?this.execute(e,{returnResult:!0}):void 0}),def(["iffalse","iff"],function(e){e=reparse(lexpr(e));var t=this.scopes[this.scopes.length-1]._test;if(void 0===t)throw err("{_PROC_}: Called without TEST",ERRORS.NO_TEST);return t?void 0:this.execute(e,{returnResult:!0})}),def("stop",function(){throw new Output}),def(["output","op"],function(e){throw new Output(e)}),this.last_error=void 0,def("catch",function(e,t){return e=sexpr(e).toUpperCase(),t=reparse(lexpr(t)),this.execute(t,{returnResult:!0}).catch(function(t){if(!(t instanceof LogoError)||t.tag!==e)throw t;return this.last_error=t,t.value}.bind(this))},{maximum:2}),def("throw",function(e){e=sexpr(e).toUpperCase();var t=arguments[1],r=new LogoError(e,t);throw r.code=arguments.length>1?ERRORS.USER_GENERATED:ERRORS.THROW_ERROR,r},{maximum:2}),def("error",function(){if(!this.last_error)return[];var e=[this.last_error.code,this.last_error.message,this.last_error.proc,this.last_error.line];return this.last_error=void 0,e}),def("wait",function(e){return promiseYieldTime(Math.ceil(aexpr(e)/60*1e3))}),def("bye",function(){throw new Bye}),def(".maybeoutput",function(e){throw new Output(e)}),def("ignore",function(e){}),def("`",function(e){e=lexpr(e);var t=[];return promiseLoop(function(r,n,i){if(e.length){var s,o=e.shift();","===o&&e.length?("word"===Type(o=e.shift())&&(o=[o]),s=reparse(o),this.execute(s,{returnResult:!0}).then(function(e){t.push(e),r()}).catch(i)):",@"===o&&e.length?("word"===Type(o=e.shift())&&(o=[o]),s=reparse(o),this.execute(s,{returnResult:!0}).then(function(e){t=t.concat(e)}).then(r,i)):"word"===Type(o)&&/^",/.test(o)?(s=reparse(o.substring(2)),this.execute(s,{returnResult:!0}).then(function(e){t.push('"'+("list"===Type(e)?e[0]:e))}).then(r,i)):"word"===Type(o)&&/^:,/.test(o)?(s=reparse(o.substring(2)),this.execute(s,{returnResult:!0}).then(function(e){t.push(":"+("list"===Type(e)?e[0]:e))}).then(r,i)):(t.push(o),r())}else n(t)}.bind(this))}),def("for",function(e,t){function r(e){return e<0?-1:e>0?1:0}e=reparse(lexpr(e)),t=reparse(lexpr(t));var n,i,s,o,u=sexpr(e.shift());return Promise.resolve(evaluateExpression(e)).then(function(t){return o=n=aexpr(t),evaluateExpression(e)}).then(function(t){return i=aexpr(t),e.length?evaluateExpression(e):i<n?-1:1}).then(function(e){s=aexpr(e)}).then(function(){return promiseLoop(function(e,n,a){r(o-i)!==r(s)?(setlocal(u,o),this.execute(t).then(function(){o+=s}).then(promiseYield).then(e,a)):n()}.bind(this))}.bind(this))}),def("dotimes",function(e,t){e=reparse(lexpr(e)),t=reparse(lexpr(t));var r,n=sexpr(e.shift()),i=1;return Promise.resolve(evaluateExpression(e)).then(function(e){r=aexpr(e)}).then(function(){return promiseLoop(function(e,s,o){i>r?s():(setlocal(n,i),this.execute(t).then(function(){++i}).then(promiseYield).then(e,o))}.bind(this))}.bind(this))}),def("do.while",function(e,t){return e=reparse(lexpr(checkevalblock(e))),promiseLoop(function(r,n,i){this.execute(e).then(t).then(function(e){return"list"===Type(e)&&(e=evaluateExpression(reparse(e))),e}).then(function(e){e?promiseYield().then(r):n()},i)}.bind(this))},{noeval:!0}),def("while",function(e,t){return t=reparse(lexpr(checkevalblock(t))),promiseLoop(function(r,n,i){Promise.resolve(e()).then(function(e){return"list"===Type(e)&&(e=evaluateExpression(reparse(e))),e}).then(function(e){e?this.execute(t).then(promiseYield).then(r,i):n()}.bind(this),i)}.bind(this))},{noeval:!0}),def("do.until",function(e,t){return e=reparse(lexpr(checkevalblock(e))),promiseLoop(function(r,n,i){this.execute(e).then(t).then(function(e){return"list"===Type(e)&&(e=evaluateExpression(reparse(e))),e}).then(function(e){e?n():promiseYield().then(r)},i)}.bind(this))},{noeval:!0}),def("until",function(e,t){return t=reparse(lexpr(checkevalblock(t))),promiseLoop(function(r,n,i){Promise.resolve(e()).then(function(e){return"list"===Type(e)&&(e=evaluateExpression(reparse(e))),e}).then(function(e){e?n():this.execute(t).then(promiseYield).then(r,i)}.bind(this),i)}.bind(this))},{noeval:!0}),def("case",function(e,t){t=lexpr(t);for(var r=0;r<t.length;++r){var n=lexpr(t[r]),i=n.shift();if(isKeyword(i,"ELSE"))return evaluateExpression(n);if(lexpr(i).some(function(t){return equal(t,e)}))return evaluateExpression(n)}}),def("cond",function(e){return e=lexpr(e),promiseLoop(function(t,r,n){if(e.length){var i=lexpr(e.shift()),s=i.shift();isKeyword(s,"ELSE")?r(evaluateExpression(i)):evaluateExpression(reparse(lexpr(s))).then(function(e){e?r(evaluateExpression(i)):t()},n)}else r()})}),def("apply",function(e,t){e=sexpr(e);var r=this.routines.get(e);if(!r)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(r.special||r.noeval)throw err("Can't apply {_PROC_} to special {name:U}",{name:e},ERRORS.BAD_INPUT);return r.apply(this,lexpr(t))}),def("invoke",function(e,t){e=sexpr(e);var r=this.routines.get(e);if(!r)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(r.special||r.noeval)throw err("Can't apply {_PROC_} to special {name:U}",{name:e},ERRORS.BAD_INPUT);for(var n=[],i=1;i<arguments.length;++i)n.push(arguments[i]);return r.apply(this,n)},{minimum:1,maximum:-1}),def("foreach",function(e,t){e=sexpr(e);var r=this.routines.get(e);if(!r)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(r.special||r.noeval)throw err("Can't apply {_PROC_} to special {name:U}",{name:e},ERRORS.BAD_INPUT);return t=lexpr(t),promiseLoop(function(e,n,i){t.length?Promise.resolve(r.call(this,t.shift())).then(e,i):n()}.bind(this))}),def("map",function(e,t){e=sexpr(e);var r=this.routines.get(e);if(!r)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(r.special||r.noeval)throw err("Can't apply {_PROC_} to special {name:U}",{name:e},ERRORS.BAD_INPUT);var n=[].slice.call(arguments,1).map(lexpr);if(!n.length)throw err("{_PROC_}: Expected list",ERRORS.BAD_INPUT);var i=[];return promiseLoop(function(e,t,s){if(n[0].length){var o=n.map(function(e){if(!e.length)throw err("{_PROC_}: Expected lists of equal length",ERRORS.BAD_INPUT);return e.shift()});Promise.resolve(r.apply(this,o)).then(function(e){i.push(e)}).then(e,s)}else t(i)}.bind(this))},{maximum:-1}),def("filter",function(e,t){e=sexpr(e);var r=this.routines.get(e);if(!r)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(r.special||r.noeval)throw err("Can't apply {_PROC_} to special {name:U}",{name:e},ERRORS.BAD_INPUT);t=lexpr(t);var n=[];return promiseLoop(function(e,i,s){if(t.length){var o=t.shift();Promise.resolve(r.call(this,o)).then(function(e){e&&n.push(o)}).then(e,s)}else i(n)}.bind(this))}),def("find",function(e,t){e=sexpr(e);var r=this.routines.get(e);if(!r)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(r.special||r.noeval)throw err("Can't apply {_PROC_} to special {name:U}",{name:e},ERRORS.BAD_INPUT);return t=lexpr(t),promiseLoop(function(e,n,i){if(t.length){var s=t.shift();Promise.resolve(r.call(this,s)).then(function(t){t?n(s):e()},i)}else n([])}.bind(this))}),def("reduce",function(e,t){e=sexpr(e),t=lexpr(t);var r=void 0!==arguments[2]?arguments[2]:t.shift(),n=this.routines.get(e);if(!n)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(n.special||n.noeval)throw err("Can't apply {_PROC_} to special {name:U}",{name:e},ERRORS.BAD_INPUT);return promiseLoop(function(e,i,s){t.length?Promise.resolve(n.call(this,r,t.shift())).then(function(e){r=e}).then(e,s):i(r)}.bind(this))},{maximum:3}),def("crossmap",function(e,t){e=sexpr(e);var r=this.routines.get(e);if(!r)throw err("{_PROC_}: Don't know how to {name:U}",{name:e},ERRORS.BAD_PROC);if(r.special||r.noeval)throw err("Can't apply {_PROC_} to special {name:U}",{name:e},ERRORS.BAD_INPUT);var n=[].slice.call(arguments,1).map(lexpr);if(!n.length)throw err("{_PROC_}: Expected list",ERRORS.BAD_INPUT);1===n.length&&(n=n[0].map(lexpr));var i=n.map(function(){return 0}),s=!1,o=[];return promiseLoop(function(e,t,u){if(s)t(o);else{var a=i.map(function(e,t){return n[t][e]}),f=i.length-1;for(++i[f];i[f]===n[f].length;){if(0===f){s=!0;break}i[f]=0,f--,++i[f]}Promise.resolve(r.apply(this,a)).then(function(e){o.push(e)}).then(e,u)}}.bind(this))},{maximum:-1}),def(".promise",function(e){return Promise.resolve(e)}),def(".verify_bound_ignore",function(e){if(void 0===this)throw new Error("Internal error: Unbound procedure")}),def(".verify_bound_identity",function(e){if(void 0===this)throw new Error("Internal error: Unbound procedure");return e})}CanvasRenderingContext2D.prototype.floodFill=function(e,t){var r=this,n=r.canvas,i=n.width,s=n.height,o=[0,-1,1,0],u=[-1,0,0,1];function a(e,t){var n=r.getImageData(e,t,i,s).data;return n[3]<<24|n[0]<<16|n[1]<<8|n[2]}var f=a(e|=0,t|=0);r.fillRect(e,t,1,1);var c=a(e,t);if(f!==c){var h=f>>24&255,p=f>>16&255,l=f>>8&255,d=255&f,m=c>>24&255,x=c>>16&255,g=c>>8&255,v=255&c,_=r.getImageData(0,0,i,s),R=_.data,w=[];for(w.push(e),w.push(t);w.length>0;)for(var y=w.pop(),E=w.pop(),b=0;b<4;b++){var O=E+o[b],T=y+u[b];if(!(O<0||T<0||O>=i||T>=s)){var S=4*(T*i+O);R[S+0]==p&&R[S+1]==l&&R[S+2]==d&&R[S+3]==h&&(R[S++]=x,R[S++]=g,R[S++]=v,R[S]=m,w.push(O),w.push(T))}}r.putImageData(_,0,0)}},Object.defineProperties(CanvasTurtle.prototype,{_init:{value:function(){this.turtle_ctx.lineCap="round",this.turtle_ctx.strokeStyle="green",this.turtle_ctx.lineWidth=2,this.canvas_ctx.lineCap="round",this.color=this.color,this.fontname=this.fontname,this.fontsize=this.fontsize,this.penmode=this.penmode,this.penwidth=this.penwidth,[this.turtle_ctx,this.canvas_ctx].forEach(function(e){e.setTransform(this.sx,0,0,-this.sy,this.width/2,this.height/2)}.bind(this))}},_tick:{value:function(){requestAnimationFrame(this._tick.bind(this));var e=JSON.stringify([this.x,this.y,this.r,this.visible,this.sx,this.sy,this.width,this.height]);if(e!==this._last_state&&(this._last_state=e,this.turtle_ctx.save(),this.turtle_ctx.setTransform(1,0,0,1,0,0),this.turtle_ctx.clearRect(0,0,this.width,this.height),this.turtle_ctx.restore(),this.visible)){var t=this.turtle_ctx;t.save(),t.translate(this.x,this.y),t.rotate(Math.PI/2+this.r),t.beginPath();var r=[[0,-20],[2.5,-17],[3,-12],[6,-10],[9,-13],[13,-12],[18,-4],[18,0],[14,-1],[10,-7],[8,-6],[10,-2],[9,3],[6,10],[9,13],[6,15],[3,12],[0,13]];r.concat(r.slice(1,-1).reverse().map(function(e){return[-e[0],e[1]]})).forEach(function(e,r){t[r?"lineTo":"moveTo"](e[0],e[1])}),t.closePath(),t.stroke(),t.restore()}}},_moveto:{value:function(e,t,r){var n,i,s,o,u,a,f,c=function(e,t,r,n){this.pendown&&(this.filling?(this.canvas_ctx.lineTo(e,t),this.canvas_ctx.lineTo(r,n)):(this.canvas_ctx.beginPath(),this.canvas_ctx.moveTo(e,t),this.canvas_ctx.lineTo(r,n),this.canvas_ctx.stroke()))}.bind(this),h=this.width/this.sx,p=this.height/this.sy,l=-h/2,d=h/2,m=-p/2,x=p/2;if(r&&"wrap"===this.turtlemode){var g=e<l||e>=d||t<m||t>=x,v=e,_=t;if(this.was_oob){var R=mod(e+h/2,h)-(e+h/2),w=mod(t+p/2,p)-(t+p/2);e+=R,t+=w,this.x=this.px+R,this.y=this.py+w}this.was_oob=g,this.px=v,this.py=_}else this.was_oob=!1;for(;;)switch(this.turtlemode){case"window":return c(this.x,this.y,e,t),this.x=this.px=e,void(this.y=this.py=t);default:case"wrap":case"fence":if(u=1,a=1,e<l?u=(this.x-l)/(this.x-e):e>d&&(u=(this.x-d)/(this.x-e)),t<m?a=(this.y-m)/(this.y-t):t>x&&(a=(this.y-x)/(this.y-t)),!isFinite(u)||!isFinite(a))throw console.log("x",e,"left",l,"right",d),console.log("y",t,"bottom",m,"top",x),console.log("fx",u,"fy",a),new Error("Wrapping error: non-finite fraction");if(n=e,i=t,s=e,o=t,u<1&&u<=a?(n=(f=e<l)?l:d,e+=f?h:-h,s=f?d:l,o=i=this.y-u*(this.y-t)):a<1&&a<=u&&(i=(f=t<m)?m:x,t+=f?p:-p,s=n=this.x-a*(this.x-e),o=f?x:m),c(this.x,this.y,n,i),"fence"===this.turtlemode)return this.x=this.px=n,void(this.y=this.py=i);if(this.x=s,this.y=o,u>=1&&a>=1)return}}},_mousemove:{value:function(e,t,r){this._mousex=(e-this.width/2)/this.sx,this._mousey=(t-this.height/2)/-this.sy,this._buttons=r}},_mouseclick:{value:function(e,t,r){this._clickx=(e-this.width/2)/this.sx,this._clicky=(t-this.height/2)/-this.sy,this._buttons=r}},_touch:{value:function(e){this._touches=e.map(function(e){return[(e.x-this.width/2)/this.sx,(e.y-this.height/2)/-this.sy]}.bind(this))}},resize:{value:function(e,t){this.width=e,this.height=t,this._init()}},move:{value:function(e){var t,r,n,i,s;function o(e){var t=Math.pow(10,10);return Math.round(e*t)/t}(n=Math.abs(e)<.001)&&(i=this.x,s=this.y,e=.001),t=o(this.x+e*Math.cos(this.r)),r=o(this.y+e*Math.sin(this.r)),this._moveto(t,r),n&&(this.x=this.px=i,this.y=this.px=s)}},turn:{value:function(e){this.r-=deg2rad(e)}},towards:{value:function(e,t){return e=e,t=t,90-rad2deg(Math.atan2(t-this.y,e-this.x))}},clearscreen:{value:function(){this.home(),this.clear()}},clear:{value:function(){this.canvas_ctx.save();try{this.canvas_ctx.setTransform(1,0,0,1,0,0),this.canvas_ctx.clearRect(0,0,this.width,this.height),this.canvas_ctx.fillStyle=this.bgcolor,this.canvas_ctx.fillRect(0,0,this.width,this.height)}finally{this.canvas_ctx.restore()}}},home:{value:function(){this._moveto(0,0),this.r=deg2rad(90)}},drawtext:{value:function(e){this.canvas_ctx.save(),this.canvas_ctx.translate(this.x,this.y),this.canvas_ctx.scale(1,-1),this.canvas_ctx.rotate(-this.r),this.canvas_ctx.fillText(e,0,0),this.canvas_ctx.restore()}},beginpath:{value:function(){0===this.filling&&(this.saved_turtlemode=this.turtlemode,this.turtlemode="window",++this.filling,this.canvas_ctx.beginPath())}},fillpath:{value:function(e){--this.filling,0===this.filling&&(this.canvas_ctx.closePath(),this.canvas_ctx.fillStyle=e,this.canvas_ctx.fill(),this.canvas_ctx.fillStyle=this.color,this.pendown&&this.canvas_ctx.stroke(),this.turtlemode=this.saved_turtlemode)}},fill:{value:function(){this.canvas_ctx.save(),this.canvas_ctx.setTransform(1,0,0,1,0,0),this.canvas_ctx.floodFill(this.x*this.sx+this.width/2,-this.y*this.sy+this.height/2),this.canvas_ctx.restore()}},arc:{value:function(e,t){"wrap"==this.turtlemode?[this.x,this.x+this.width/this.sx,this.x-this.width/this.sx].forEach(function(r){[this.y,this.y+this.height/this.sy,this.y-this.height/this.sy].forEach(function(n){this.filling||this.canvas_ctx.beginPath(),this.canvas_ctx.arc(r,n,t,this.r,this.r-deg2rad(e),e>0),this.filling||this.canvas_ctx.stroke()}.bind(this))}.bind(this)):(this.filling||this.canvas_ctx.beginPath(),this.canvas_ctx.arc(this.x,this.y,t,this.r,this.r-deg2rad(e),e>0),this.filling||this.canvas_ctx.stroke())}},getstate:{value:function(){return{isturtlestate:!0,color:this.color,bgcolor:this.bgcolor,position:this.position,heading:this.heading,penmode:this.penmode,turtlemode:this.turtlemode,width:this.width,fontsize:this.fontsize,fontname:this.fontname,visible:this.visible,pendown:this.pendown,scrunch:this.scrunch}}},setstate:{value:function(e){if(!e||!e.isturtlestate)throw new Error("Tried to restore a state that is not a turtle state");this.turtlemode=e.turtlemode,this.color=e.color,this.bgcolor=e.bgcolor,this.penwidth=e.penwidth,this.fontsize=e.fontsize,this.fontname=e.fontname,this.position=e.position,this.heading=e.heading,this.penmode=e.penmode,this.scrunch=e.scrunch,this.visible=e.visible,this.pendown=e.pendown}},pendown:{set:function(e){this._down=e},get:function(){return this._down}},penmode:{get:function(){return this._penmode},set:function(e){this._penmode=e,this.canvas_ctx.globalCompositeOperation="erase"===this.penmode?"destination-out":"reverse"===this.penmode?"difference":"source-over",this.canvas_ctx.strokeStyle=this.canvas_ctx.fillStyle="paint"===e?this.color:"#ffffff"}},turtlemode:{set:function(e){this._turtlemode=e},get:function(){return this._turtlemode}},color:{get:function(){return this._color},set:function(e){this._color=e,this.canvas_ctx.strokeStyle=this._color,this.canvas_ctx.fillStyle=this._color}},bgcolor:{get:function(){return this._bgcolor},set:function(e){this._bgcolor=e,this.clear()}},penwidth:{set:function(e){this._penwidth=e,this.canvas_ctx.lineWidth=this._penwidth},get:function(){return this._penwidth}},fontsize:{set:function(e){this._fontsize=e,this.canvas_ctx.font=font(this.fontsize,this.fontname)},get:function(){return this._fontsize}},fontname:{set:function(e){this._fontname=e,this.canvas_ctx.font=font(this.fontsize,this.fontname)},get:function(){return this._fontname}},position:{set:function(e){var t=e[0],r=e[1];this._moveto(t=void 0===t?this.x:t,r=void 0===r?this.y:r,!0)},get:function(){return[this.x,this.y]}},heading:{get:function(){return 90-rad2deg(this.r)},set:function(e){this.r=deg2rad(90-e)}},visible:{set:function(e){this._visible=e},get:function(){return this._visible}},scrunch:{set:function(e){var t=e[0],r=e[1];this.x=this.px=this.x/t*this.sx,this.y=this.py=this.y/r*this.sy,this.sx=t,this.sy=r,[this.turtle_ctx,this.canvas_ctx].forEach(function(e){e.setTransform(this.sx,0,0,-this.sy,this.width/2,this.height/2)}.bind(this))},get:function(){return[this.sx,this.sy]}},mousepos:{get:function(){return[this._mousex,this._mousey]}},clickpos:{get:function(){return[this._clickx,this._clicky]}},button:{get:function(){return this._buttons}},touches:{get:function(){return this._touches}}}),window._attachJsLogo=function(){window.CanvasTurtle=CanvasTurtle,window.LogoInterpreter=LogoInterpreter};export{CanvasTurtle,LogoInterpreter};
//# sourceMappingURL=jslogo.module.js.map
