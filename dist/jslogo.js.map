{"version":3,"file":"jslogo.js","sources":["../turtle.js","../logo.js","../floodfill.js","../bundle.js"],"sourcesContent":["//\n// Turtle Graphics in Javascript\n//\n\n// Copyright (C) 2011 Joshua Bell\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// https://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n\nfunction deg2rad(d) { return d / 180 * Math.PI; }\nfunction rad2deg(r) { return r * 180 / Math.PI; }\n\nfunction font(px, name) {\n  px = Number(px);\n  name = String(name).toLowerCase();\n  if (['serif', 'sans-serif', 'cursive', 'fantasy', 'monospace'].indexOf(name) === -1)\n    name = JSON.stringify(name);\n  return String(px) + 'px ' + name;\n}\n\nfunction mod(a, b) {\n  var r = a % b;\n  return r < 0 ? r + b : r;\n}\n\nexport function CanvasTurtle(canvas_ctx, turtle_ctx, w, h, events) {\n  // Stub for old browsers w/ canvas but no text functions\n  canvas_ctx.fillText = canvas_ctx.fillText || function fillText(string, x, y) { };\n\n  this.canvas_ctx = canvas_ctx;\n  this.turtle_ctx = turtle_ctx;\n  this.width = Number(w);\n  this.height = Number(h);\n\n  this.x = this.py = 0;\n  this.y = this.py = 0;\n  this.r = Math.PI / 2;\n\n  this.sx = this.sy = 1;\n\n  this.color = '#000000';\n  this.bgcolor = '#ffffff';\n  this.penwidth = 1;\n  this.penmode = 'paint';\n  this.fontsize = 14;\n  this.fontname = 'sans-serif';\n  this.turtlemode = 'wrap';\n  this.visible = true;\n  this.pendown = true;\n\n  this.was_oob = false;\n  this.filling = 0;\n\n  this._clickx = this._clicky = 0;\n  this._mousex = this._mousey = 0;\n  this._buttons = 0;\n  this._touches = [];\n\n  this._init();\n  this._tick();\n\n  if (events) {\n    var mouse_handler = function(e) {\n      var rect = events.getBoundingClientRect();\n      this._mousemove(e.clientX - rect.left, e.clientY - rect.top, e.buttons);\n    }.bind(this);\n    ['mousemove', 'mousedown', 'mouseup'].forEach(function(e) {\n      events.addEventListener(e, mouse_handler);\n    });\n\n    var touch_handler = function(e) {\n      var rect = events.getBoundingClientRect();\n      var touches = Array.from(e.touches).map(function(t) {\n        return {x: t.clientX - rect.left, y: t.clientY - rect.top};\n      });\n      this._touch(touches);\n    }.bind(this);\n    ['touchstart', 'touchmove', 'touchend'].forEach(function(e) {\n      events.addEventListener(e, touch_handler);\n    });\n\n  }\n}\n\nObject.defineProperties(CanvasTurtle.prototype, {\n\n  // Internal methods\n\n  _init: {value: function() {\n    this.turtle_ctx.lineCap = 'round';\n    this.turtle_ctx.strokeStyle = 'green';\n    this.turtle_ctx.lineWidth = 2;\n\n    this.canvas_ctx.lineCap = 'round';\n\n    // Restore canvas state controlled by properties:\n    this.color = this.color;\n    this.fontname = this.fontname;\n    this.fontsize = this.fontsize;\n    this.penmode = this.penmode;\n    this.penwidth = this.penwidth;\n\n    [this.turtle_ctx, this.canvas_ctx].forEach(function(ctx) {\n      ctx.setTransform(this.sx, 0, 0, -this.sy, this.width / 2, this.height / 2);\n    }.bind(this));\n  }},\n\n  _tick: {value: function() {\n    function invert(p) { return [-p[0], p[1]]; }\n\n    requestAnimationFrame(this._tick.bind(this));\n    var cur = JSON.stringify([this.x, this.y, this.r, this.visible,\n                              this.sx, this.sy, this.width, this.height]);\n    if (cur === this._last_state) return;\n    this._last_state = cur;\n\n    this.turtle_ctx.save();\n    this.turtle_ctx.setTransform(1, 0, 0, 1, 0, 0);\n    this.turtle_ctx.clearRect(0, 0, this.width, this.height);\n    this.turtle_ctx.restore();\n\n    if (this.visible) {\n      var ctx = this.turtle_ctx;\n      ctx.save();\n      ctx.translate(this.x, this.y);\n      ctx.rotate(Math.PI/2 + this.r);\n      ctx.beginPath();\n\n      var points = [\n        [0, -20], // Head\n        [2.5, -17],\n        [3, -12],\n\n        [6, -10],\n        [9, -13], // Arm\n        [13, -12],\n        [18, -4],\n        [18, 0],\n        [14, -1],\n        [10, -7],\n\n        [8, -6], // Shell\n        [10, -2],\n        [9, 3],\n        [6, 10],\n\n        [9, 13], // Foot\n        [6, 15],\n        [3, 12],\n\n        [0, 13],\n      ];\n\n      points.concat(points.slice(1, -1).reverse().map(invert))\n        .forEach(function(pair, index) {\n          ctx[index ? 'lineTo' : 'moveTo'](pair[0], pair[1]);\n        });\n\n      ctx.closePath();\n      ctx.stroke();\n\n      ctx.restore();\n    }\n  }},\n\n  _moveto: {value: function(x, y, setpos) {\n\n    var _go = function(x1, y1, x2, y2) {\n      if (this.pendown) {\n        if (this.filling) {\n          this.canvas_ctx.lineTo(x1, y1);\n          this.canvas_ctx.lineTo(x2, y2);\n        } else {\n          this.canvas_ctx.beginPath();\n          this.canvas_ctx.moveTo(x1, y1);\n          this.canvas_ctx.lineTo(x2, y2);\n          this.canvas_ctx.stroke();\n        }\n      }\n    }.bind(this);\n\n    var w = this.width / this.sx, h = this.height / this.sy;\n\n    var left = -w / 2, right = w / 2,\n        bottom = -h / 2, top = h / 2;\n\n    var ix, iy, wx, wy, fx, fy, less;\n\n    // Hack to match UCBLogo: don't draw line across viewport on\n    // `SETXY 250 10  SETXY 300 20  SETXY 350 30`\n    if (setpos && this.turtlemode === 'wrap') {\n      var oob = (x < left || x >= right || y < bottom || y >= top);\n      var px = x, py = y;\n      if (this.was_oob) {\n        var dx = mod(x + w / 2, w) - (x + w / 2);\n        var dy = mod(y + h / 2, h) - (y + h / 2);\n        x += dx;\n        y += dy;\n        this.x = this.px + dx;\n        this.y = this.py + dy;\n      }\n      this.was_oob = oob;\n      this.px = px;\n      this.py = py;\n    } else {\n      this.was_oob = false;\n    }\n\n    while (true) {\n      // TODO: What happens if we switch modes and turtle is outside bounds?\n\n      switch (this.turtlemode) {\n      case 'window':\n        _go(this.x, this.y, x, y);\n        this.x = this.px = x;\n        this.y = this.py = y;\n        return;\n\n      default:\n      case 'wrap':\n      case 'fence':\n\n        // fraction before intersecting\n        fx = 1;\n        fy = 1;\n\n        if (x < left) {\n          fx = (this.x - left) / (this.x - x);\n        } else if (x > right) {\n          fx = (this.x - right) / (this.x - x);\n        }\n\n        if (y < bottom) {\n          fy = (this.y - bottom) / (this.y - y);\n        } else if (y > top) {\n          fy = (this.y - top) / (this.y - y);\n        }\n\n        if (!isFinite(fx) || !isFinite(fy)) {\n          console.log('x', x, 'left', left, 'right', right);\n          console.log('y', y, 'bottom', bottom, 'top', top);\n          console.log('fx', fx, 'fy', fy);\n          throw new Error(\"Wrapping error: non-finite fraction\");\n        }\n\n        // intersection point (draw current to here)\n        ix = x;\n        iy = y;\n\n        // endpoint after wrapping (next \"here\")\n        wx = x;\n        wy = y;\n\n        if (fx < 1 && fx <= fy) {\n          less = (x < left);\n          ix = less ? left : right;\n          iy = this.y - fx * (this.y - y);\n          x += less ? w : -w;\n          wx = less ? right : left;\n          wy = iy;\n        } else if (fy < 1 && fy <= fx) {\n          less = (y < bottom);\n          ix = this.x - fy * (this.x - x);\n          iy = less ? bottom : top;\n          y += less ? h : -h;\n          wx = ix;\n          wy = less ? top : bottom;\n        }\n\n        _go(this.x, this.y, ix, iy);\n\n        if (this.turtlemode === 'fence') {\n          // FENCE - stop on collision\n          this.x = this.px = ix;\n          this.y = this.py = iy;\n          return;\n        } else {\n          // WRAP - keep going\n          this.x = wx;\n          this.y = wy;\n          if (fx >= 1 && fy >= 1)\n            return;\n        }\n\n        break;\n      }\n    }\n  }},\n\n  _mousemove: {value: function(x, y, b) {\n    this._mousex = (x - this.width / 2) / this.sx;\n    this._mousey = (y - this.height / 2) / -this.sy;\n    this._buttons = b;\n  }},\n\n  _mouseclick: {value: function(x, y, b) {\n    this._clickx = (x - this.width / 2) / this.sx;\n    this._clicky = (y - this.height / 2) / -this.sy;\n    this._buttons = b;\n  }},\n\n  _touch: {value: function(touches) {\n    this._touches = touches.map(function(touch) {\n      return [\n        (touch.x - this.width / 2) / this.sx,\n        (touch.y - this.height / 2) / -this.sy\n      ];\n    }.bind(this));\n  }},\n\n  // API methods\n\n  resize: {value: function(w, h) {\n    this.width = w;\n    this.height = h;\n    this._init();\n  }},\n\n  move: {value: function(distance) {\n    var x, y, point, saved_x, saved_y, EPSILON = 1e-3;\n\n    point = Math.abs(distance) < EPSILON;\n\n    if (point) {\n      saved_x = this.x;\n      saved_y = this.y;\n      distance = EPSILON;\n    }\n\n    // Mostly for tests: limit precision\n    var PRECISION = 10;\n    function precision(n) {\n      var f = Math.pow(10, PRECISION);\n      return Math.round(n * f) / f;\n    }\n\n    x = precision(this.x + distance * Math.cos(this.r));\n    y = precision(this.y + distance * Math.sin(this.r));\n    this._moveto(x, y);\n\n    if (point) {\n      this.x = this.px = saved_x;\n      this.y = this.px = saved_y;\n    }\n  }},\n\n  turn: {value: function(angle) {\n    this.r -= deg2rad(angle);\n  }},\n\n  towards: {value: function(x, y) {\n    x = x;\n    y = y;\n\n    return 90 - rad2deg(Math.atan2(y - this.y, x - this.x));\n  }},\n\n  clearscreen: {value: function() {\n    this.home();\n    this.clear();\n  }},\n\n  clear: {value: function() {\n    this.canvas_ctx.save();\n    try {\n      this.canvas_ctx.setTransform(1, 0, 0, 1, 0, 0);\n      this.canvas_ctx.clearRect(0, 0, this.width, this.height);\n      this.canvas_ctx.fillStyle = this.bgcolor;\n      this.canvas_ctx.fillRect(0, 0, this.width, this.height);\n    } finally {\n      this.canvas_ctx.restore();\n    }\n  }},\n\n  home: {value: function() {\n    this._moveto(0, 0);\n    this.r = deg2rad(90);\n  }},\n\n  drawtext: {value: function(text) {\n    this.canvas_ctx.save();\n    this.canvas_ctx.translate(this.x, this.y);\n    this.canvas_ctx.scale(1, -1);\n    this.canvas_ctx.rotate(-this.r);\n    this.canvas_ctx.fillText(text, 0, 0);\n    this.canvas_ctx.restore();\n  }},\n\n  beginpath: {value: function() {\n    if (this.filling === 0) {\n      this.saved_turtlemode = this.turtlemode;\n      this.turtlemode = 'window';\n      ++this.filling;\n      this.canvas_ctx.beginPath();\n    }\n  }},\n\n  fillpath: {value: function(fillcolor) {\n    --this.filling;\n    if (this.filling === 0) {\n      this.canvas_ctx.closePath();\n      this.canvas_ctx.fillStyle = fillcolor;\n      this.canvas_ctx.fill();\n      this.canvas_ctx.fillStyle = this.color;\n      if (this.pendown)\n        this.canvas_ctx.stroke();\n      this.turtlemode = this.saved_turtlemode;\n    }\n  }},\n\n  fill: {value: function() {\n    this.canvas_ctx.save();\n    this.canvas_ctx.setTransform(1, 0, 0, 1, 0, 0);\n    this.canvas_ctx.floodFill(this.x*this.sx + this.width/2,\n                              - this.y*this.sy + this.height/2);\n    this.canvas_ctx.restore();\n  }},\n\n  arc: {value: function(angle, radius) {\n    if (this.turtlemode == 'wrap') {\n      [this.x,\n        this.x + this.width / this.sx,\n        this.x - this.width / this.sx].forEach(function(x) {\n          [this.y,\n          this.y + this.height / this.sy,\n          this.y - this.height / this.sy].forEach(function(y) {\n            if (!this.filling)\n              this.canvas_ctx.beginPath();\n            this.canvas_ctx.arc(x, y, radius, this.r, this.r - deg2rad(angle), angle > 0);\n            if (!this.filling)\n              this.canvas_ctx.stroke();\n          }.bind(this));\n        }.bind(this));\n    } else {\n      if (!this.filling)\n        this.canvas_ctx.beginPath();\n      this.canvas_ctx.arc(this.x, this.y, radius, this.r, this.r - deg2rad(angle), angle > 0);\n      if (!this.filling)\n        this.canvas_ctx.stroke();\n    }\n  }},\n\n  getstate: {value: function() {\n    return {\n      isturtlestate: true,\n      color: this.color,\n      bgcolor: this.bgcolor,\n      position: this.position,\n      heading: this.heading,\n      penmode: this.penmode,\n      turtlemode: this.turtlemode,\n      width: this.width,\n      fontsize: this.fontsize,\n      fontname: this.fontname,\n      visible: this.visible,\n      pendown: this.pendown,\n      scrunch: this.scrunch\n    };\n  }},\n\n  setstate: {value: function(state) {\n    if ((! state) || ! state.isturtlestate) {\n      throw new Error(\"Tried to restore a state that is not a turtle state\");\n    }\n    this.turtlemode = state.turtlemode;\n    this.color = state.color;\n    this.bgcolor = state.bgcolor;\n    this.penwidth = state.penwidth;\n    this.fontsize = state.fontsize;\n    this.fontname = state.fontname;\n    this.position = state.position;\n    this.heading = state.heading;\n    this.penmode = state.penmode;\n    this.scrunch = state.scrunch;\n    this.visible = state.visible;\n    this.pendown = state.pendown;\n  }},\n\n  // Properties\n\n  pendown: {\n    set: function(down) { this._down = down; },\n    get: function() { return this._down; }\n  },\n\n  penmode: {\n    get: function() { return this._penmode; },\n    set: function(penmode) {\n      this._penmode = penmode;\n      this.canvas_ctx.globalCompositeOperation =\n        (this.penmode === 'erase') ? 'destination-out' :\n        (this.penmode === 'reverse') ? 'difference' : 'source-over';\n      if (penmode === 'paint')\n        this.canvas_ctx.strokeStyle = this.canvas_ctx.fillStyle = this.color;\n      else\n        this.canvas_ctx.strokeStyle = this.canvas_ctx.fillStyle = '#ffffff';\n    }\n  },\n\n  turtlemode: {\n    set: function(turtlemode) { this._turtlemode = turtlemode; },\n    get: function() { return this._turtlemode; }\n  },\n\n  color: {\n    get: function() { return this._color; },\n    set: function(color) {\n      this._color = color;\n      this.canvas_ctx.strokeStyle = this._color;\n      this.canvas_ctx.fillStyle = this._color;\n    }\n  },\n\n  bgcolor: {\n    get: function() { return this._bgcolor; },\n    set: function(color) {\n      this._bgcolor = color;\n      this.clear();\n    }\n  },\n\n  penwidth: {\n    set: function(width) {\n      this._penwidth = width;\n      this.canvas_ctx.lineWidth = this._penwidth;\n    },\n    get: function() { return this._penwidth; }\n  },\n\n\n  fontsize: {\n    set: function(size) {\n      this._fontsize = size;\n      this.canvas_ctx.font = font(this.fontsize, this.fontname);\n    },\n    get: function() { return this._fontsize; }\n  },\n\n  fontname: {\n    set: function(name) {\n      this._fontname = name;\n      this.canvas_ctx.font = font(this.fontsize, this.fontname);\n    },\n    get: function() { return this._fontname; }\n  },\n\n  position: {\n    set: function(coords) {\n      var x = coords[0], y = coords[1];\n      x = (x === undefined) ? this.x : x;\n      y = (y === undefined) ? this.y : y;\n      this._moveto(x, y, /*setpos*/true);\n    },\n    get: function() {\n      return [this.x, this.y];\n    }\n  },\n\n  heading: {\n    get: function() {\n      return 90 - rad2deg(this.r);\n    },\n    set: function(angle) {\n      this.r = deg2rad(90 - angle);\n    }\n  },\n\n  visible: {\n    set: function(visible) { this._visible = visible; },\n    get: function() { return this._visible; }\n  },\n\n  scrunch: {\n    set: function(sc) {\n      var sx = sc[0], sy = sc[1];\n      this.x = this.px = this.x / sx * this.sx;\n      this.y = this.py = this.y / sy * this.sy;\n\n      this.sx = sx;\n      this.sy = sy;\n\n      [this.turtle_ctx, this.canvas_ctx].forEach(function(ctx) {\n        ctx.setTransform(this.sx, 0, 0, -this.sy, this.width / 2, this.height / 2);\n      }.bind(this));\n    },\n    get: function() {\n      return [this.sx, this.sy];\n    }\n  },\n\n  mousepos: {\n    get: function() { return [this._mousex, this._mousey]; }\n  },\n\n  clickpos: {\n    get: function() { return [this._clickx, this._clicky]; }\n  },\n\n  button: {\n    get: function() { return this._buttons; }\n  },\n\n  touches: {\n    get: function() { return this._touches; }\n  }\n\n});\n\n","//\n// Logo Interpreter in Javascript\n//\n\n// Copyright (C) 2011 Joshua Bell\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// https://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nexport function LogoInterpreter(turtle, stream, savehook)\n{\n  'use strict';\n\n  var self = this;\n\n  var UNARY_MINUS = '<UNARYMINUS>'; // Must not parse as a word\n\n  var ERRORS = {\n    BAD_INPUT: 4,\n    NO_OUTPUT: 5,\n    NOT_ENOUGH_INPUTS: 6,\n    TOO_MANY_INPUTS: 8,\n    BAD_OUTPUT: 9,\n    MISSING_PAREN: 10,\n    BAD_VAR: 11,\n    BAD_PAREN: 12,\n    ALREADY_DEFINED: 15,\n    THROW_ERROR: 21,\n    IS_PRIMITIVE: 22,\n    BAD_PROC: 24,\n    NO_TEST: 25,\n    BAD_BRACKET: 26,\n    BAD_BRACE: 27,\n    USER_GENERATED: 35,\n    MISSING_SPACE: 39\n  };\n\n  function saveproc(name, def) {\n    if (savehook)\n      savehook(String(name).toLowerCase(), def);\n  }\n\n  //----------------------------------------------------------------------\n  //\n  // Utilities\n  //\n  //----------------------------------------------------------------------\n\n  function format(string, params) {\n    return string.replace(/{(\\w+)(:[UL])?}/g, function(m, n, o) {\n      var s = (n === '_PROC_') ? self.stack[self.stack.length - 1] : String(params[n]);\n      switch (o) {\n        case ':U': return s.toUpperCase();\n        case ':L': return s.toLowerCase();\n        default: return s;\n      }\n    });\n  }\n\n  // To support localized/customized messages, assign a lookup function:\n  // instance.localize = function(s) {\n  //   return {\n  //     'Division by zero': 'Divido per nulo',\n  //     'Index out of bounds': 'Indekso ekster limojn',\n  //     ...\n  //   }[s];\n  // };\n  this.localize = null;\n  function __(string) {\n    if (self.localize)\n      return self.localize(string) || string;\n    return string;\n  }\n\n  // Shortcut for common use of format() and __()\n  function err(string, params, code) {\n    // Allow callng as err(string, code)\n    if (typeof params === 'number') {\n      code = params;\n      params = undefined;\n    }\n    var error = new LogoError('ERROR', undefined, format(__(string), params));\n    if (code !== undefined)\n      error.code = code;\n    return error;\n  }\n\n  function LogoError(tag, value, message) {\n    this.name = 'LogoError';\n    this.message = message || format(__('No CATCH for tag {tag}'), {tag: tag});\n    this.tag = tag;\n    this.value = value;\n    this.proc = self.stack[self.stack.length - 1];\n    this.code = -1; // TODO: Support code.\n    this.line = -1; // TODO: Support line.\n  }\n\n  // To handle additional keyword aliases (localizations, etc), assign\n  // a function to keywordAlias. Input will be the uppercased word,\n  // output must be one of the keywords (ELSE or END), or undefined.\n  // For example:\n  // logo.keywordAlias = function(name) {\n  //   return {\n  //     'ALIE': 'ELSE',\n  //     'FINO': 'END'\n  //     ...\n  //   }[name];\n  // };\n  this.keywordAlias = null;\n  function isKeyword(atom, match) {\n    if (Type(atom) !== 'word')\n      return false;\n    atom = String(atom).toUpperCase();\n    if (self.keywordAlias)\n      atom = self.keywordAlias(atom) || atom;\n    return atom === match;\n  }\n\n  // Returns a promise; calls the passed function with (loop, resolve,\n  // reject). Calling resolve or reject (or throwing) settles the\n  // promise, calling loop repeats.\n  function promiseLoop(func) {\n    return new Promise(function(resolve, reject) {\n      (function loop() {\n        try {\n          func(loop, resolve, reject);\n        } catch (e) {\n          reject(e);\n        }\n      }());\n    });\n  }\n\n  // Takes a list of (possibly async) closures. Each is called in\n  // turn, waiting for its result to resolve before the next is\n  // executed. Resolves to an array of results, or rejects if any\n  // closure rejects.\n  function serialExecute(funcs) {\n    var results = [];\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!funcs.length) {\n        resolve(results);\n        return;\n      }\n      Promise.resolve(funcs.shift()())\n        .then(function(result) {\n          results.push(result);\n          loop();\n        }, reject);\n    });\n  }\n\n  // Returns a promise with the same result as the passed promise, but\n  // that executes finalBlock before it resolves, regardless of\n  // whether it fulfills or rejects.\n  function promiseFinally(promise, finalBlock) {\n    return promise\n      .then(function(result) {\n        return Promise.resolve(finalBlock())\n          .then(function() {\n            return result;\n          });\n      }, function(err) {\n        return Promise.resolve(finalBlock())\n          .then(function() {\n            throw err;\n          });\n      });\n  }\n\n  // Returns a Promise that will resolve as soon as possible while ensuring\n  // that control is yielded back to the event loop at least every 20ms.\n  var lastTimeYielded = Date.now();\n  function promiseYield() {\n    var currentTime = Date.now();\n    if (currentTime - lastTimeYielded > 20) {\n      lastTimeYielded = currentTime;\n      return new Promise(function(resolve) {\n        setTimeout(resolve, 0);\n      });\n    } else {\n      return Promise.resolve();\n    }\n  }\n\n  function promiseYieldTime(msec) {\n    // Not adding msec would generally cause a yield right after the wait.\n    // Adding msec just once might cause additional tear of animations.\n    lastTimeYielded = Date.now() + msec * 2;\n    return new Promise(function(resolve) {\n      setTimeout(resolve, msec);\n    });\n  }\n\n  // Based on: https://www.jbouchard.net/chris/blog/2008/01/currying-in-javascript-fun-for-whole.html\n  // Argument is `$$func$$` to avoid issue if passed function is named `func`.\n  function to_arity($$func$$, arity) {\n    var parms = [];\n\n    if ($$func$$.length === arity)\n      return $$func$$;\n\n    for (var i = 0; i < arity; ++i)\n      parms.push('a' + i);\n\n    var f = eval('(function ' + $$func$$.name + '(' + parms.join(',') + ')' +\n                 '{ return $$func$$.apply(this, arguments); })');\n    return f;\n  }\n\n\n  //----------------------------------------------------------------------\n  //\n  // Classes\n  //\n  //----------------------------------------------------------------------\n\n  // Adapted from:\n  // https://stackoverflow.com/questions/424292/how-to-create-my-own-javascript-random-number-generator-that-i-can-also-set-the-s\n  function PRNG(seed) {\n    var S = seed & 0x7fffffff, // seed\n        A = 48271, // const\n        M = 0x7fffffff, // const\n        Q = M / A, // const\n        R = M % A; // const\n\n    this.next = function PRNG_next() {\n      var hi = S / Q,\n          lo = S % Q,\n          t = A * lo - R * hi;\n      S = (t > 0) ? t : t + M;\n      this.last = S / M;\n      return this.last;\n    };\n    this.seed = function PRNG_seed(x) {\n      S = x & 0x7fffffff;\n    };\n    this.next();\n  }\n\n  function StringMap(case_fold) {\n    this._map = new Map();\n    this._case_fold = case_fold;\n  }\n  Object.defineProperties(StringMap.prototype, {\n    get: {value: function(key) {\n      key = this._case_fold ? String(key).toLowerCase() : String(key);\n      return this._map.get(key);\n    }},\n    set: {value: function(key, value) {\n      key = this._case_fold ? String(key).toLowerCase() : String(key);\n      this._map.set(key, value);\n    }},\n    has: {value: function(key) {\n      key = this._case_fold ? String(key).toLowerCase() : String(key);\n      return this._map.has(key);\n    }},\n    delete: {value: function(key) {\n      key = this._case_fold ? String(key).toLowerCase() : String(key);\n      return this._map.delete(key);\n    }},\n    keys: {value: function() {\n      var keys = [];\n      this._map.forEach(function(value, key) { keys.push(key); });\n      return keys;\n    }},\n    empty: {value: function() {\n      return this._map.size === 0;\n    }},\n    forEach: {value: function(fn) {\n      return this._map.forEach(function(value, key) {\n        fn(key, value);\n      });\n    }}\n  });\n\n  function LogoArray(size, origin) {\n    this._array = [];\n    this._array.length = size;\n    for (var i = 0; i < this._array.length; ++i)\n      this._array[i] = [];\n    this._origin = origin;\n  }\n  LogoArray.from = function(list, origin) {\n    var array = new LogoArray(0, origin);\n    array._array = Array.from(list);\n    return array;\n  };\n  Object.defineProperties(LogoArray.prototype, {\n    item: {value: function(i) {\n      i = Number(i)|0;\n      i -= this._origin;\n      if (i < 0 || i >= this._array.length)\n        throw err(\"{_PROC_}: Index out of bounds\", ERRORS.BAD_INPUT);\n      return this._array[i];\n    }},\n    setItem: {value: function(i, v) {\n      i = Number(i)|0;\n      i -= this._origin;\n      if (i < 0 || i >= this._array.length)\n        throw err(\"{_PROC_}: Index out of bounds\", ERRORS.BAD_INPUT);\n      this._array[i] = v;\n    }},\n    list: {get: function() {\n      return this._array;\n    }},\n    origin: {get: function() {\n      return this._origin;\n    }},\n    length: {get: function() {\n      return this._array.length;\n    }}\n  });\n\n  function Stream(string) {\n    this._string = string;\n    this._index = 0;\n    this._skip();\n  }\n  Object.defineProperties(Stream.prototype, {\n    eof: {get: function() {\n      return this._index >= this._string.length;\n    }},\n    peek: {value: function() {\n      var c = this._string.charAt(this._index);\n      if (c === '\\\\')\n        c += this._string.charAt(this._index + 1);\n      return c;\n    }},\n    get: {value: function() {\n      var c = this._next();\n      this._skip();\n      return c;\n    }},\n    _next: {value: function() {\n      var c = this._string.charAt(this._index++);\n      if (c === '\\\\')\n        c += this._string.charAt(this._index++);\n      return c;\n    }},\n    _skip: {value: function() {\n      while (!this.eof) {\n        var c = this.peek();\n        if (c === '~' && this._string.charAt(this._index + 1) === '\\n') {\n          this._index += 2;\n        } else if (c === ';') {\n          do {\n            c = this._next();\n          } while (!this.eof && this.peek() !== '\\n');\n          if (c === '~')\n            this._next();\n        } else {\n          return;\n        }\n      }\n    }},\n    rest: {get: function() {\n      return this._string.substring(this._index);\n    }}\n  });\n\n  //----------------------------------------------------------------------\n  //\n  // Interpreter State\n  //\n  //----------------------------------------------------------------------\n\n  self.turtle = turtle;\n  self.stream = stream;\n  self.routines = new StringMap(true);\n  self.scopes = [new StringMap(true)];\n  self.plists = new StringMap(true);\n  self.prng = new PRNG(Math.random() * 0x7fffffff);\n  self.forceBye = false;\n\n  //----------------------------------------------------------------------\n  //\n  // Parsing\n  //\n  //----------------------------------------------------------------------\n\n  // Used to return values from routines (thrown/caught)\n  function Output(output) { this.output = output; }\n  Output.prototype.toString = function() { return this.output; };\n  Output.prototype.valueOf = function() { return this.output; };\n\n  // Used to stop processing cleanly\n  function Bye() { }\n\n  function Type(atom) {\n    if (atom === undefined) {\n      // TODO: Should be caught higher upstream than this\n      throw err(\"No output from procedure\", ERRORS.NO_OUTPUT);\n    } else if (typeof atom === 'string' || typeof atom === 'number') {\n      return 'word';\n    } else if (Array.isArray(atom)) {\n      return 'list';\n    } else if (atom instanceof LogoArray) {\n      return 'array';\n    } else if ('then' in Object(atom)) {\n      throw new Error(\"Internal error: Unexpected value: a promise\");\n    } else if (!atom) {\n      throw new Error(\"Internal error: Unexpected value: null\");\n    } else {\n      throw new Error(\"Internal error: Unexpected value: unknown type\");\n    }\n  }\n\n\n  //\n  // Tokenize into atoms / lists\n  //\n  // Input: string\n  // Output: atom list (e.g. \"to\", \"jump\", \"repeat\", \"random\", 10, [ \"fd\", \"10\", \"rt\", \"10\" ], \"end\"\n  //\n\n  function parse(string) {\n    if (string === undefined) {\n      return undefined; // TODO: Replace this with ...?\n    }\n\n    var atoms = [],\n        prev, r;\n\n    var stream = new Stream(string);\n    while (stream.peek()) {\n      var atom;\n\n      // Ignore (but track) leading space - needed for unary minus disambiguation\n      var leading_space = isWS(stream.peek());\n      while (isWS(stream.peek()))\n        stream.get();\n      if (!stream.peek())\n        break;\n\n      if (stream.peek() === '[') {\n        stream.get();\n        atom = parseList(stream);\n      } else if (stream.peek() === ']') {\n        throw err(\"Unexpected ']'\", ERRORS.BAD_BRACKET);\n      } else if (stream.peek() === '{') {\n        stream.get();\n        atom = parseArray(stream);\n      } else if (stream.peek() === '}') {\n        throw err(\"Unexpected '}'\", ERRORS.BAD_BRACE);\n      } else if (stream.peek() === '\"') {\n        atom = parseQuoted(stream);\n      } else if (isOwnWord(stream.peek())) {\n        atom = stream.get();\n      } else if (inRange(stream.peek(), '0', '9')) {\n        atom = parseNumber(stream);\n      } else if (inChars(stream.peek(), OPERATOR_CHARS)) {\n        atom = parseOperator(stream);\n        // From UCB Logo:\n\n        // Minus sign means infix difference in ambiguous contexts\n        // (when preceded by a complete expression), unless it is\n        // preceded by a space and followed by a nonspace.\n\n        // Minus sign means unary minus if the previous token is an\n        // infix operator or open parenthesis, or it is preceded by a\n        // space and followed by a nonspace.\n\n        if (atom === '-') {\n          var trailing_space = isWS(stream.peek());\n          if (prev === undefined ||\n              (Type(prev) === 'word' && isInfix(prev)) ||\n              (Type(prev) === 'word' && prev === '(') ||\n              (leading_space && !trailing_space)) {\n            atom = UNARY_MINUS;\n          }\n        }\n      } else if (!inChars(stream.peek(), WORD_DELIMITER)) {\n        atom = parseWord(stream);\n      } else {\n        // NOTE: This shouldn't be reachable.\n        throw err(\"Couldn't parse: '{string}'\", { string: stream.rest });\n      }\n      atoms.push(atom);\n      prev = atom;\n    }\n\n    return atoms;\n  }\n\n  function inRange(x, a, b) {\n    return a <= x && x <= b;\n  }\n\n  function inChars(x, chars) {\n    return x && chars.indexOf(x) !== -1;\n  }\n\n  var WS_CHARS = ' \\f\\n\\r\\t\\v';\n  function isWS(c) {\n    return inChars(c, WS_CHARS);\n  }\n\n  // \"After a quotation mark outside square brackets, a word is\n  // delimited by a space, a square bracket, or a parenthesis.\"\n  var QUOTED_DELIMITER = WS_CHARS + '[](){}';\n  function parseQuoted(stream) {\n    var word = '';\n    while (!stream.eof && QUOTED_DELIMITER.indexOf(stream.peek()) === -1) {\n      var c = stream.get();\n      word += (c.charAt(0) === '\\\\') ? c.charAt(1) : c.charAt(0);\n    }\n    return word;\n  }\n\n  // Non-standard: U+2190 ... U+2193 are arrows, parsed as own-words.\n  var OWNWORD_CHARS = '\\u2190\\u2191\\u2192\\u2193';\n  function isOwnWord(c) {\n    return inChars(c, OWNWORD_CHARS);\n  }\n\n  // \"A word not after a quotation mark or inside square brackets is\n  // delimited by a space, a bracket, a parenthesis, or an infix\n  // operator +-*/=<>. Note that words following colons are in this\n  // category. Note that quote and colon are not delimiters.\"\n  var WORD_DELIMITER = WS_CHARS + '[](){}+-*/%^=<>';\n  function parseWord(stream) {\n    var word = '';\n    while (!stream.eof && WORD_DELIMITER.indexOf(stream.peek()) === -1) {\n      var c = stream.get();\n      word += (c.charAt(0) === '\\\\') ? c.charAt(1) : c.charAt(0);\n    }\n    return word;\n  }\n\n  // \"Each infix operator character is a word in itself, except that\n  // the two-character sequences <=, >=, and <> (the latter meaning\n  // not-equal) with no intervening space are recognized as a single\n  // word.\"\n  var OPERATOR_CHARS = '+-*/%^=<>[]{}()';\n  function parseOperator(stream) {\n    var word = '';\n    if (inChars(stream.peek(), OPERATOR_CHARS))\n      word += stream.get();\n    if ((word === '<' && stream.peek() === '=') ||\n        (word === '>' && stream.peek() === '=') ||\n        (word === '<' && stream.peek() === '>')) {\n      word += stream.get();\n    }\n    return word;\n  }\n\n  function isInfix(word) {\n    return ['+', '-', '*', '/', '%', '^', '=', '<', '>', '<=', '>=', '<>']\n      .includes(word);\n  }\n\n  function isOperator(word) {\n    return isInfix(word) || ['[', ']', '{', '}', '(', ')'].includes(word);\n  }\n\n  // Non-standard: Numbers support exponential notation (e.g. 1.23e-45)\n  function parseNumber(stream) {\n    var word = '';\n    while (inRange(stream.peek(), '0', '9'))\n      word += stream.get();\n    if (stream.peek() === '.')\n      word += stream.get();\n    if (inRange(stream.peek(), '0', '9')) {\n      while (inRange(stream.peek(), '0', '9'))\n        word += stream.get();\n    }\n    if (stream.peek() === 'E' || stream.peek() === 'e') {\n      word += stream.get();\n      if (stream.peek() === '-' || stream.peek() === '+')\n        word += stream.get();\n      while (inRange(stream.peek(), '0', '9'))\n        word += stream.get();\n    }\n    return word;\n  }\n\n  // Includes leading - sign, unlike parseNumber().\n  function isNumber(s) {\n    return String(s).match(/^-?([0-9]*\\.?[0-9]+(?:[eE][\\-+]?[0-9]+)?)$/);\n  }\n\n  function parseInteger(stream) {\n    var word = '';\n    if (stream.peek() === '-')\n      word += stream.get();\n    while (inRange(stream.peek(), '0', '9'))\n      word += stream.get();\n    return word;\n  }\n\n  function parseList(stream) {\n    var list = [],\n        atom = '',\n        c, r;\n\n    while (true) {\n      do {\n        c = stream.get();\n      } while (isWS(c));\n\n      while (c && !isWS(c) && '[]{}'.indexOf(c) === -1) {\n        atom += c;\n        c = stream.get();\n      }\n\n      if (atom.length) {\n        list.push(atom);\n        atom = '';\n      }\n\n      if (!c)\n        throw err(\"Expected ']'\", ERRORS.BAD_BRACKET);\n      if (isWS(c))\n        continue;\n      if (c === ']')\n        return list;\n      if (c === '[') {\n        list.push(parseList(stream));\n        continue;\n      }\n      if (c === '{') {\n        list.push(parseArray(stream));\n        continue;\n      }\n      if (c === '}')\n        throw err(\"Unexpected '}'\", ERRORS.BAD_BRACE);\n      throw err(\"Unexpected '{c}'\", {c: c});\n    }\n  }\n\n  function parseArray(stream) {\n    var list = [],\n        origin = 1,\n        atom = '',\n        c, r;\n\n    while (true) {\n      do {\n        c = stream.get();\n      } while (isWS(c));\n\n      while (c && !isWS(c) && '[]{}'.indexOf(c) === -1) {\n        atom += c;\n        c = stream.get();\n      }\n\n      if (atom.length) {\n        list.push(atom);\n        atom = '';\n      }\n\n      if (!c)\n        throw err(\"Expected '}'\", ERRORS.BAD_BRACE);\n      if (isWS(c))\n        continue;\n      if (c === '}') {\n        while (isWS(stream.peek()))\n          stream.get();\n        if (stream.peek() === '@') {\n          stream.get();\n          while (isWS(stream.peek()))\n            stream.get();\n          origin = Number(parseInteger(stream) || 0);\n        }\n        return LogoArray.from(list, origin);\n      }\n      if (c === '[') {\n        list.push(parseList(stream));\n        continue;\n      }\n      if (c === ']')\n        throw err(\"Unexpected ']'\", ERRORS.BAD_BRACKET);\n      if (c === '{') {\n        list.push(parseArray(stream));\n        continue;\n      }\n      throw err(\"Unexpected '{c}'\", {c: c});\n    }\n  }\n\n  function reparse(list) {\n    return parse(stringify_nodecorate(list).replace(/([\\\\;])/g, '\\\\$1'));\n  }\n\n  function maybegetvar(name) {\n    var lval = lvalue(name);\n    return lval ? lval.value : undefined;\n  }\n\n  function getvar(name) {\n    var value = maybegetvar(name);\n    if (value !== undefined)\n      return value;\n    throw err(\"Don't know about variable {name:U}\", {name: name}, ERRORS.BAD_VAR);\n  }\n\n  function lvalue(name) {\n    for (var i = self.scopes.length - 1; i >= 0; --i) {\n      if (self.scopes[i].has(name)) {\n        return self.scopes[i].get(name);\n      }\n    }\n    return undefined;\n  }\n\n  function setvar(name, value) {\n    value = copy(value);\n\n    // Find the variable in existing scope\n    var lval = lvalue(name);\n    if (lval) {\n      lval.value = value;\n    } else {\n      // Otherwise, define a global\n      lval = {value: value};\n      self.scopes[0].set(name, lval);\n    }\n  }\n\n  function local(name) {\n    var scope = self.scopes[self.scopes.length - 1];\n    scope.set(sexpr(name), {value: undefined});\n  }\n\n  function setlocal(name, value) {\n    value = copy(value);\n    var scope = self.scopes[self.scopes.length - 1];\n    scope.set(sexpr(name), {value: value});\n  }\n\n  //----------------------------------------------------------------------\n  //\n  // Expression Evaluation\n  //\n  //----------------------------------------------------------------------\n\n  // Expression               := RelationalExpression\n  // RelationalExpression     := AdditiveExpression [ ( '=' | '<' | '>' | '<=' | '>=' | '<>' ) AdditiveExpression ... ]\n  // AdditiveExpression       := MultiplicativeExpression [ ( '+' | '-' ) MultiplicativeExpression ... ]\n  // MultiplicativeExpression := PowerExpression [ ( '*' | '/' | '%' ) PowerExpression ... ]\n  // PowerExpression          := UnaryExpression [ '^' UnaryExpression ]\n  // UnaryExpression          := ( '-' ) UnaryExpression\n  //                           | FinalExpression\n  // FinalExpression          := string-literal\n  //                           | number-literal\n  //                           | list\n  //                           | variable-reference\n  //                           | procedure-call\n  //                           | '(' Expression ')'\n\n  // Peek at the list to see if there are additional atoms from a set\n  // of options.\n  function peek(list, options) {\n    if (list.length < 1) { return false; }\n    var next = list[0];\n    return options.some(function(x) { return next === x; });\n\n  }\n\n  function evaluateExpression(list) {\n    return (expression(list))();\n  }\n\n  function expression(list) {\n    return relationalExpression(list);\n  }\n\n  function relationalExpression(list) {\n    var lhs = additiveExpression(list);\n    var op;\n    while (peek(list, ['=', '<', '>', '<=', '>=', '<>'])) {\n      op = list.shift();\n\n      lhs = function(lhs) {\n        var rhs = additiveExpression(list);\n\n        switch (op) {\n          case \"<\": return defer(function(lhs, rhs) { return (aexpr(lhs) < aexpr(rhs)) ? 1 : 0; }, lhs, rhs);\n          case \">\": return defer(function(lhs, rhs) { return (aexpr(lhs) > aexpr(rhs)) ? 1 : 0; }, lhs, rhs);\n          case \"=\": return defer(function(lhs, rhs) { return equal(lhs, rhs) ? 1 : 0; }, lhs, rhs);\n\n          case \"<=\": return defer(function(lhs, rhs) { return (aexpr(lhs) <= aexpr(rhs)) ? 1 : 0; }, lhs, rhs);\n          case \">=\": return defer(function(lhs, rhs) { return (aexpr(lhs) >= aexpr(rhs)) ? 1 : 0; }, lhs, rhs);\n          case \"<>\": return defer(function(lhs, rhs) { return !equal(lhs, rhs) ? 1 : 0; }, lhs, rhs);\n          default: throw new Error(\"Internal error in expression parser\");\n        }\n      } (lhs);\n    }\n\n    return lhs;\n  }\n\n\n  // Takes a function and list of (possibly async) closures. Returns a\n  // closure that, when executed, evaluates the closures serially then\n  // applies the function to the results.\n  function defer(func /*, input...*/) {\n    var input = [].slice.call(arguments, 1);\n    return function() {\n      return serialExecute(input.slice())\n        .then(function(args) {\n          return func.apply(null, args);\n        });\n    };\n  }\n\n  function additiveExpression(list) {\n    var lhs = multiplicativeExpression(list);\n    var op;\n    while (peek(list, ['+', '-'])) {\n      op = list.shift();\n\n      lhs = function(lhs) {\n        var rhs = multiplicativeExpression(list);\n        switch (op) {\n          case \"+\": return defer(function(lhs, rhs) { return aexpr(lhs) + aexpr(rhs); }, lhs, rhs);\n          case \"-\": return defer(function(lhs, rhs) { return aexpr(lhs) - aexpr(rhs); }, lhs, rhs);\n          default: throw new Error(\"Internal error in expression parser\");\n        }\n      } (lhs);\n    }\n\n    return lhs;\n  }\n\n  function multiplicativeExpression(list) {\n    var lhs = powerExpression(list);\n    var op;\n    while (peek(list, ['*', '/', '%'])) {\n      op = list.shift();\n\n      lhs = function(lhs) {\n        var rhs = powerExpression(list);\n        switch (op) {\n          case \"*\": return defer(function(lhs, rhs) { return aexpr(lhs) * aexpr(rhs); }, lhs, rhs);\n          case \"/\": return defer(function(lhs, rhs) {\n            var n = aexpr(lhs), d = aexpr(rhs);\n            if (d === 0) { throw err(\"Division by zero\", ERRORS.BAD_INPUT); }\n            return n / d;\n          }, lhs, rhs);\n          case \"%\": return defer(function(lhs, rhs) {\n            var n = aexpr(lhs), d = aexpr(rhs);\n            if (d === 0) { throw err(\"Division by zero\", ERRORS.BAD_INPUT); }\n            return n % d;\n          }, lhs, rhs);\n          default: throw new Error(\"Internal error in expression parser\");\n        }\n      } (lhs);\n    }\n\n    return lhs;\n  }\n\n  function powerExpression(list) {\n    var lhs = unaryExpression(list);\n    var op;\n    while (peek(list, ['^'])) {\n      op = list.shift();\n      lhs = function(lhs) {\n        var rhs = unaryExpression(list);\n        return defer(function(lhs, rhs) { return Math.pow(aexpr(lhs), aexpr(rhs)); }, lhs, rhs);\n      } (lhs);\n    }\n\n    return lhs;\n  }\n\n  function unaryExpression(list) {\n    var rhs, op;\n\n    if (peek(list, [UNARY_MINUS])) {\n      op = list.shift();\n      rhs = unaryExpression(list);\n      return defer(function(rhs) { return -aexpr(rhs); }, rhs);\n    } else {\n      return finalExpression(list);\n    }\n  }\n\n  function finalExpression(list) {\n    if (!list.length)\n      throw err(\"Unexpected end of instructions\", ERRORS.MISSING_PAREN);\n\n    var atom = list.shift();\n\n    var result, literal, varname;\n\n    switch (Type(atom)) {\n    case 'array':\n    case 'list':\n      return function() { return atom; };\n\n    case 'word':\n      if (isNumber(atom)) {\n        // number literal\n        atom = parseFloat(atom);\n        return function() { return atom; };\n      }\n\n      atom = String(atom);\n      if (atom.charAt(0) === '\"' || atom.charAt(0) === \"'\") {\n        // string literal\n        literal = atom.substring(1);\n        return function() { return literal; };\n      }\n      if (atom.charAt(0) === ':') {\n        // variable\n        varname = atom.substring(1);\n        return function() { return getvar(varname); };\n      }\n      if (atom === '(') {\n        // parenthesized expression/procedure call\n        if (list.length && Type(list[0]) === 'word' && self.routines.has(String(list[0])) &&\n            !(list.length > 1 && Type(list[1]) === 'word' && isInfix(String(list[1])))) {\n          // Lisp-style (procedure input ...) calling syntax\n          atom = list.shift();\n          return self.dispatch(atom, list, false);\n        }\n        // Standard parenthesized expression\n        result = expression(list);\n\n        if (!list.length)\n          throw err(\"Expected ')'\", ERRORS.MISSING_PAREN);\n        if (!peek(list, [')']))\n          throw err(\"Expected ')', saw {word}\", { word: list.shift() }, ERRORS.MISSING_PAREN);\n        list.shift();\n        return result;\n      }\n      if (atom === ')')\n        throw err(\"Unexpected ')'\", ERRORS.BAD_PAREN);\n      // Procedure dispatch\n      return self.dispatch(atom, list, true);\n\n    default: throw new Error(\"Internal error in expression parser\");\n    }\n  }\n\n  self.stack = [];\n\n  self.dispatch = function(name, tokenlist, natural) {\n    name = name.toUpperCase();\n    var procedure = self.routines.get(name);\n    if (!procedure) {\n\n      // Give a helpful message in a common error case.\n      var m;\n      if ((m = /^(\\w+?)(\\d+)$/.exec(name)) && self.routines.get(m[1])) {\n        throw err(\"Need a space between {name:U} and {value}\",\n                  { name: m[1], value: m[2] }, ERRORS.MISSING_SPACE);\n      }\n\n      throw err(\"Don't know how to {name:U}\", { name: name }, ERRORS.BAD_PROC);\n    }\n\n    if (procedure.special) {\n      // Special routines are built-ins that get handed the token list:\n      // * workspace modifiers like TO that special-case varnames\n      self.stack.push(name);\n      try {\n        procedure.call(self, tokenlist);\n        return function() { };\n      } finally {\n        self.stack.pop();\n      }\n    }\n\n    var args = [];\n    if (natural) {\n      // Natural arity of the function\n      for (var i = 0; i < procedure.default; ++i) {\n        args.push(expression(tokenlist));\n      }\n    } else {\n      // Caller specified argument count\n      while (tokenlist.length && !peek(tokenlist, [')'])) {\n        args.push(expression(tokenlist));\n      }\n      tokenlist.shift(); // Consume ')'\n\n      if (args.length < procedure.minimum)\n        throw err(\"Not enough inputs for {name:U}\", {name: name}, ERRORS.NOT_ENOUGH_INPUTS);\n      if (procedure.maximum !== -1 && args.length > procedure.maximum)\n        throw err(\"Too many inputs for {name:U}\", {name: name}, ERRORS.TOO_MANY_INPUTS);\n    }\n\n    if (procedure.noeval) {\n      return function() {\n        self.stack.push(name);\n        return promiseFinally(procedure.apply(self, args),\n                              function() { self.stack.pop(); });\n      };\n    }\n\n    return function() {\n      self.stack.push(name);\n      return promiseFinally(serialExecute(args.slice()).then(function(args) {\n        return procedure.apply(self, args);\n      }), function() { self.stack.pop(); });\n    };\n  };\n\n  //----------------------------------------------------------------------\n  // Arithmetic expression convenience function\n  //----------------------------------------------------------------------\n  function aexpr(atom) {\n    if (atom === undefined) {\n      throw err(\"Expected number\", ERRORS.BAD_INPUT);\n    }\n    switch (Type(atom)) {\n    case 'word':\n      if (isNumber(atom))\n        return parseFloat(atom);\n      break;\n    }\n    throw err(\"Expected number\", ERRORS.BAD_INPUT);\n  }\n\n  //----------------------------------------------------------------------\n  // String expression convenience function\n  //----------------------------------------------------------------------\n  function sexpr(atom) {\n    if (atom === undefined) throw err(\"Expected string\", ERRORS.BAD_INPUT);\n    if (atom === UNARY_MINUS) return '-';\n    if (Type(atom) === 'word') return String(atom);\n\n    throw new err(\"Expected string\", ERRORS.BAD_INPUT);\n  }\n\n  //----------------------------------------------------------------------\n  // List expression convenience function\n  //----------------------------------------------------------------------\n\n  // 'list expression'\n  // Takes an atom - if it is a list is is returned unchanged. If it\n  // is a word a list of the characters is returned. If the procedure\n  // returns a list, the output type should match the input type, so\n  // use sifw().\n  function lexpr(atom) {\n    if (atom === undefined)\n      throw err(\"{_PROC_}: Expected list\", ERRORS.BAD_INPUT);\n    switch (Type(atom)) {\n    case 'word':\n      return Array.from(String(atom));\n    case 'list':\n      return copy(atom);\n    }\n\n    throw err(\"{_PROC_}: Expected list\", ERRORS.BAD_INPUT);\n  }\n\n  // 'stringify if word'\n  // Takes an atom which is to be the subject of lexpr() and a result\n  // list. If the atom is a word, returns a word, otherwise a list.\n  function sifw(atom, list) {\n    return (Type(atom) === 'word') ? list.join('') : list;\n  }\n\n  //----------------------------------------------------------------------\n  // Returns a deep copy of a value (word or list). Arrays are copied\n  // by reference.\n  //----------------------------------------------------------------------\n  function copy(value) {\n    switch (Type(value)) {\n    case 'list': return value.map(copy);\n    default: return value;\n    }\n  }\n\n  //----------------------------------------------------------------------\n  // Deep compare of values (numbers, strings, lists)\n  //----------------------------------------------------------------------\n  function equal(a, b) {\n    if (Type(a) !== Type(b)) return false;\n    switch (Type(a)) {\n    case 'word':\n      if (typeof a === 'number' || typeof b === 'number')\n        return Number(a) === Number(b);\n      else\n        return String(a) === String(b);\n    case 'list':\n      if (a.length !== b.length)\n        return false;\n      for (var i = 0; i < a.length; ++i) {\n        if (!equal(a[i], b[i]))\n          return false;\n      }\n      return true;\n    case 'array':\n      return a === b;\n    }\n    return undefined;\n  }\n\n  //----------------------------------------------------------------------\n  //\n  // Execute a script\n  //\n  //----------------------------------------------------------------------\n\n  //----------------------------------------------------------------------\n  // Execute a sequence of statements\n  //----------------------------------------------------------------------\n  self.execute = function(statements, options) {\n    options = Object(options);\n    // Operate on a copy so the original is not destroyed\n    statements = statements.slice();\n\n    var lastResult;\n    return promiseLoop(function(loop, resolve, reject) {\n      if (self.forceBye) {\n        self.forceBye = false;\n        reject(new Bye);\n        return;\n      }\n      if (!statements.length) {\n        resolve(lastResult);\n        return;\n      }\n      Promise.resolve(evaluateExpression(statements))\n        .then(function(result) {\n          if (result !== undefined && !options.returnResult) {\n            reject(err(\"Don't know what to do with {result}\", {result: result},\n                  ERRORS.BAD_OUTPUT));\n            return;\n          }\n          lastResult = result;\n          loop();\n        }, reject);\n    });\n  };\n\n  // FIXME: should this confirm that something is running?\n  self.bye = function() {\n    self.forceBye = true;\n  };\n\n  var lastRun = Promise.resolve();\n\n  // Call to insert an arbitrary task (callback) to be run in sequence\n  // with pending calls to run. Useful in tests to do work just before\n  // a subsequent assertion.\n  self.queueTask = function(task) {\n    var promise = lastRun.then(function() {\n      return Promise.resolve(task());\n    });\n    lastRun = promise.catch(function(){});\n    return promise;\n  };\n\n  self.run = function(string, options) {\n    options = Object(options);\n    return self.queueTask(function() {\n      // Parse it\n      var atoms = parse(string);\n\n      // And execute it!\n      return self.execute(atoms, options)\n        .catch(function(err) {\n          if (!(err instanceof Bye))\n            throw err;\n        });\n    });\n  };\n\n  self.definition = function(name, proc) {\n\n    function defn(atom) {\n      switch (Type(atom)) {\n      case 'word': return String(atom);\n      case 'list': return '[ ' + atom.map(defn).join(' ') + ' ]';\n      case 'array': return '{ ' + atom.list.map(defn).join(' ') + ' }' +\n          (atom.origin === 1 ? '' : '@' + atom.origin);\n      default: throw new Error(\"Internal error: unknown type\");\n      }\n    }\n\n    var def = \"to \" + name;\n\n    def += proc.inputs.map(function(i) {\n      return ' :' + i;\n    }).join('');\n    def += proc.optional_inputs.map(function(op) {\n      return ' [:' + op[0] + ' ' + op[1].map(defn).join(' ') + ']';;\n    }).join('');\n    if (proc.rest)\n      def += ' [:' + proc.rest + ']';\n    if (proc.def !== undefined)\n      def += ' ' + proc.def;\n\n    def += \"\\n\";\n    def += \"  \" + proc.block.map(defn).join(\" \").replace(new RegExp(UNARY_MINUS + ' ', 'g'), '-');\n    def += \"\\n\" + \"end\";\n\n    return def;\n  };\n\n  // API to allow pages to persist definitions\n  self.procdefs = function() {\n    var defs = [];\n    self.routines.forEach(function(name, proc) {\n      if (!proc.primitive) {\n        defs.push(self.definition(name, proc));\n      }\n    });\n    return defs.join(\"\\n\\n\");\n  };\n\n  // API to allow aliasing. Can be used for localization. Does not\n  // check for errors.\n  self.copydef = function(newname, oldname) {\n    self.routines.set(newname, self.routines.get(oldname));\n  };\n\n  //----------------------------------------------------------------------\n  //\n  // Built-In Proceedures\n  //\n  //----------------------------------------------------------------------\n\n  // Basic form:\n  //\n  //  def(\"procname\", function(input1, input2, ...) { ... return output; });\n  //   * inputs are JavaScript strings, numbers, or Arrays\n  //   * output is string, number, Array or undefined/no output\n  //\n  // Special forms:\n  //\n  //  def(\"procname\", function(tokenlist) { ... }, {special: true});\n  //   * input is Array (list) of tokens (words, numbers, Arrays)\n  //   * used for implementation of special forms (e.g. TO inputs... statements... END)\n  //\n  //  def(\"procname\", function(fin, fin, ...) { ... return op; }, {noeval: true});\n  //   * inputs are arity-0 functions that evaluate to string, number Array\n  //   * used for short-circuiting evaluation (AND, OR)\n  //   * used for repeat evaluation (DO.WHILE, WHILE, DO.UNTIL, UNTIL)\n  //\n\n  function stringify(thing) {\n    switch (Type(thing)) {\n    case 'list':\n      return \"[\" + thing.map(stringify).join(\" \") + \"]\";\n    case 'array':\n      return \"{\" + thing.list.map(stringify).join(\" \") + \"}\" +\n        (thing.origin === 1 ? '' : '@' + thing.origin);\n    default:\n      return sexpr(thing);\n    }\n  }\n\n  function stringify_nodecorate(thing) {\n    switch (Type(thing)) {\n    case 'list':\n      return thing.map(stringify).join(\" \");\n    case 'array':\n      return thing.list.map(stringify).join(\" \");\n    default:\n      return sexpr(thing);\n    }\n  }\n\n  function def(name, fn, props) {\n    fn.minimum = fn.default = fn.maximum = fn.length;\n    if (props) {\n      Object.keys(props).forEach(function(key) {\n        fn[key] = props[key];\n      });\n    }\n    fn.primitive = true;\n    if (Array.isArray(name)) {\n      name.forEach(function(name) {\n        self.routines.set(name, fn);\n      });\n    } else {\n      self.routines.set(name, fn);\n    }\n  }\n\n  //\n  // Procedures and Flow Control\n  //\n  def(\"to\", function(list) {\n    var name = sexpr(list.shift());\n    if (isNumber(name) || isOperator(name))\n      throw err(\"TO: Expected identifier\", ERRORS.BAD_INPUT);\n\n    var inputs = []; // [var, ...]\n    var optional_inputs = []; // [[var, [expr...]], ...]\n    var rest = undefined; // undefined or var\n    var length = undefined; // undefined or number\n    var block = [];\n\n    // Process inputs, then the statements of the block\n    var REQUIRED = 0, OPTIONAL = 1, REST = 2, DEFAULT = 3, BLOCK = 4;\n    var state = REQUIRED, sawEnd = false;\n    while (list.length) {\n      var atom = list.shift();\n      if (isKeyword(atom, 'END')) {\n        sawEnd = true;\n        break;\n      }\n\n      if (state === REQUIRED) {\n        if (Type(atom) === 'word' && String(atom).charAt(0) === ':') {\n          inputs.push(atom.substring(1));\n          continue;\n        }\n        state = OPTIONAL;\n      }\n\n      if (state === OPTIONAL) {\n        if (Type(atom) === 'list' && atom.length > 1 &&\n            String(atom[0]).charAt(0) === ':') {\n          optional_inputs.push([atom.shift().substring(1), atom]);\n          continue;\n        }\n        state = REST;\n      }\n\n      if (state === REST) {\n        state = DEFAULT;\n        if (Type(atom) === 'list' && atom.length === 1 &&\n            String(atom[0]).charAt(0) === ':') {\n          rest = atom[0].substring(1);\n          continue;\n        }\n      }\n\n      if (state === DEFAULT) {\n        state = BLOCK;\n        if (Type(atom) === 'word' && isNumber(atom)) {\n          length = parseFloat(atom);\n          continue;\n        }\n      }\n\n      block.push(atom);\n    }\n    if (!sawEnd)\n      throw err(\"TO: Expected END\", ERRORS.BAD_INPUT);\n\n    defineProc(name, inputs, optional_inputs, rest, length, block);\n  }, {special: true});\n\n  function defineProc(name, inputs, optional_inputs, rest, def, block) {\n    if (self.routines.has(name) && self.routines.get(name).primitive)\n      throw err(\"{_PROC_}: Can't redefine primitive {name:U}\", { name: name },\n                ERRORS.IS_PRIMITIVE);\n\n    if (def !== undefined &&\n        (def < inputs.length || (!rest && def > inputs.length + optional_inputs.length))) {\n      throw err(\"{_PROC_}: Bad default number of inputs for {name:U}\", {name: name},\n               ERRORS.BAD_INPUT);\n    }\n\n    var length = (def === undefined) ? inputs.length : def;\n\n    // Closure over inputs and block to handle scopes, arguments and outputs\n    var func = function() {\n      // Define a new scope\n      var scope = new StringMap(true);\n      self.scopes.push(scope);\n\n      var i = 0, op;\n      for (; i < inputs.length && i < arguments.length; ++i)\n        scope.set(inputs[i], {value: arguments[i]});\n      for (; i < inputs.length + optional_inputs.length && i < arguments.length; ++i) {\n        op = optional_inputs[i - inputs.length];\n        scope.set(op[0], {value: arguments[i]});\n      }\n      for (; i < inputs.length + optional_inputs.length; ++i) {\n        op = optional_inputs[i - inputs.length];\n        scope.set(op[0], {value: evaluateExpression(reparse(op[1]))});\n      }\n      if (rest)\n        scope.set(rest, {value: [].slice.call(arguments, i)});\n\n      return promiseFinally(self.execute(block).then(promiseYield, function(err) {\n        if (err instanceof Output)\n          return err.output;\n        throw err;\n      }), function() {\n        self.scopes.pop();\n      });\n    };\n\n    var proc = to_arity(func, length);\n    self.routines.set(name, proc);\n\n    // For DEF de-serialization\n    proc.inputs = inputs;\n    proc.optional_inputs = optional_inputs;\n    proc.rest = rest;\n    proc.def = def;\n    proc.block = block;\n\n    proc.minimum = inputs.length;\n    proc.default = length;\n    proc.maximum = rest ? -1 : inputs.length + optional_inputs.length;\n\n    saveproc(name, self.definition(name, proc));\n  }\n\n\n  def(\"def\", function(list) {\n\n    var name = sexpr(list);\n    var proc = this.routines.get(name);\n    if (!proc)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: name }, ERRORS.BAD_PROC);\n    if (!proc.inputs) {\n      throw err(\"{_PROC_}: Can't show definition of primitive {name:U}\", { name: name },\n               ERRORS.IS_PRIMITIVE);\n    }\n\n    return this.definition(name, proc);\n  });\n\n\n  //----------------------------------------------------------------------\n  //\n  // 2. Data Structure Primitives\n  //\n  //----------------------------------------------------------------------\n\n  //\n  // 2.1 Constructors\n  //\n\n  def(\"word\", function(word1, word2) {\n    return arguments.length ?\n      Array.from(arguments).map(sexpr).reduce(function(a, b) { return a + b; }) : \"\";\n  }, {minimum: 0, maximum: -1});\n\n  def(\"list\", function(thing1, thing2) {\n    return Array.from(arguments).map(function(x) { return x; }); // Make a copy\n  }, {minimum: 0, maximum: -1});\n\n  def([\"sentence\", \"se\"], function(thing1, thing2) {\n    var list = [];\n    for (var i = 0; i < arguments.length; ++i) {\n      var thing = arguments[i];\n      if (Type(thing) === 'list') {\n        thing = lexpr(thing);\n        list = list.concat(thing);\n      } else {\n        list.push(thing);\n      }\n    }\n    return list;\n  }, {minimum: 0, maximum: -1});\n\n  def(\"fput\", function(thing, list) {\n    var l = lexpr(list);\n    l.unshift(thing);\n    return sifw(list, l);\n  });\n\n  def(\"lput\", function(thing, list) {\n    var l = lexpr(list);\n    l.push(thing);\n    return sifw(list, l);\n  });\n\n  def(\"array\", function(size) {\n    size = aexpr(size);\n    if (size < 1)\n      throw err(\"{_PROC_}: Array size must be positive integer\", ERRORS.BAD_INPUT);\n    var origin = (arguments.length < 2) ? 1 : aexpr(arguments[1]);\n    return new LogoArray(size, origin);\n  }, {maximum: 2});\n\n  def(\"mdarray\", function(sizes) {\n    sizes = lexpr(sizes).map(aexpr).map(function(n) { return n|0; });\n    if (sizes.some(function(size) { return size < 1; }))\n      throw err(\"{_PROC_}: Array size must be positive integer\", ERRORS.BAD_INPUT);\n    var origin = (arguments.length < 2) ? 1 : aexpr(arguments[1]);\n\n    function make(index) {\n      var n = sizes[index], a = new LogoArray(n, origin);\n      if (index + 1 < sizes.length) {\n        for (var i = 0; i < n; ++i)\n          a.setItem(i + origin, make(index + 1));\n      }\n      return a;\n    }\n\n    return make(0);\n  }, {maximum: 2});\n\n  def(\"listtoarray\", function(list) {\n    list = lexpr(list);\n    var origin = 1;\n    if (arguments.length > 1)\n      origin = aexpr(arguments[1]);\n    return LogoArray.from(list, origin);\n  }, {maximum: 2});\n\n  def(\"arraytolist\", function(array) {\n    if (Type(array) !== 'array') {\n      throw err(\"{_PROC_}: Expected array\", ERRORS.BAD_INPUT);\n    }\n    return array.list.slice();\n  });\n\n  def(\"combine\", function(thing1, thing2) {\n    if (Type(thing2) !== 'list') {\n      return this.routines.get('word')(thing1, thing2);\n    } else {\n      return this.routines.get('fput')(thing1, thing2);\n    }\n  });\n\n  def(\"reverse\", function(list) {\n    var tail = (arguments.length > 1) ? arguments[1] : (Type(list) === 'list' ? [] : '');\n    return sifw(tail, lexpr(list).reverse().concat(lexpr(tail)));\n  }, {maximum: 2});\n\n  this.gensym_index = 0;\n  def(\"gensym\", function() {\n    ++this.gensym_index;\n    return 'G' + this.gensym_index;\n  });\n\n  //\n  // 2.2 Data Selectors\n  //\n\n  def(\"first\", function(list) { return lexpr(list)[0]; });\n\n  def(\"firsts\", function(list) {\n    return lexpr(list).map(function(x) { return x[0]; });\n  });\n\n  def(\"last\", function(list) { list = lexpr(list); return list[list.length - 1]; });\n\n  def([\"butfirst\", \"bf\"], function(list) {\n    return sifw(list, lexpr(list).slice(1));\n  });\n\n  def([\"butfirsts\", \"bfs\"], function(list) {\n    return lexpr(list).map(function(x) { return sifw(x, lexpr(x).slice(1)); });\n  });\n\n  def([\"butlast\", \"bl\"], function(list) {\n    return Type(list) === 'word' ? String(list).slice(0, -1) : lexpr(list).slice(0, -1);\n  });\n\n  function item(index, thing) {\n    switch (Type(thing)) {\n    case 'list':\n      if (index < 1 || index > thing.length)\n        throw err(\"{_PROC_}: Index out of bounds\", ERRORS.BAD_INPUT);\n      return thing[index - 1];\n    case 'array':\n      return thing.item(index);\n    default:\n      thing = sexpr(thing);\n      if (index < 1 || index > thing.length)\n        throw err(\"{_PROC_}: Index out of bounds\", ERRORS.BAD_INPUT);\n      return thing.charAt(index - 1);\n    }\n  }\n\n  def(\"item\", function(index, thing) {\n    index = aexpr(index)|0;\n    return item(index, thing);\n  });\n\n  def(\"mditem\", function(indexes, thing) {\n    indexes = lexpr(indexes).map(aexpr).map(function(n) { return n|0; });\n    while (indexes.length)\n      thing = item(indexes.shift(), thing);\n    return thing;\n  });\n\n  def(\"pick\", function(list) {\n    list = lexpr(list);\n    var i = Math.floor(this.prng.next() * list.length);\n    return list[i];\n  });\n\n  def(\"remove\", function(thing, list) {\n    return sifw(list, lexpr(list).filter(function(x) { return !equal(x, thing); }));\n  });\n\n  def(\"remdup\", function(list) {\n    // TODO: This only works with JS equality. Use equalp.\n    var set = new Set();\n    return sifw(list, lexpr(list).filter(function(x) {\n      if (set.has(x)) { return false; } else { set.add(x); return true; }\n    }));\n  });\n\n  def(\"split\", function(thing, list) {\n    var l = lexpr(list);\n    return lexpr(list)\n      .reduce(function(ls, i) {\n        return (equal(i, thing) ? ls.push([]) : ls[ls.length - 1].push(i), ls);\n      }, [[]])\n      .filter(function(l) { return l.length > 0; })\n      .map(function(e) { return sifw(list, e); });\n  });\n\n  def(\"quoted\", function(thing) {\n    if (Type(thing) === 'word')\n      return '\"' + thing;\n    return thing;\n  });\n\n\n  //\n  // 2.3 Data Mutators\n  //\n\n  function contains(atom, value) {\n    if (atom === value) return true;\n    switch (Type(atom)) {\n    case 'list':\n      return atom.some(function(a) { return contains(a, value); });\n    case 'array':\n      return atom.list.some(function(a) { return contains(a, value); });\n    default:\n      return false;\n    }\n  }\n\n  def(\"setitem\", function(index, array, value) {\n    index = aexpr(index);\n    if (Type(array) !== 'array')\n      throw err(\"{_PROC_}: Expected array\", ERRORS.BAD_INPUT);\n    if (contains(value, array))\n      throw err(\"{_PROC_}: Can't create circular array\", ERRORS.BAD_INPUT);\n    array.setItem(index, value);\n  });\n\n  def(\"mdsetitem\", function(indexes, thing, value) {\n    indexes = lexpr(indexes).map(aexpr).map(function(n) { return n|0; });\n    if (Type(thing) !== 'array')\n      throw err(\"{_PROC_}: Expected array\", ERRORS.BAD_INPUT);\n    if (contains(value, thing))\n      throw err(\"{_PROC_}: Can't create circular array\", ERRORS.BAD_INPUT);\n    while (indexes.length > 1) {\n      thing = item(indexes.shift(), thing);\n      if (Type(thing) !== 'array')\n        throw err(\"{_PROC_}: Expected array\", ERRORS.BAD_INPUT);\n    }\n    thing.setItem(indexes.shift(), value);\n  });\n\n  def(\".setfirst\", function(list, value) {\n     if (Type(list) !== 'list')\n      throw err(\"{_PROC_}: Expected list\", ERRORS.BAD_INPUT);\n    list[0] = value;\n  });\n\n  def(\".setbf\", function(list, value) {\n    if (Type(list) !== 'list')\n      throw err(\"{_PROC_}: Expected non-empty list\", ERRORS.BAD_INPUT);\n    if (list.length < 1)\n      throw err(\"{_PROC_}: Expected non-empty list\", ERRORS.BAD_INPUT);\n    value = lexpr(value);\n    list.length = 1;\n    list.push.apply(list, value);\n  });\n\n  def(\".setitem\", function(index, array, value) {\n    index = aexpr(index);\n    if (Type(array) !== 'array')\n      throw err(\"{_PROC_}: Expected array\", ERRORS.BAD_INPUT);\n    array.setItem(index, value);\n  });\n\n  def(\"push\", function(stackname, thing) {\n    var got = getvar(stackname);\n    var stack = lexpr(got);\n    stack.unshift(thing);\n    setvar(stackname, sifw(got, stack));\n  });\n\n  def(\"pop\", function(stackname) {\n    var got = getvar(stackname);\n    var stack = lexpr(got);\n    var atom = stack.shift();\n    setvar(stackname, sifw(got, stack));\n    return atom;\n  });\n\n  def(\"queue\", function(stackname, thing) {\n    var got = getvar(stackname);\n    var queue = lexpr(got);\n    queue.push(thing);\n    setvar(stackname, sifw(got, queue));\n  });\n\n  def(\"dequeue\", function(stackname) {\n    var got = getvar(stackname);\n    var queue = lexpr(got);\n    var atom = queue.pop();\n    setvar(stackname, sifw(got, queue));\n    return atom;\n  });\n\n\n  //\n  // 2.4 Predicates\n  //\n\n  def([\"wordp\", \"word?\"], function(thing) { return Type(thing) === 'word' ? 1 : 0; });\n  def([\"listp\", \"list?\"], function(thing) { return Type(thing) === 'list' ? 1 : 0; });\n  def([\"arrayp\", \"array?\"], function(thing) { return Type(thing) === 'array' ? 1 : 0; });\n  def([\"numberp\", \"number?\"], function(thing) {\n    return Type(thing) === 'word' && isNumber(thing) ? 1 : 0;\n  });\n  def([\"numberwang\"], function(thing) { return this.prng.next() < 0.5 ? 1 : 0; });\n\n  def([\"equalp\", \"equal?\"], function(a, b) { return equal(a, b) ? 1 : 0; });\n  def([\"notequalp\", \"notequal?\"], function(a, b) { return !equal(a, b) ? 1 : 0; });\n\n  def([\"emptyp\", \"empty?\"], function(thing) {\n    switch (Type(thing)) {\n    case 'word': return String(thing).length === 0 ? 1 : 0;\n    case 'list': return thing.length === 0 ? 1 : 0;\n    default: return 0;\n    }\n  });\n  def([\"beforep\", \"before?\"], function(word1, word2) {\n    return sexpr(word1) < sexpr(word2) ? 1 : 0;\n  });\n\n  def(\".eq\", function(a, b) { return a === b && a && typeof a === 'object'; });\n\n  // Not Supported: vbarredp\n\n  def([\"memberp\", \"member?\"], function(thing, list) {\n    return lexpr(list).some(function(x) { return equal(x, thing); }) ? 1 : 0;\n  });\n\n\n  def([\"substringp\", \"substring?\"], function(word1, word2) {\n    return sexpr(word2).indexOf(sexpr(word1)) !== -1 ? 1 : 0;\n  });\n\n  //\n  // 2.5 Queries\n  //\n\n  def(\"count\", function(thing) {\n    if (Type(thing) === 'array')\n      return thing.length;\n    return lexpr(thing).length;\n  });\n  def(\"ascii\", function(chr) { return sexpr(chr).charCodeAt(0); });\n  // Not Supported: rawascii\n  def(\"char\", function(integer) { return String.fromCharCode(aexpr(integer)); });\n\n  def(\"member\", function(thing, input) {\n    var list = lexpr(input);\n    var index = list.findIndex(function(x) { return equal(x, thing); });\n    list = (index === -1) ? [] : list.slice(index);\n    return sifw(input, list);\n });\n\n  def(\"lowercase\", function(word) { return sexpr(word).toLowerCase(); });\n  def(\"uppercase\", function(word) { return sexpr(word).toUpperCase(); });\n\n  def(\"standout\", function(word) {\n    // Hack: Convert English alphanumerics to Mathematical Bold\n    return sexpr(word)\n      .split('')\n      .map(function(c) {\n        var u = c.charCodeAt(0);\n        if ('A' <= c && c <= 'Z') {\n          u = u - 0x41 + 0x1D400;\n        } else if ('a' <= c && c <= 'z') {\n          u = u - 0x61 + 0x1D41A;\n        } else if ('0' <= c && c <= '9') {\n          u = u - 0x30 + 0x1D7CE;\n        } else {\n          return c;\n        }\n        var lead = ((u - 0x10000) >> 10) + 0xD800;\n        var trail = ((u - 0x10000) & 0x3FF) + 0xDC00;\n        return String.fromCharCode(lead, trail);\n      })\n      .join('');\n  });\n\n  def(\"parse\", function(word) {\n    return parse('[' + sexpr(word) + ']')[0];\n  });\n\n  def(\"runparse\", function(word) {\n    return parse(sexpr(word));\n  });\n\n  //----------------------------------------------------------------------\n  //\n  // 3. Communication\n  //\n  //----------------------------------------------------------------------\n\n  // 3.1 Transmitters\n\n  def([\"print\", \"pr\"], function(thing) {\n    var s = Array.from(arguments).map(stringify_nodecorate).join(\" \");\n    return this.stream.write(s, \"\\n\");\n  }, {minimum: 0, maximum: -1});\n  def(\"type\", function(thing) {\n    var s = Array.from(arguments).map(stringify_nodecorate).join(\"\");\n    return this.stream.write(s);\n  }, {minimum: 0, maximum: -1});\n  def(\"show\", function(thing) {\n    var s = Array.from(arguments).map(stringify).join(\" \");\n    return this.stream.write(s, \"\\n\");\n  }, {minimum: 0, maximum: -1});\n\n  // 3.2 Receivers\n\n  def(\"readlist\", function() {\n    return (\n      (arguments.length > 0)\n        ? stream.read(stringify_nodecorate(arguments[0]))\n        : stream.read()\n    ).then(function(word) {\n      return parse('[' + word + ']')[0];\n    });\n  }, {maximum: 1});\n\n  def(\"readword\", function() {\n    if (arguments.length > 0)\n      return stream.read(stringify_nodecorate(arguments[0]));\n    else\n      return stream.read();\n  }, {maximum: 1});\n\n\n  // Not Supported: readrawline\n  // Not Supported: readchar\n  // Not Supported: readchars\n  // Not Supported: shell\n\n  // 3.3 File Access\n\n  // Not Supported: setprefix\n  // Not Supported: prefix\n  // Not Supported: openread\n  // Not Supported: openwrite\n  // Not Supported: openappend\n  // Not Supported: openupdate\n  // Not Supported: close\n  // Not Supported: allopen\n  // Not Supported: closeall\n  // Not Supported: erasefile\n  // Not Supported: dribble\n  // Not Supported: nodribble\n  // Not Supported: setread\n  // Not Supported: setwrite\n  // Not Supported: reader\n  // Not Supported: writer\n  // Not Supported: setreadpos\n  // Not Supported: setwritepos\n  // Not Supported: readpos\n  // Not Supported: writepos\n  // Not Supported: eofp\n  // Not Supported: filep\n\n  // 3.4 Terminal Access\n\n  // Not Supported: keyp\n\n  def([\"cleartext\", \"ct\"], function() {\n    return this.stream.clear();\n  });\n\n  // Not Supported: setcursor\n  // Not Supported: cursor\n  // Not Supported: setmargins\n\n  def('settextcolor', function(color) {\n    this.stream.color = parseColor(color);\n  });\n\n  def('textcolor', function() {\n    return this.stream.color;\n  });\n\n  def('increasefont', function() {\n    this.stream.textsize = Math.round(this.stream.textsize * 1.25);\n  });\n\n  def('decreasefont', function() {\n    this.stream.textsize = Math.round(this.stream.textsize / 1.25);\n  });\n\n  def('settextsize', function(size) {\n    this.stream.textsize = aexpr(size);\n  });\n\n  def('textsize', function() {\n    return this.stream.textsize;\n  });\n\n  def('setfont', function(size) {\n    this.stream.font = sexpr(size);\n  });\n\n  def('font', function() {\n    return this.stream.font;\n  });\n\n\n  //----------------------------------------------------------------------\n  //\n  // 4. Arithmetic\n  //\n  //----------------------------------------------------------------------\n  // 4.1 Numeric Operations\n\n\n  def(\"sum\", function(a, b) {\n    return Array.from(arguments).map(aexpr).reduce(function(a, b) { return a + b; }, 0);\n  }, {minimum: 0, maximum: -1});\n\n  def(\"difference\", function(a, b) {\n    return aexpr(a) - aexpr(b);\n  });\n\n  def(\"minus\", function(a) { return -aexpr(a); });\n\n  def(\"product\", function(a, b) {\n    return Array.from(arguments).map(aexpr).reduce(function(a, b) { return a * b; }, 1);\n  }, {minimum: 0, maximum: -1});\n\n  def(\"quotient\", function(a, b) {\n    if (b !== undefined)\n      return aexpr(a) / aexpr(b);\n    else\n      return 1 / aexpr(a);\n  }, {minimum: 1});\n\n  def(\"remainder\", function(num1, num2) {\n    return aexpr(num1) % aexpr(num2);\n  });\n  def(\"modulo\", function(num1, num2) {\n    num1 = aexpr(num1);\n    num2 = aexpr(num2);\n    return Math.abs(num1 % num2) * (num2 < 0 ? -1 : 1);\n  });\n\n  def(\"power\", function(a, b) { return Math.pow(aexpr(a), aexpr(b)); });\n  def(\"sqrt\", function(a) { return Math.sqrt(aexpr(a)); });\n  def(\"exp\", function(a) { return Math.exp(aexpr(a)); });\n  def(\"log10\", function(a) { return Math.log(aexpr(a)) / Math.LN10; });\n  def(\"ln\", function(a) { return Math.log(aexpr(a)); });\n\n\n  function deg2rad(d) { return d / 180 * Math.PI; }\n  function rad2deg(r) { return r * 180 / Math.PI; }\n\n  def(\"arctan\", function(a) {\n    if (arguments.length > 1) {\n      var x = aexpr(arguments[0]);\n      var y = aexpr(arguments[1]);\n      return rad2deg(Math.atan2(y, x));\n    } else {\n      return rad2deg(Math.atan(aexpr(a)));\n    }\n  }, {maximum: 2});\n\n  def(\"sin\", function(a) { return Math.sin(deg2rad(aexpr(a))); });\n  def(\"cos\", function(a) { return Math.cos(deg2rad(aexpr(a))); });\n  def(\"tan\", function(a) { return Math.tan(deg2rad(aexpr(a))); });\n\n  def(\"radarctan\", function(a) {\n    if (arguments.length > 1) {\n      var x = aexpr(arguments[0]);\n      var y = aexpr(arguments[1]);\n      return Math.atan2(y, x);\n    } else {\n      return Math.atan(aexpr(a));\n    }\n  }, {maximum: 2});\n\n  def(\"radsin\", function(a) { return Math.sin(aexpr(a)); });\n  def(\"radcos\", function(a) { return Math.cos(aexpr(a)); });\n  def(\"radtan\", function(a) { return Math.tan(aexpr(a)); });\n\n  def(\"abs\", function(a) { return Math.abs(aexpr(a)); });\n\n\n  function truncate(x) { return parseInt(x, 10); }\n\n  def(\"int\", function(a) { return truncate(aexpr(a)); });\n  def(\"round\", function(a) { return Math.round(aexpr(a)); });\n\n  def(\"iseq\", function(a, b) {\n    a = truncate(aexpr(a));\n    b = truncate(aexpr(b));\n    var step = (a < b) ? 1 : -1;\n    var list = [];\n    for (var i = a; (step > 0) ? (i <= b) : (i >= b); i += step) {\n      list.push(i);\n    }\n    return list;\n  });\n\n\n  def(\"rseq\", function(from, to, count) {\n    from = aexpr(from);\n    to = aexpr(to);\n    count = truncate(aexpr(count));\n    var step = (to - from) / (count - 1);\n    var list = [];\n    for (var i = from; (step > 0) ? (i <= to) : (i >= to); i += step) {\n      list.push(i);\n    }\n    return list;\n  });\n\n  // 4.2 Numeric Predicates\n\n  def([\"greaterp\", \"greater?\"], function(a, b) { return aexpr(a) > aexpr(b) ? 1 : 0; });\n  def([\"greaterequalp\", \"greaterequal?\"], function(a, b) { return aexpr(a) >= aexpr(b) ? 1 : 0; });\n  def([\"lessp\", \"less?\"], function(a, b) { return aexpr(a) < aexpr(b) ? 1 : 0; });\n  def([\"lessequalp\", \"lessequal?\"], function(a, b) { return aexpr(a) <= aexpr(b) ? 1 : 0; });\n\n  // 4.3 Random Numbers\n\n  def(\"random\", function(max) {\n    if (arguments.length < 2) {\n      max = aexpr(max);\n      return Math.floor(this.prng.next() * max);\n    } else {\n      var start = aexpr(arguments[0]);\n      var end = aexpr(arguments[1]);\n      return Math.floor(this.prng.next() * (end - start + 1)) + start;\n    }\n  }, {maximum: 2});\n\n  def(\"rerandom\", function() {\n    var seed = (arguments.length > 0) ? aexpr(arguments[0]) : 2345678901;\n    return this.prng.seed(seed);\n  }, {maximum: 1});\n\n  // 4.4 Print Formatting\n\n  def(\"form\", function(num, width, precision) {\n    num = aexpr(num);\n    width = aexpr(width);\n    precision = aexpr(precision);\n\n    var str = num.toFixed(precision);\n    if (str.length < width)\n      str = Array(1 + width - str.length).join(' ') + str;\n    return str;\n  });\n\n  // 4.5 Bitwise Operations\n\n\n  def(\"bitand\", function(num1, num2) {\n    return Array.from(arguments).map(aexpr).reduce(function(a, b) { return a & b; }, -1);\n  }, {minimum: 0, maximum: -1});\n  def(\"bitor\", function(num1, num2) {\n    return Array.from(arguments).map(aexpr).reduce(function(a, b) { return a | b; }, 0);\n  }, {minimum: 0, maximum: -1});\n  def(\"bitxor\", function(num1, num2) {\n    return Array.from(arguments).map(aexpr).reduce(function(a, b) { return a ^ b; }, 0);\n  }, {minimum: 0, maximum: -1});\n  def(\"bitnot\", function(num) {\n    return ~aexpr(num);\n  });\n\n\n  def(\"ashift\", function(num1, num2) {\n    num1 = truncate(aexpr(num1));\n    num2 = truncate(aexpr(num2));\n    return num2 >= 0 ? num1 << num2 : num1 >> -num2;\n  });\n\n  def(\"lshift\", function(num1, num2) {\n    num1 = truncate(aexpr(num1));\n    num2 = truncate(aexpr(num2));\n    return num2 >= 0 ? num1 << num2 : num1 >>> -num2;\n  });\n\n\n  //----------------------------------------------------------------------\n  //\n  // 5. Logical Operations\n  //\n  //----------------------------------------------------------------------\n\n  def(\"true\", function() { return 1; });\n  def(\"false\", function() { return 0; });\n\n  def(\"and\", function(a, b) {\n    var args = Array.from(arguments);\n    return booleanReduce(args, function(value) {return value;}, 1);\n  }, {noeval: true, minimum: 0, maximum: -1});\n\n  def(\"or\", function(a, b) {\n    var args = Array.from(arguments);\n    return booleanReduce(args, function(value) {return !value;}, 0);\n  }, {noeval: true, minimum: 0, maximum: -1});\n\n  function booleanReduce(args, test, value) {\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!args.length) {\n        resolve(value);\n        return;\n      }\n      Promise.resolve(args.shift()())\n        .then(function(result) {\n          if (!test(result)) {\n            resolve(result);\n            return;\n          }\n          value = result;\n          loop();\n        });\n    });\n  }\n\n  def(\"xor\", function(a, b) {\n    return Array.from(arguments).map(aexpr)\n      .reduce(function(a, b) { return Boolean(a) !== Boolean(b); }, 0) ? 1 : 0;\n  }, {minimum: 0, maximum: -1});\n\n  def(\"not\", function(a) {\n    return !aexpr(a) ? 1 : 0;\n  });\n\n  //----------------------------------------------------------------------\n  //\n  // 6. Graphics\n  //\n  //----------------------------------------------------------------------\n  // 6.1 Turtle Motion\n\n  def([\"forward\", \"fd\"], function(a) { return turtle.move(aexpr(a)); });\n  def([\"back\", \"bk\"], function(a) { return turtle.move(-aexpr(a)); });\n  def([\"left\", \"lt\"], function(a) { return turtle.turn(-aexpr(a)); });\n  def([\"right\", \"rt\"], function(a) { return turtle.turn(aexpr(a)); });\n\n  // Left arrow:\n  def([\"\\u2190\"], function() { return turtle.turn(-15); });\n  // Right arrow:\n  def([\"\\u2192\"], function() { return turtle.turn(15); });\n  // Up arrow:\n  def([\"\\u2191\"], function() { return turtle.move(10); });\n  // Down arrow:\n  def([\"\\u2193\"], function() { return turtle.move(-10); });\n\n\n  def(\"setpos\", function(l) {\n    l = lexpr(l);\n    if (l.length !== 2) throw err(\"{_PROC_}: Expected list of length 2\", ERRORS.BAD_INPUT);\n    turtle.position = [aexpr(l[0]), aexpr(l[1])];\n  });\n  def(\"setxy\", function(x, y) { turtle.position = [aexpr(x), aexpr(y)]; });\n  def(\"setx\", function(x) { turtle.position = [aexpr(x), undefined]; });\n  def(\"sety\", function(y) { turtle.position = [undefined, aexpr(y)]; });\n  def([\"setheading\", \"seth\"], function(a) { turtle.heading = aexpr(a); });\n\n  def(\"home\", function() { return turtle.home(); });\n\n  def(\"arc\", function(angle, radius) { return turtle.arc(aexpr(angle), aexpr(radius)); });\n\n  //\n  // 6.2 Turtle Motion Queries\n  //\n\n  def(\"pos\", function() { return turtle.position; });\n  def(\"xcor\", function() { return turtle.position[0]; });\n  def(\"ycor\", function() { return turtle.position[1]; });\n  def(\"heading\", function() { return turtle.heading; });\n  def(\"towards\", function(l) {\n    l = lexpr(l);\n    if (l.length !== 2) throw err(\"{_PROC_}: Expected list of length 2\", ERRORS.BAD_INPUT);\n    return turtle.towards(aexpr(l[0]), aexpr(l[1]));\n  });\n  def(\"scrunch\", function() { return turtle.scrunch; });\n\n  //\n  // 6.3 Turtle and Window Control\n  //\n\n  def([\"showturtle\", \"st\"], function() { turtle.visible = true; });\n  def([\"hideturtle\", \"ht\"], function() { turtle.visible = false; });\n  def(\"clean\", function() { turtle.clear(); });\n  def([\"clearscreen\", \"cs\"], function() { turtle.clearscreen(); });\n\n  def(\"wrap\", function() { turtle.turtlemode = 'wrap'; });\n  def(\"window\", function() { turtle.turtlemode = 'window'; });\n  def(\"fence\", function() { turtle.turtlemode = 'fence'; });\n\n  def(\"fill\", function() { turtle.fill(); });\n\n  def(\"filled\", function(fillcolor, statements) {\n    fillcolor = parseColor(fillcolor);\n    statements = reparse(lexpr(statements));\n    turtle.beginpath();\n    return promiseFinally(\n      this.execute(statements),\n      function() {\n        turtle.fillpath(fillcolor);\n      });\n  });\n\n  def(\"label\", function(a) {\n    var s = Array.from(arguments).map(stringify_nodecorate).join(\" \");\n    return turtle.drawtext(s);\n  }, {maximum: -1});\n\n  def(\"setlabelheight\", function(a) { turtle.fontsize = aexpr(a); });\n\n  def(\"setlabelfont\", function(a) { turtle.fontname = sexpr(a); });\n\n  // Not Supported: textscreen\n  // Not Supported: fullscreen\n  // Not Supported: splitscreen\n\n  def(\"setscrunch\", function(sx, sy) {\n    sx = aexpr(sx);\n    sy = aexpr(sy);\n    if (!isFinite(sx) || sx === 0 || !isFinite(sy) || sy === 0)\n      throw err(\"{_PROC_}: Expected non-zero values\", ERRORS.BAD_INPUT);\n    turtle.scrunch = [sx, sy];\n  });\n\n  // Not Supported: refresh\n  // Not Supported: norefresh\n\n  //\n  // 6.4 Turtle and Window Queries\n  //\n\n  def([\"shownp\", \"shown?\"], function() {\n    return turtle.visible ? 1 : 0;\n  });\n\n  // Not Supported: screenmode\n\n  def(\"turtlemode\", function() {\n    return turtle.turtlemode.toUpperCase();\n  });\n\n  def(\"labelsize\", function() {\n    return [turtle.fontsize, turtle.fontsize];\n  });\n\n  def(\"labelfont\", function() {\n    return turtle.fontname;\n  });\n\n  //\n  // 6.5 Pen and Background Control\n  //\n  def([\"pendown\", \"pd\"], function() { turtle.pendown = true; });\n  def([\"penup\", \"pu\"], function() { turtle.pendown = false; });\n\n  def([\"penpaint\", \"ppt\"], function() { turtle.penmode = 'paint'; });\n  def([\"penerase\", \"pe\"], function() { turtle.penmode = 'erase'; });\n  def([\"penreverse\", \"px\"], function() { turtle.penmode = 'reverse'; });\n\n  // To handle additional color names (localizations, etc):\n  // logo.colorAlias = function(name) {\n  //   return {internationalorange: '#FF4F00', ... }[name];\n  // };\n  this.colorAlias = null;\n\n  var PALETTE = {\n    0: \"black\", 1: \"blue\", 2: \"lime\", 3: \"cyan\",\n    4: \"red\", 5: \"magenta\", 6: \"yellow\", 7: \"white\",\n    8: \"brown\", 9: \"tan\", 10: \"green\", 11: \"aquamarine\",\n    12: \"salmon\", 13: \"purple\", 14: \"orange\", 15: \"gray\"\n  };\n\n  function parseColor(color) {\n    function adjust(n) {\n      // Clamp into 0...99\n      n = Math.min(99, Math.max(0, Math.floor(n)));\n      // Scale to 0...255\n      return Math.floor(n * 255 / 99);\n    }\n    if (Type(color) === 'list') {\n      var r = adjust(aexpr(color[0]));\n      var g = adjust(aexpr(color[1]));\n      var b = adjust(aexpr(color[2]));\n      var rr = (r < 16 ? \"0\" : \"\") + r.toString(16);\n      var gg = (g < 16 ? \"0\" : \"\") + g.toString(16);\n      var bb = (b < 16 ? \"0\" : \"\") + b.toString(16);\n      return '#' + rr + gg + bb;\n    }\n    color = sexpr(color);\n    if (PALETTE.hasOwnProperty(color))\n      return PALETTE[color];\n    if (self.colorAlias)\n      return self.colorAlias(color) || color;\n    return color;\n  }\n\n  def([\"setpencolor\", \"setpc\", \"setcolor\"], function(color) {\n    turtle.color = parseColor(color);\n  });\n\n  def(\"setpalette\", function(colornumber, color) {\n    colornumber = aexpr(colornumber);\n    if (colornumber < 8)\n      throw err(\"{_PROC_}: Expected number greater than 8\", ERRORS.BAD_INPUT);\n    PALETTE[colornumber] = parseColor(color);\n  });\n\n  def([\"setpensize\", \"setwidth\", \"setpw\"], function(a) {\n    if (Type(a) === 'list')\n      turtle.penwidth = aexpr(a[0]);\n    else\n      turtle.penwidth = aexpr(a);\n  });\n\n  // Not Supported: setpenpattern\n  // Not Supported: setpen\n\n  def([\"setbackground\", \"setbg\", \"setscreencolor\", \"setsc\"], function(color) {\n    turtle.bgcolor = parseColor(color);\n  });\n\n  //\n  // 6.6 Pen Queries\n  //\n\n  def([\"pendownp\", \"pendown?\"], function() {\n    return turtle.pendown ? 1 : 0;\n  });\n\n  def(\"penmode\", function() {\n    return turtle.penmode.toUpperCase();\n  });\n\n  def([\"pencolor\", \"pc\"], function() {\n    return turtle.color;\n  });\n\n  def(\"palette\", function(colornumber) {\n    return PALETTE[aexpr(colornumber)];\n  });\n\n  def(\"pensize\", function() {\n    return [turtle.penwidth, turtle.penwidth];\n  });\n\n  // Not Supported: pen\n\n  def([\"background\", \"bg\", \"getscreencolor\", \"getsc\"], function() {\n    return turtle.bgcolor;\n  });\n\n  // 6.7 Saving and Loading Pictures\n\n  // Not Supported: savepict\n  // Not Supported: loadpict\n  // Not Supported: epspict\n\n  // 6.8 Mouse Queries\n\n  def(\"mousepos\", function() {\n    return turtle.mousepos;\n  });\n\n  def(\"clickpos\", function() {\n    return turtle.clickpos;\n  });\n\n  def([\"buttonp\", \"button?\"], function() {\n    return turtle.button > 0 ? 1 : 0;\n  });\n\n  def(\"button\", function() {\n    return turtle.button;\n  });\n\n  def(\"touches\", function() {\n    return turtle.touches;\n  });\n\n  //----------------------------------------------------------------------\n  //\n  // 7. Workspace Management\n  //\n  //----------------------------------------------------------------------\n  // 7.1 Procedure Definition\n\n  def(\"define\", function(name, list) {\n    name = sexpr(name);\n    list = lexpr(list);\n    if (list.length != 2)\n      throw err(\"{_PROC_}: Expected list of length 2\", ERRORS.BAD_INPUT);\n\n    var inputs = [];\n    var optional_inputs = [];\n    var rest = undefined;\n    var def = undefined;\n    var block = reparse(lexpr(list[1]));\n\n    var ins = lexpr(list[0]);\n    var REQUIRED = 0, OPTIONAL = 1, REST = 2, DEFAULT = 3, ERROR = 4;\n    var state = REQUIRED;\n    while (ins.length) {\n      var atom = ins.shift();\n      if (state === REQUIRED) {\n        if (Type(atom) === 'word') {\n          inputs.push(atom);\n          continue;\n        }\n        state = OPTIONAL;\n      }\n\n      if (state === OPTIONAL) {\n        if (Type(atom) === 'list' && atom.length > 1 && Type(atom[0]) === 'word') {\n          optional_inputs.push([atom.shift(), atom]);\n          continue;\n        }\n        state = REST;\n      }\n\n      if (state === REST) {\n        state = DEFAULT;\n        if (Type(atom) === 'list' && atom.length === 1 && Type(atom[0]) === 'word') {\n          rest = atom[0];\n          continue;\n        }\n      }\n\n      if (state === DEFAULT) {\n        state = ERROR;\n        if (Type(atom) === 'word' && isNumber(atom)) {\n          def = parseFloat(atom);\n          continue;\n        }\n      }\n\n      throw err(\"{_PROC_}: Unexpected inputs\", ERRORS.BAD_INPUT);\n    }\n\n    defineProc(name, inputs, optional_inputs, rest, def, block);\n  });\n\n  def(\"text\", function(name) {\n    var proc = this.routines.get(sexpr(name));\n    if (!proc)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: name }, ERRORS.BAD_PROC);\n    if (!proc.inputs) {\n      throw err(\"{_PROC_}: Can't show definition of primitive {name:U}\", { name: name },\n               ERRORS.IS_PRIMITIVE);\n    }\n\n    var inputs = proc.inputs.concat(proc.optional_inputs);\n    if (proc.rest)\n      inputs.push([proc.rest]);\n    if (proc.def !== undefined)\n      inputs.push(proc.def);\n    return [inputs, proc.block];\n  });\n\n  // Not Supported: fulltext\n\n  def(\"copydef\", function(newname, oldname) {\n\n    newname = sexpr(newname);\n    oldname = sexpr(oldname);\n\n    if (!this.routines.has(oldname)) {\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: oldname }, ERRORS.BAD_PROC);\n    }\n\n    if (this.routines.has(newname)) {\n      if (this.routines.get(newname).special) {\n        throw err(\"{_PROC_}: Can't overwrite special {name:U}\", { name: newname },\n                  ERRORS.BAD_INPUT);\n      }\n      if (this.routines.get(newname).primitive && !maybegetvar(\"redefp\")) {\n        throw err(\"{_PROC_}: Can't overwrite primitives unless REDEFP is TRUE\",\n                 ERRORS.BAD_INPUT);\n      }\n    }\n\n    this.routines.set(newname, this.routines.get(oldname));\n    // TODO: This is broken if copying a built-in, so disable for now\n    //saveproc(newname, this.definition(newname, this.routines.get(newname)));\n  });\n\n\n  // 7.2 Variable Definition\n\n  def(\"make\", function(varname, value) {\n    setvar(sexpr(varname), value);\n  });\n\n  def(\"name\", function(value, varname) {\n    setvar(sexpr(varname), value);\n  });\n\n  def(\"local\", function(varname) {\n    Array.from(arguments).forEach(function(name) { local(sexpr(name)); });\n  }, {maximum: -1});\n\n  def(\"localmake\", function(varname, value) {\n    setlocal(sexpr(varname), value);\n  });\n\n  def(\"thing\", function(varname) {\n    return getvar(sexpr(varname));\n  });\n\n  def(\"global\", function(varname) {\n    var globalscope = this.scopes[0];\n    Array.from(arguments).forEach(function(name) {\n      globalscope.set(sexpr(name), {value: undefined}); });\n  }, {maximum: -1});\n\n  //\n  // 7.3 Property Lists\n  //\n\n  def(\"pprop\", function(plistname, propname, value) {\n    plistname = sexpr(plistname);\n    propname = sexpr(propname);\n    var plist = this.plists.get(plistname);\n    if (!plist) {\n      plist = new StringMap(true);\n      this.plists.set(plistname, plist);\n    }\n    plist.set(propname, value);\n  });\n\n  def(\"gprop\", function(plistname, propname) {\n    plistname = sexpr(plistname);\n    propname = sexpr(propname);\n    var plist = this.plists.get(plistname);\n    if (!plist || !plist.has(propname))\n      return [];\n    return plist.get(propname);\n  });\n\n  def(\"remprop\", function(plistname, propname) {\n    plistname = sexpr(plistname);\n    propname = sexpr(propname);\n    var plist = this.plists.get(plistname);\n    if (plist) {\n      plist['delete'](propname);\n      if (plist.empty()) {\n        // TODO: Do this? Loses state, e.g. unburies if buried\n        this.plists['delete'](plistname);\n      }\n    }\n  });\n\n  def(\"plist\", function(plistname) {\n    plistname = sexpr(plistname);\n    var plist = this.plists.get(plistname);\n    if (!plist)\n      return [];\n\n    var result = [];\n    plist.forEach(function(key, value) {\n      result.push(key);\n      result.push(copy(value));\n    });\n    return result;\n  });\n\n  //\n  // 7.4 Workspace Predicates\n  //\n\n  def([\"procedurep\", \"procedure?\"], function(name) {\n    name = sexpr(name);\n    return this.routines.has(name) ? 1 : 0;\n  });\n\n  def([\"primitivep\", \"primitive?\"], function(name) {\n    name = sexpr(name);\n    return (this.routines.has(name) &&\n            this.routines.get(name).primitive) ? 1 : 0;\n  });\n\n  def([\"definedp\", \"defined?\"], function(name) {\n    name = sexpr(name);\n    return (this.routines.has(name) &&\n            !this.routines.get(name).primitive) ? 1 : 0;\n  });\n\n  def([\"namep\", \"name?\"], function(varname) {\n    try {\n      return getvar(sexpr(varname)) !== undefined ? 1 : 0;\n    } catch (e) {\n      return 0;\n    }\n  });\n\n  def([\"plistp\", \"plist?\"], function(plistname) {\n    plistname = sexpr(plistname);\n    return this.plists.has(plistname) ? 1 : 0;\n  });\n\n  //\n  // 7.5 Workspace Queries\n  //\n\n  def(\"contents\", function() {\n    return [\n      this.routines.keys().filter(function(x) {\n        return !this.routines.get(x).primitive && !this.routines.get(x).buried;\n      }.bind(this)),\n      this.scopes.reduce(\n        function(list, scope) {\n          return list.concat(scope.keys().filter(function(x) { return !scope.get(x).buried; })); },\n        []),\n      this.plists.keys().filter(function(x) {\n        return !this.plists.get(x).buried;\n      }.bind(this))\n    ];\n  });\n\n  def(\"buried\", function() {\n    return [\n      this.routines.keys().filter(function(x) {\n        return !this.routines.get(x).primitive && this.routines.get(x).buried; }.bind(this)),\n      this.scopes.reduce(\n        function(list, scope) {\n          return list.concat(scope.keys().filter(function(x) { return scope.get(x).buried; })); },\n        []),\n      this.plists.keys().filter(function(x) { return this.plists.get(x).buried; }.bind(this))\n    ];\n  });\n\n  def(\"traced\", function() {\n    return [\n      this.routines.keys().filter(function(x) {\n        return !this.routines.get(x).primitive && this.routines.get(x).traced; }.bind(this)),\n      this.scopes.reduce(\n        function(list, scope) {\n          return list.concat(scope.keys().filter(function(x) { return scope.get(x).traced; })); },\n        []),\n      this.plists.keys().filter(function(x) { return this.plists.get(x).traced; }.bind(this))\n    ];\n  });\n\n  def([\"stepped\"], function() {\n    return [\n      this.routines.keys().filter(function(x) {\n        return !this.routines.get(x).primitive && this.routines.get(x).stepped; }.bind(this)),\n      this.scopes.reduce(\n        function(list, scope) {\n          return list.concat(scope.keys().filter(function(x) { return scope.get(x).stepped; })); },\n        []),\n      this.plists.keys().filter(function(x) { return this.plists.get(x).stepped; }.bind(this))\n    ];\n  });\n\n  def(\"procedures\", function() {\n    return this.routines.keys().filter(function(x) {\n      return !this.routines.get(x).primitive && !this.routines.get(x).buried;\n    }.bind(this));\n  });\n\n  def(\"primitives\", function() {\n    return this.routines.keys().filter(function(x) {\n      return this.routines.get(x).primitive & !this.routines.get(x).buried;\n    }.bind(this));\n  });\n\n  def(\"globals\", function() {\n    var globalscope = this.scopes[0];\n    return globalscope.keys().filter(function(x) {\n      return !globalscope.get(x).buried;\n    });\n  });\n\n  def(\"names\", function() {\n    return [\n      [],\n      this.scopes.reduce(function(list, scope) {\n        return list.concat(scope.keys().filter(function(x) {\n          return !scope.get(x).buried; })); }, [])\n    ];\n  });\n\n  def(\"plists\", function() {\n    return [\n      [],\n      [],\n      this.plists.keys().filter(function(x) {\n        return !this.plists.get(x).buried;\n      }.bind(this))\n    ];\n  });\n\n  def(\"namelist\", function(varname) {\n    if (Type(varname) === 'list')\n      varname = lexpr(varname);\n    else\n      varname = [sexpr(varname)];\n    return [[], varname];\n  });\n\n  def(\"pllist\", function(plname) {\n    if (Type(plname) === 'list') {\n      plname = lexpr(plname);\n    } else {\n      plname = [sexpr(plname)];\n    }\n    return [[], [], plname];\n  });\n\n\n  def(\"arity\", function(name) {\n    name = sexpr(name);\n    var proc = this.routines.get(name);\n    if (!proc)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: name }, ERRORS.BAD_PROC);\n    if (proc.special)\n      return [-1, -1, -1];\n\n    return [\n      proc.minimum,\n      proc.default,\n      proc.maximum\n    ];\n  });\n\n  // Not Supported: nodes\n\n  // 7.6 Workspace Inspection\n\n  //\n  // 7.7 Workspace Control\n  //\n\n  def(\"erase\", function(list) {\n    list = lexpr(list);\n\n    // Delete procedures\n    if (list.length) {\n      var procs = lexpr(list.shift());\n      procs.forEach(function(name) {\n        name = sexpr(name);\n        if (this.routines.has(name)) {\n          if (this.routines.get(name).special)\n            throw err(\"Can't {_PROC_} special {name:U}\", { name: name }, ERRORS.BAD_INPUT);\n          if (!this.routines.get(name).primitive || maybegetvar(\"redefp\")) {\n            this.routines['delete'](name);\n            saveproc(name);\n          } else {\n            throw err(\"Can't {_PROC_} primitives unless REDEFP is TRUE\", ERRORS.BAD_INPUT);\n          }\n        }\n      }.bind(this));\n    }\n\n    // Delete variables\n    if (list.length) {\n      var vars = lexpr(list.shift());\n      // TODO: global only?\n      this.scopes.forEach(function(scope) {\n        vars.forEach(function(name) {\n          name = sexpr(name);\n          scope['delete'](name);\n        });\n      });\n    }\n\n    // Delete property lists\n    if (list.length) {\n      var plists = lexpr(list.shift());\n      plists.forEach(function(name) {\n        name = sexpr(name);\n        this.plists['delete'](name);\n      }.bind(this));\n    }\n  });\n\n  // TODO: lots of redundant logic here -- clean this up\n  def(\"erall\", function() {\n    this.routines.keys().filter(function(x) {\n      return !this.routines.get(x).primitive && !this.routines.get(x).buried;\n    }.bind(this)).forEach(function(name) {\n      this.routines['delete'](name);\n      saveproc(name);\n    }.bind(this));\n\n    this.scopes.forEach(function(scope) {\n      scope.keys().filter(function(x) {\n        return !scope.get(x).buried;\n      }).forEach(function(name) {\n        scope['delete'](name);\n      });\n    });\n\n    this.plists.keys().filter(function(x) {\n      return !this.plists.get(x).buried;\n    }.bind(this)).forEach(function(name) {\n      this.plists['delete'](name);\n    }.bind(this));\n  });\n\n  def(\"erps\", function() {\n    this.routines.keys().filter(function(x) {\n      return !this.routines.get(x).primitive && !this.routines.get(x).buried;\n    }.bind(this)).forEach(function(name) {\n      this.routines['delete'](name);\n      saveproc(name);\n    }.bind(this));\n  });\n\n  def(\"erns\", function() {\n    this.scopes.forEach(function(scope) {\n      scope.keys().filter(function(x) {\n        return !scope.get(x).buried;\n      }).forEach(function(name) {\n        scope['delete'](name);\n      });\n    });\n  });\n\n  def(\"erpls\", function() {\n    this.plists.keys().filter(function(x) {\n      return !this.plists.get(x).buried;\n    }.bind(this)).forEach(function(key) {\n      this.plists['delete'](key);\n    }.bind(this));\n  });\n\n  def(\"ern\", function(varname) {\n    var varnamelist;\n    if (Type(varname) === 'list')\n      varnamelist = lexpr(varname);\n    else\n      varnamelist = [sexpr(varname)];\n\n    this.scopes.forEach(function(scope) {\n      varnamelist.forEach(function(name) {\n        name = sexpr(name);\n        scope['delete'](name);\n      });\n    });\n  });\n\n  def(\"erpl\", function(plname) {\n    var plnamelist;\n    if (Type(plname) === 'list') {\n      plnamelist = lexpr(plname);\n    } else {\n      plnamelist = [sexpr(plname)];\n    }\n\n    plnamelist.forEach(function(name) {\n      name = sexpr(name);\n      this.plists['delete'](name);\n    }.bind(this));\n  });\n\n  def(\"bury\", function(list) {\n    list = lexpr(list);\n\n    // Bury procedures\n    if (list.length) {\n      var procs = lexpr(list.shift());\n      procs.forEach(function(name) {\n        name = sexpr(name);\n        if (this.routines.has(name))\n          this.routines.get(name).buried = true;\n      }.bind(this));\n    }\n\n    // Bury variables\n    if (list.length) {\n      var vars = lexpr(list.shift());\n      // TODO: global only?\n      this.scopes.forEach(function(scope) {\n        vars.forEach(function(name) {\n          name = sexpr(name);\n          if (scope.has(name))\n            scope.get(name).buried = true;\n        });\n      });\n    }\n\n    // Bury property lists\n    if (list.length) {\n      var plists = lexpr(list.shift());\n      plists.forEach(function(name) {\n        name = sexpr(name);\n        if (this.plists.has(name))\n          this.plists.get(name).buried = true;\n      }.bind(this));\n    }\n  });\n\n  def(\"buryall\", function() {\n    this.routines.forEach(function(name, proc) {\n      proc.buried = true;\n    });\n\n    this.scopes.forEach(function(scope) {\n      scope.forEach(function(name, entry) {\n        entry.buried = true;\n      });\n    });\n\n    this.plists.forEach(function(name, entry) {\n      entry.buried = true;\n    });\n  });\n\n  def(\"buryname\", function(varname) {\n    var bury = this.routines.get('bury');\n    var namelist = this.routines.get('namelist');\n    return bury.call(this, namelist.call(this, varname));\n  });\n\n  def(\"unbury\", function(list) {\n    list = lexpr(list);\n\n    // Procedures\n    if (list.length) {\n      var procs = lexpr(list.shift());\n      procs.forEach(function(name) {\n        name = sexpr(name);\n        if (this.routines.has(name))\n          this.routines.get(name).buried = false;\n      }.bind(this));\n    }\n\n    // Variables\n    if (list.length) {\n      var vars = lexpr(list.shift());\n      // TODO: global only?\n      this.scopes.forEach(function(scope) {\n        vars.forEach(function(name) {\n          name = sexpr(name);\n          if (scope.has(name))\n            scope.get(name).buried = false;\n        });\n      });\n    }\n\n    // Property lists\n    if (list.length) {\n      var plists = lexpr(list.shift());\n      plists.forEach(function(name) {\n        name = sexpr(name);\n        if (this.plists.has(name))\n          this.plists.get(name).buried = false;\n      }.bind(this));\n    }\n  });\n\n  def(\"unburyall\", function() {\n    this.routines.forEach(function(name, proc) {\n      proc.buried = false;\n    });\n\n    this.scopes.forEach(function(scope) {\n      scope.forEach(function(name, entry) {\n        entry.buried = false;\n      });\n    });\n\n    this.plists.forEach(function(name, entry) {\n      entry.buried = false;\n    });\n  });\n\n  def(\"unburyname\", function(varname) {\n    var unbury = this.routines.get('unbury');\n    var namelist = this.routines.get('namelist');\n    return unbury.call(this, namelist.call(this, varname));\n  });\n\n  def([\"buriedp\", \"buried?\"], function(list) {\n    list = lexpr(list);\n    var name;\n\n    // Procedures\n    if (list.length) {\n      var procs = lexpr(list.shift());\n      if (procs.length) {\n        name = sexpr(procs[0]);\n        return (this.routines.has(name) && this.routines.get(name).buried) ? 1 : 0;\n      }\n    }\n\n    // Variables\n    if (list.length) {\n      var vars = lexpr(list.shift());\n      if (vars.length) {\n        name = sexpr(vars[0]);\n        // TODO: global only?\n        return (this.scopes[0].has(name) && this.scopes[0].get(name).buried) ? 1 : 0;\n      }\n    }\n\n    // Property lists\n    if (list.length) {\n      var plists = lexpr(list.shift());\n      if (plists.length) {\n        name = sexpr(plists[0]);\n        return (this.plists.has(name) && this.plists.get(name).buried) ? 1 : 0;\n      }\n    }\n\n    return 0;\n  });\n\n  //----------------------------------------------------------------------\n  //\n  // 8. Control Structures\n  //\n  //----------------------------------------------------------------------\n\n  //\n  // 8.1 Control\n  //\n\n  def(\"run\", function(statements) {\n    statements = reparse(lexpr(statements));\n    return this.execute(statements, {returnResult: true});\n  });\n\n  def(\"runresult\", function(statements) {\n    statements = reparse(lexpr(statements));\n    return this.execute(statements, {returnResult: true})\n      .then(function(result) {\n        if (result !== undefined)\n          return [result];\n        else\n          return [];\n      });\n  });\n\n  def(\"repeat\", function(count, statements) {\n    count = aexpr(count);\n    statements = reparse(lexpr(statements));\n    var old_repcount = this.repcount;\n    var i = 1;\n    return promiseFinally(\n      promiseLoop(function(loop, resolve, reject) {\n        if (i > count) {\n          resolve();\n          return;\n        }\n        this.repcount = i++;\n        this.execute(statements)\n          .then(promiseYield)\n          .then(loop, reject);\n      }.bind(this)), function() {\n        this.repcount = old_repcount;\n      }.bind(this));\n  });\n\n  def(\"forever\", function(statements) {\n    statements = reparse(lexpr(statements));\n    var old_repcount = this.repcount;\n    var i = 1;\n    return promiseFinally(\n      promiseLoop(function(loop, resolve, reject) {\n        this.repcount = i++;\n        this.execute(statements)\n          .then(promiseYield)\n          .then(loop, reject);\n      }.bind(this)), function() {\n        this.repcount = old_repcount;\n      }.bind(this));\n  });\n\n  def([\"repcount\", \"#\"], function() {\n    return this.repcount;\n  });\n\n  def(\"if\", function(tf, statements) {\n    if (Type(tf) === 'list')\n      tf = evaluateExpression(reparse(tf));\n\n    var statements2 = arguments[2];\n\n    return Promise.resolve(tf)\n      .then(function(tf) {\n        tf = aexpr(tf);\n        statements = reparse(lexpr(statements));\n        if (!statements2) {\n          return tf ? this.execute(statements, {returnResult: true}) : undefined;\n        } else {\n          statements2 = reparse(lexpr(statements2));\n          return this.execute(tf ? statements : statements2, {returnResult: true});\n        }\n      }.bind(this));\n\n  }, {maximum: 3});\n\n  def(\"ifelse\", function(tf, statements1, statements2) {\n    if (Type(tf) === 'list')\n      tf = evaluateExpression(reparse(tf));\n\n    return Promise.resolve(tf)\n      .then(function(tf) {\n        tf = aexpr(tf);\n        statements1 = reparse(lexpr(statements1));\n        statements2 = reparse(lexpr(statements2));\n\n        return this.execute(tf ? statements1 : statements2, {returnResult: true});\n      }.bind(this));\n  });\n\n  def(\"test\", function(tf) {\n    if (Type(tf) === 'list')\n      tf = evaluateExpression(reparse(tf));\n\n    return Promise.resolve(tf)\n      .then(function(tf) {\n        tf = aexpr(tf);\n        // NOTE: A property on the scope, not within the scope\n        this.scopes[this.scopes.length - 1]._test = tf;\n      }.bind(this));\n  });\n\n  def([\"iftrue\", \"ift\"], function(statements) {\n    statements = reparse(lexpr(statements));\n    var tf = this.scopes[this.scopes.length - 1]._test;\n    if (tf === undefined)\n      throw err('{_PROC_}: Called without TEST', ERRORS.NO_TEST);\n    return tf ? this.execute(statements, {returnResult: true}) : undefined;\n  });\n\n  def([\"iffalse\", \"iff\"], function(statements) {\n    statements = reparse(lexpr(statements));\n    var tf = this.scopes[this.scopes.length - 1]._test;\n    if (tf === undefined)\n      throw err('{_PROC_}: Called without TEST', ERRORS.NO_TEST);\n    return !tf ? this.execute(statements, {returnResult: true}) : undefined;\n  });\n\n  def(\"stop\", function() {\n    throw new Output();\n  });\n\n  def([\"output\", \"op\"], function(atom) {\n    throw new Output(atom);\n  });\n\n  this.last_error = undefined;\n\n  def(\"catch\", function(tag, instructionlist) {\n    tag = sexpr(tag).toUpperCase();;\n    instructionlist = reparse(lexpr(instructionlist));\n    return this.execute(instructionlist, {returnResult: true})\n      .catch(function(error) {\n        if (!(error instanceof LogoError) || error.tag !== tag)\n          throw error;\n        this.last_error = error;\n        return error.value;\n      }.bind(this));\n  }, {maximum: 2});\n\n  def(\"throw\", function(tag) {\n    tag = sexpr(tag).toUpperCase();\n    var value = arguments[1];\n    var error = new LogoError(tag, value);\n    error.code = (arguments.length > 1) ? ERRORS.USER_GENERATED : ERRORS.THROW_ERROR;\n    throw error;\n  }, {maximum: 2});\n\n  def(\"error\", function() {\n    if (!this.last_error)\n      return [];\n\n    var list = [\n      this.last_error.code,\n      this.last_error.message,\n      this.last_error.proc,\n      this.last_error.line\n    ];\n    this.last_error = undefined;\n    return list;\n  });\n\n  // Not Supported: pause\n  // Not Supported: continue\n\n  def(\"wait\", function(time) {\n    return promiseYieldTime(Math.ceil(aexpr(time) / 60 * 1000));\n  });\n\n  def(\"bye\", function() {\n    throw new Bye;\n  });\n\n  def(\".maybeoutput\", function(value) {\n    throw new Output(value);\n  });\n\n  // Not Supported: goto\n  // Not Supported: tag\n\n  def(\"ignore\", function(value) {\n  });\n\n  def(\"`\", function(list) {\n    list = lexpr(list);\n    var out = [];\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!list.length) {\n        resolve(out);\n        return;\n      }\n      var member = list.shift(), instructionlist;\n\n      // TODO: Nested backquotes: \"Substitution is done only for\n      // commas at the same depth as the backquote in which they are\n      // found.\"\n      if (member === ',' && list.length) {\n        member = list.shift();\n        if (Type(member) === 'word')\n          member = [member];\n        instructionlist = reparse(member);\n        this.execute(instructionlist, {returnResult: true})\n          .then(function(result) {\n            out.push(result);\n            loop();\n          }).catch(reject);\n      } else if (member === ',@' && list.length) {\n        member = list.shift();\n        if (Type(member) === 'word')\n          member = [member];\n        instructionlist = reparse(member);\n        this.execute(instructionlist, {returnResult: true})\n          .then(function(result) {\n            out = out.concat(result);\n          })\n          .then(loop, reject);\n      } else if (Type(member) === 'word' && /^\",/.test(member)) {\n        instructionlist = reparse(member.substring(2));\n        this.execute(instructionlist, {returnResult: true})\n          .then(function(result) {\n            out.push('\"' + (Type(result) === 'list' ? result[0] : result));\n          })\n          .then(loop, reject);\n      } else if (Type(member) === 'word' && /^:,/.test(member)) {\n        instructionlist = reparse(member.substring(2));\n        this.execute(instructionlist, {returnResult: true})\n          .then(function(result) {\n            out.push(':' + (Type(result) === 'list' ? result[0] : result));\n          })\n          .then(loop, reject);\n      } else {\n        out.push(member);\n        loop();\n      }\n    }.bind(this));\n  });\n\n  def(\"for\", function(control, statements) {\n    control = reparse(lexpr(control));\n    statements = reparse(lexpr(statements));\n\n    function sign(x) { return x < 0 ? -1 : x > 0 ? 1 : 0; }\n\n    var varname = sexpr(control.shift());\n    var start, limit, step, current;\n\n    return Promise.resolve(evaluateExpression(control))\n      .then(function(r) {\n        current = start = aexpr(r);\n        return evaluateExpression(control);\n      })\n      .then(function(r) {\n        limit = aexpr(r);\n        return control.length ?\n          evaluateExpression(control) : (limit < start ? -1 : 1);\n      })\n      .then(function(r) {\n        step = aexpr(r);\n      })\n      .then(function() {\n        return promiseLoop(function(loop, resolve, reject) {\n          if (sign(current - limit) === sign(step)) {\n            resolve();\n            return;\n          }\n          setlocal(varname, current);\n          this.execute(statements)\n            .then(function() {\n              current += step;\n            })\n            .then(promiseYield)\n            .then(loop, reject);\n        }.bind(this));\n      }.bind(this));\n  });\n\n  def(\"dotimes\", function(control, statements) {\n    control = reparse(lexpr(control));\n    statements = reparse(lexpr(statements));\n\n    var varname = sexpr(control.shift());\n    var times, current = 1;\n\n    return Promise.resolve(evaluateExpression(control))\n      .then(function(r) {\n        times = aexpr(r);\n      })\n      .then(function() {\n        return promiseLoop(function(loop, resolve, reject) {\n          if (current > times) {\n            resolve();\n            return;\n          }\n          setlocal(varname, current);\n          this.execute(statements)\n            .then(function() {\n              ++current;\n            })\n            .then(promiseYield)\n            .then(loop, reject);\n        }.bind(this));\n      }.bind(this));\n  });\n\n  function checkevalblock(block) {\n    block = block();\n    if (Type(block) === 'list') { return block; }\n    throw err(\"{_PROC_}: Expected block\", ERRORS.BAD_INPUT);\n  }\n\n  def(\"do.while\", function(block, tfexpression) {\n    block = reparse(lexpr(checkevalblock(block)));\n    return promiseLoop(function(loop, resolve, reject) {\n      this.execute(block)\n        .then(tfexpression)\n        .then(function(tf) {\n          if (Type(tf) === 'list')\n            tf = evaluateExpression(reparse(tf));\n          return tf;\n        })\n        .then(function(tf) {\n          if (!tf) {\n            resolve();\n            return;\n          }\n          promiseYield().then(loop);\n        }, reject);\n    }.bind(this));\n  }, {noeval: true});\n\n  def(\"while\", function(tfexpression, block) {\n    block = reparse(lexpr(checkevalblock(block)));\n    return promiseLoop(function(loop, resolve, reject) {\n      Promise.resolve(tfexpression())\n        .then(function(tf) {\n          if (Type(tf) === 'list')\n            tf = evaluateExpression(reparse(tf));\n          return tf;\n        })\n        .then(function(tf) {\n          if (!tf) {\n            resolve();\n            return;\n          }\n          this.execute(block)\n            .then(promiseYield)\n            .then(loop, reject);\n        }.bind(this), reject);\n    }.bind(this));\n  }, {noeval: true});\n\n  def(\"do.until\", function(block, tfexpression) {\n    block = reparse(lexpr(checkevalblock(block)));\n    return promiseLoop(function(loop, resolve, reject) {\n      this.execute(block)\n        .then(tfexpression)\n        .then(function(tf) {\n          if (Type(tf) === 'list')\n            tf = evaluateExpression(reparse(tf));\n          return tf;\n        })\n        .then(function(tf) {\n          if (tf) {\n            resolve();\n            return;\n          }\n          promiseYield().then(loop);\n        }, reject);\n    }.bind(this));\n  }, {noeval: true});\n\n  def(\"until\", function(tfexpression, block) {\n    block = reparse(lexpr(checkevalblock(block)));\n    return promiseLoop(function(loop, resolve, reject) {\n      Promise.resolve(tfexpression())\n        .then(function(tf) {\n          if (Type(tf) === 'list')\n            tf = evaluateExpression(reparse(tf));\n          return tf;\n        })\n        .then(function(tf) {\n          if (tf) {\n            resolve();\n            return;\n          }\n          this.execute(block)\n            .then(promiseYield)\n            .then(loop, reject);\n        }.bind(this), reject);\n    }.bind(this));\n  }, {noeval: true});\n\n  def(\"case\", function(value, clauses) {\n    clauses = lexpr(clauses);\n\n    for (var i = 0; i < clauses.length; ++i) {\n      var clause = lexpr(clauses[i]);\n      var first = clause.shift();\n      if (isKeyword(first, 'ELSE'))\n        return evaluateExpression(clause);\n      if (lexpr(first).some(function(x) { return equal(x, value); }))\n        return evaluateExpression(clause);\n    }\n    return undefined;\n  });\n\n  def(\"cond\", function(clauses) {\n    clauses = lexpr(clauses);\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!clauses.length) {\n        resolve();\n        return;\n      }\n      var clause = lexpr(clauses.shift());\n      var first = clause.shift();\n      if (isKeyword(first, 'ELSE')) {\n        resolve(evaluateExpression(clause));\n        return;\n      }\n      evaluateExpression(reparse(lexpr(first)))\n        .then(function(result) {\n          if (result) {\n            resolve(evaluateExpression(clause));\n            return;\n          }\n          loop();\n        }, reject);\n    });\n  });\n\n  //\n  // 8.2 Template-based Iteration\n  //\n\n\n  //\n  // Higher order functions\n  //\n\n  // TODO: multiple inputs\n\n  def(\"apply\", function(procname, list) {\n    procname = sexpr(procname);\n\n    var routine = this.routines.get(procname);\n    if (!routine)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: procname }, ERRORS.BAD_PROC);\n    if (routine.special || routine.noeval)\n      throw err(\"Can't apply {_PROC_} to special {name:U}\", { name: procname }, ERRORS.BAD_INPUT);\n\n    return routine.apply(this, lexpr(list));\n  });\n\n  def(\"invoke\", function(procname, input1) {\n    procname = sexpr(procname);\n\n    var routine = this.routines.get(procname);\n    if (!routine)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: procname }, ERRORS.BAD_PROC);\n    if (routine.special || routine.noeval)\n      throw err(\"Can't apply {_PROC_} to special {name:U}\", { name: procname }, ERRORS.BAD_INPUT);\n\n    var args = [];\n    for (var i = 1; i < arguments.length; ++i)\n      args.push(arguments[i]);\n\n    return routine.apply(this, args);\n  }, {minimum: 1, maximum: -1});\n\n  def(\"foreach\", function(procname, list) {\n    procname = sexpr(procname);\n\n    var routine = this.routines.get(procname);\n    if (!routine)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: procname }, ERRORS.BAD_PROC);\n    if (routine.special || routine.noeval)\n      throw err(\"Can't apply {_PROC_} to special {name:U}\", { name: procname }, ERRORS.BAD_INPUT);\n    list = lexpr(list);\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!list.length) {\n        resolve();\n        return;\n      }\n      Promise.resolve(routine.call(this, list.shift()))\n        .then(loop, reject);\n    }.bind(this));\n  });\n\n\n  def(\"map\", function(procname, list/*,  ... */) {\n    procname = sexpr(procname);\n\n    var routine = this.routines.get(procname);\n    if (!routine)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: procname }, ERRORS.BAD_PROC);\n    if (routine.special || routine.noeval)\n      throw err(\"Can't apply {_PROC_} to special {name:U}\", { name: procname }, ERRORS.BAD_INPUT);\n\n    var lists = [].slice.call(arguments, 1).map(lexpr);\n    if (!lists.length)\n      throw err(\"{_PROC_}: Expected list\", ERRORS.BAD_INPUT);\n\n    var mapped = [];\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!lists[0].length) {\n        resolve(mapped);\n        return;\n      }\n\n      var args = lists.map(function(l) {\n        if (!l.length)\n          throw err(\"{_PROC_}: Expected lists of equal length\", ERRORS.BAD_INPUT);\n        return l.shift();\n      });\n\n      Promise.resolve(routine.apply(this, args))\n        .then(function(value) { mapped.push(value); })\n        .then(loop, reject);\n    }.bind(this));\n  }, {maximum: -1});\n\n  // Not Supported: map.se\n\n  def(\"filter\", function(procname, list) {\n    procname = sexpr(procname);\n\n    var routine = this.routines.get(procname);\n    if (!routine)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: procname }, ERRORS.BAD_PROC);\n    if (routine.special || routine.noeval)\n      throw err(\"Can't apply {_PROC_} to special {name:U}\", { name: procname }, ERRORS.BAD_INPUT);\n\n    list = lexpr(list);\n    var filtered = [];\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!list.length) {\n        resolve(filtered);\n        return;\n      }\n      var item = list.shift();\n      Promise.resolve(routine.call(this, item))\n        .then(function(value) { if (value) filtered.push(item); })\n        .then(loop, reject);\n    }.bind(this));\n  });\n\n  def(\"find\", function(procname, list) {\n    procname = sexpr(procname);\n\n    var routine = this.routines.get(procname);\n    if (!routine)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: procname }, ERRORS.BAD_PROC);\n    if (routine.special || routine.noeval)\n      throw err(\"Can't apply {_PROC_} to special {name:U}\", { name: procname }, ERRORS.BAD_INPUT);\n\n    list = lexpr(list);\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!list.length) {\n        resolve([]);\n        return;\n      }\n      var item = list.shift();\n      Promise.resolve(routine.call(this, item))\n        .then(function(value) {\n          if (value) {\n            resolve(item);\n            return;\n          }\n          loop();\n      }, reject);\n    }.bind(this));\n  });\n\n  def(\"reduce\", function(procname, list) {\n    procname = sexpr(procname);\n    list = lexpr(list);\n    var value = arguments[2] !== undefined ? arguments[2] : list.shift();\n\n    var procedure = this.routines.get(procname);\n    if (!procedure)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: procname }, ERRORS.BAD_PROC);\n    if (procedure.special || procedure.noeval)\n      throw err(\"Can't apply {_PROC_} to special {name:U}\", { name: procname }, ERRORS.BAD_INPUT);\n\n    return promiseLoop(function(loop, resolve, reject) {\n      if (!list.length) {\n        resolve(value);\n        return;\n      }\n      Promise.resolve(procedure.call(this, value, list.shift()))\n        .then(function(result) { value = result; })\n        .then(loop, reject);\n    }.bind(this));\n  }, {maximum: 3});\n\n\n  def(\"crossmap\", function(procname, list/*,  ... */) {\n    procname = sexpr(procname);\n\n    var routine = this.routines.get(procname);\n    if (!routine)\n      throw err(\"{_PROC_}: Don't know how to {name:U}\", { name: procname }, ERRORS.BAD_PROC);\n    if (routine.special || routine.noeval)\n      throw err(\"Can't apply {_PROC_} to special {name:U}\", { name: procname }, ERRORS.BAD_INPUT);\n\n    var lists = [].slice.call(arguments, 1).map(lexpr);\n    if (!lists.length)\n      throw err(\"{_PROC_}: Expected list\", ERRORS.BAD_INPUT);\n\n    // Special case: if only one element is present, use as list of lists.\n    if (lists.length === 1)\n      lists = lists[0].map(lexpr);\n\n    var indexes = lists.map(function() { return 0; });\n    var done = false;\n\n    var mapped = [];\n    return promiseLoop(function(loop, resolve, reject) {\n      if (done) {\n        resolve(mapped);\n        return;\n      }\n\n      var args = indexes.map(function(v, i) { return lists[i][v]; });\n\n      var pos = indexes.length - 1;\n      ++indexes[pos];\n      while (indexes[pos] === lists[pos].length) {\n        if (pos === 0) {\n          done = true;\n          break;\n        }\n        indexes[pos] = 0;\n        pos--;\n        ++indexes[pos];\n      }\n\n      Promise.resolve(routine.apply(this, args))\n        .then(function(value) { mapped.push(value); })\n        .then(loop, reject);\n    }.bind(this));\n  }, {maximum: -1});\n\n  // Not Supported: cascade\n  // Not Supported: cascade.2\n  // Not Supported: transfer\n\n  // Helper for testing that wraps a result in a Promise\n  def(\".promise\", function(value) {\n    return Promise.resolve(value);\n  });\n  def(\".verify_bound_ignore\", function(value) {\n    if (this === undefined)\n      throw new Error(\"Internal error: Unbound procedure\");\n  });\n  def(\".verify_bound_identity\", function(value) {\n    if (this === undefined)\n      throw new Error(\"Internal error: Unbound procedure\");\n    return value;\n  });\n}\n","\n// Flood Fill\n// https://github.com/eleks/canvasPaint/blob/master/js/index.js\n\nCanvasRenderingContext2D.prototype.floodFill = function(x, y) {\n  var context = this,\n      canvas = context.canvas,\n      w = canvas.width,\n      h = canvas.height;\n\n  x = x|0;\n  y = y|0;\n\n  // Putting the offsets in such an order as to minimize the\n  // possibility of cache miss during array access.\n  var dx = [ 0, -1, +1,  0];\n  var dy = [-1,  0,  0, +1];\n\n  // returns ARGB\n  function getColorAt(x, y) {\n    var img = context.getImageData(x, y, w, h);\n    var data = img.data;\n    return (data[3]<<24) | (data[0]<<16) | (data[1]<<8) | (data[2]);\n  }\n  var seedARGB = getColorAt(x, y);\n  context.fillRect(x, y, 1, 1);\n  var fillARGB = getColorAt(x, y);\n  if (seedARGB === fillARGB)\n    return;\n\n  var sa = (seedARGB >> 24) & 0xff,\n      sr = (seedARGB >> 16) & 0xff,\n      sg = (seedARGB >> 8) & 0xff,\n      sb = (seedARGB) & 0xff;\n\n  var fa = (fillARGB >> 24) & 0xff,\n      fr = (fillARGB >> 16) & 0xff,\n      fg = (fillARGB >> 8) & 0xff,\n      fb = (fillARGB) & 0xff;\n\n  var img = context.getImageData(0, 0, w, h);\n  var imgData = img.data;\n\n  var stack = [];\n  stack.push(x);\n  stack.push(y);\n\n  while (stack.length > 0) {\n    var curPointY = stack.pop();\n    var curPointX = stack.pop();\n\n    for (var i = 0; i < 4; i++) {\n      var nextPointX = curPointX + dx[i];\n      var nextPointY = curPointY + dy[i];\n\n      if (nextPointX < 0 || nextPointY < 0 || nextPointX >= w || nextPointY >= h) {\n        continue;\n      }\n\n      var nextPointOffset = (nextPointY * w + nextPointX) * 4;\n      if (imgData[nextPointOffset + 0] == sr &&\n          imgData[nextPointOffset + 1] == sg &&\n          imgData[nextPointOffset + 2] == sb &&\n          imgData[nextPointOffset + 3] == sa) {\n\n        imgData[nextPointOffset++] = fr;\n        imgData[nextPointOffset++] = fg;\n        imgData[nextPointOffset++] = fb;\n        imgData[nextPointOffset]   = fa;\n\n        stack.push(nextPointX);\n        stack.push(nextPointY);\n      }\n    }\n  }\n\n  context.putImageData(img, 0, 0);\n};\n","import \"./floodfill\"\nimport { CanvasTurtle } from \"./turtle.js\"\nimport {LogoInterpreter} from \"./logo.js\"\n\nexport  {CanvasTurtle, LogoInterpreter}\n\nwindow._attachJsLogo = () => {\n  window.CanvasTurtle = CanvasTurtle;\n  window.LogoInterpreter = LogoInterpreter;\n}"],"names":["deg2rad","d","Math","PI","rad2deg","r","font","px","name","Number","String","toLowerCase","indexOf","JSON","stringify","mod","a","b","CanvasTurtle","canvas_ctx","turtle_ctx","w","h","events","fillText","string","x","y","this","width","height","py","sx","sy","color","bgcolor","penwidth","penmode","fontsize","fontname","turtlemode","visible","pendown","was_oob","filling","_clickx","_clicky","_mousex","_mousey","_buttons","_touches","_init","_tick","mouse_handler","e","rect","getBoundingClientRect","_mousemove","clientX","left","clientY","top","buttons","bind","forEach","addEventListener","touch_handler","touches","Array","from","map","t","_touch","LogoInterpreter","turtle","stream","savehook","self","UNARY_MINUS","ERRORS","BAD_INPUT","NO_OUTPUT","NOT_ENOUGH_INPUTS","TOO_MANY_INPUTS","BAD_OUTPUT","MISSING_PAREN","BAD_VAR","BAD_PAREN","ALREADY_DEFINED","THROW_ERROR","IS_PRIMITIVE","BAD_PROC","NO_TEST","BAD_BRACKET","BAD_BRACE","USER_GENERATED","MISSING_SPACE","saveproc","def","format","params","replace","m","n","o","s","stack","length","toUpperCase","__","localize","err","code","undefined","error","LogoError","tag","value","message","proc","line","isKeyword","atom","match","Type","keywordAlias","promiseLoop","func","Promise","resolve","reject","loop","serialExecute","funcs","results","shift","then","result","push","promiseFinally","promise","finalBlock","lastTimeYielded","Date","now","promiseYield","currentTime","setTimeout","promiseYieldTime","msec","to_arity","$$func$$","arity","parms","i","f","eval","join","PRNG","seed","S","M","Q","next","last","StringMap","case_fold","_map","Map","_case_fold","LogoArray","size","origin","_array","_origin","Stream","_string","_index","_skip","Output","output","Bye","isArray","Object","Error","parse","atoms","prev","peek","leading_space","isWS","get","parseList","parseArray","parseQuoted","isOwnWord","inRange","parseNumber","inChars","OPERATOR_CHARS","parseOperator","trailing_space","isInfix","WORD_DELIMITER","rest","parseWord","chars","defineProperties","prototype","key","set","has","delete","keys","empty","fn","list","array","item","setItem","v","eof","c","charAt","_next","substring","routines","scopes","plists","prng","random","forceBye","toString","valueOf","WS_CHARS","QUOTED_DELIMITER","word","OWNWORD_CHARS","includes","isOperator","isNumber","parseInteger","reparse","stringify_nodecorate","maybegetvar","lval","lvalue","getvar","setvar","copy","local","sexpr","setlocal","options","some","evaluateExpression","expression","relationalExpression","op","lhs","additiveExpression","rhs","defer","aexpr","equal","input","slice","call","arguments","args","apply","multiplicativeExpression","powerExpression","unaryExpression","pow","finalExpression","literal","varname","parseFloat","dispatch","lexpr","sifw","tokenlist","natural","procedure","exec","special","pop","minimum","maximum","noeval","execute","statements","lastResult","returnResult","bye","lastRun","thing","props","primitive","defineProc","inputs","optional_inputs","block","scope","definition","index","contains","truncate","parseInt","booleanReduce","test","queueTask","task","run","defn","RegExp","procdefs","defs","copydef","newname","oldname","state","sawEnd","word1","word2","reduce","thing1","thing2","concat","l","unshift","sizes","make","tail","reverse","gensym_index","indexes","floor","filter","Set","add","ls","stackname","got","queue","chr","charCodeAt","integer","fromCharCode","findIndex","split","u","write","read","clear","parseColor","textsize","round","num1","num2","abs","sqrt","exp","log","LN10","atan2","atan","sin","cos","tan","step","to","count","max","start","end","num","precision","str","toFixed","Boolean","move","turn","position","heading","home","angle","radius","arc","towards","scrunch","clearscreen","fill","fillcolor","beginpath","fillpath","drawtext","isFinite","colorAlias","PALETTE","0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","adjust","min","g","hasOwnProperty","checkevalblock","colornumber","mousepos","clickpos","button","ins","globalscope","plistname","propname","plist","buried","traced","stepped","plname","vars","varnamelist","entry","bury","namelist","unbury","procs","old_repcount","repcount","tf","statements2","statements1","_test","last_error","instructionlist","time","ceil","out","member","control","sign","limit","current","times","tfexpression","clauses","clause","first","procname","routine","input1","lists","mapped","filtered","done","pos","CanvasRenderingContext2D","floodFill","context","canvas","dx","dy","getColorAt","data","getImageData","seedARGB","fillRect","fillARGB","sa","sr","sg","sb","fa","fr","fg","fb","img","imgData","curPointY","curPointX","nextPointX","nextPointY","nextPointOffset","putImageData","lineCap","strokeStyle","lineWidth","ctx","setTransform","requestAnimationFrame","cur","_last_state","save","clearRect","restore","translate","rotate","beginPath","points","p","pair","closePath","stroke","_moveto","setpos","ix","iy","wx","wy","fx","fy","less","_go","x1","y1","x2","y2","lineTo","moveTo","right","bottom","oob","console","_mouseclick","touch","resize","distance","point","saved_x","saved_y","fillStyle","text","scale","saved_turtlemode","getstate","isturtlestate","setstate","down","_down","_penmode","globalCompositeOperation","_turtlemode","_color","_bgcolor","_penwidth","_fontsize","_fontname","coords","_visible","sc","window","_attachJsLogo"],"mappings":"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"}