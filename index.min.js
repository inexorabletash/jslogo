function $(s){return document.querySelector(s)}function $$(s){return document.querySelectorAll(s)}function escapeHTML(s){return String(s).replace(/[&<>]/g,(function(c){switch(c){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";default:return c}}))}var logo,turtle;"console"in window||(window.console={log:function(){},error:function(){}});var examples="examples.txt",savehook,historyhook,clearhistoryhook;function hook(orig,func){return function(){try{func.apply(this,arguments)}finally{orig&&orig.apply(this,arguments)}}}function initStorage(loadhook){if(window.indexedDB){var req=indexedDB.open("logo",3);req.onblocked=function(){Dialog.alert("Please close other Logo pages to allow database upgrade to proceed.")},req.onerror=function(e){console.error(e)},req.onupgradeneeded=function(e){var db=req.result;e.oldVersion<2&&db.createObjectStore("procedures"),e.oldVersion<3&&db.createObjectStore("history",{autoIncrement:!0})},req.onsuccess=function(){var db=req.result,tx=db.transaction("procedures");tx.objectStore("procedures").openCursor().onsuccess=function(e){var cursor=e.target.result;if(cursor)try{loadhook(cursor.value)}catch(ex){console.error("Error loading procedure: "+ex)}finally{cursor.continue()}},(tx=db.transaction("history")).objectStore("history").openCursor().onsuccess=function(e){var cursor=e.target.result;if(cursor)try{historyhook(cursor.value)}catch(ex){console.error("Error loading procedure: "+ex)}finally{cursor.continue()}},tx.oncomplete=function(){savehook=hook(savehook,(function(name,def){var tx=db.transaction("procedures","readwrite");def?tx.objectStore("procedures").put(def,name):tx.objectStore("procedures").delete(name)})),historyhook=hook(historyhook,(function(entry){var tx;db.transaction("history","readwrite").objectStore("history").put(entry)})),clearhistoryhook=hook(clearhistoryhook,(function(){var tx;db.transaction("history","readwrite").objectStore("history").clear()}))}}}}var commandHistory=function(){var entries=[],pos=-1;return clearhistoryhook=hook(clearhistoryhook,(function(){entries=[],pos=-1})),{push:function(entry){entries.length>0&&entries[entries.length-1]===entry?pos=-1:(entries.push(entry),pos=-1,historyhook&&historyhook(entry))},next:function(){if(0!==entries.length)return pos=-1===pos?0:pos===entries.length-1?0:pos+1,entries[pos]},prev:function(){if(0!==entries.length)return pos=-1===pos?entries.length-1:0===pos?entries.length-1:pos-1,entries[pos]}}}(),input={};function initInput(){function keyNameForEvent(e){return window.ke=e,e.key||{3:"Enter",10:"Enter",13:"Enter",38:"ArrowUp",40:"ArrowDown",63232:"ArrowUp",63233:"ArrowDown"}[e.keyCode]}input.setMulti=function(){document.body.classList.remove("single"),document.body.classList.add("multi")},input.setSingle=function(){document.body.classList.remove("multi"),document.body.classList.add("single")};var isMulti=function(){return document.body.classList.contains("multi")};function run(remote){!0!==remote&&window.TogetherJS&&window.TogetherJS.running&&TogetherJS.send({type:"run"});var error=$("#display #error");error.classList.remove("shown");var v=input.getValue();""!==v&&(commandHistory.push(v),isMulti()||input.setValue(""),setTimeout((function(){document.body.classList.add("running"),logo.run(v).catch((function(e){error.innerHTML="",error.appendChild(document.createTextNode(e.message)),error.classList.add("shown")})).then((function(){document.body.classList.remove("running")}))}),100))}function stop(){logo.bye(),document.body.classList.remove("running")}function clear(remote){!0!==remote&&window.TogetherJS&&window.TogetherJS.running&&TogetherJS.send({type:"clear"}),input.setValue("")}if(input.run=run,input.clear=clear,"undefined"!=typeof CodeMirror){var BRACKETS="()[]{}";CodeMirror.keyMap["single-line"]={Enter:function(cm){run()},Up:function(cm){var v=commandHistory.prev();void 0!==v&&(cm.setValue(v),cm.setCursor({line:0,ch:v.length}))},Down:function(cm){var v=commandHistory.next();void 0!==v&&(cm.setValue(v),cm.setCursor({line:0,ch:v.length}))},fallthrough:["default"]};var cm=CodeMirror.fromTextArea($("#logo-ta-single-line"),{autoCloseBrackets:{pairs:"()[]{}",explode:!1},matchBrackets:!0,lineComment:";",keyMap:"single-line"});$("#logo-ta-single-line + .CodeMirror").id="logo-cm-single-line",cm.setSize("100%",cm.defaultTextHeight()+4+4),cm.on("change",(function(cm,change){if(change.text.length>1){var v=input.getValue();input.setMulti(),input.setValue(v),input.setFocus()}}));var cm2=CodeMirror.fromTextArea($("#logo-ta-multi-line"),{autoCloseBrackets:{pairs:"()[]{}",explode:"()[]{}"},matchBrackets:!0,lineComment:";",lineNumbers:!0});$("#logo-ta-multi-line + .CodeMirror").id="logo-cm-multi-line",cm2.setSize("100%","100%"),cm2.on("keydown",(function(instance,event){"Enter"===keyNameForEvent(event)&&event.ctrlKey&&(event.preventDefault(),run())})),input.getValue=function(){return(isMulti()?cm2:cm).getValue()},input.setValue=function(v){(isMulti()?cm2:cm).setValue(v)},input.setFocus=function(){(isMulti()?cm2:cm).focus()}}else $("#logo-ta-single-line").addEventListener("keydown",(function(e){var elem=$("#logo-ta-single-line"),keyMap={Enter:function(elem){run()},ArrowUp:function(elem){var v=commandHistory.prev();void 0!==v&&(elem.value=v)},ArrowDown:function(elem){var v=commandHistory.next();void 0!==v&&(elem.value=v)}},keyName=keyNameForEvent(e);keyName in keyMap&&"function"==typeof keyMap[keyName]&&(keyMap[keyName](elem),e.stopPropagation(),e.preventDefault())})),input.getValue=function(){return $(isMulti()?"#logo-ta-multi-line":"#logo-ta-single-line").value},input.setValue=function(v){$(isMulti()?"#logo-ta-multi-line":"#logo-ta-single-line").value=v},input.setFocus=function(){$(isMulti()?"#logo-ta-multi-line":"#logo-ta-single-line").focus()};input.setFocus(),$("#input").addEventListener("click",(function(){input.setFocus()})),$("#toggle").addEventListener("click",(function(){var v=input.getValue();document.body.classList.toggle("single"),document.body.classList.toggle("multi"),v=isMulti()?v.replace(/\s\s(\s*)/g,"\n$1"):v.replace(/\n/g,"  "),input.setValue(v),input.setFocus()})),$("#run").addEventListener("click",run),$("#stop").addEventListener("click",stop),$("#clear").addEventListener("click",clear),window.addEventListener("message",(function(e){if("example"in e.data){var text=e.data.example;input.setSingle(),input.setValue(text),input.setFocus()}}))}!function(){function resize(){var box,rect=$("#display-panel .inner").getBoundingClientRect(),w=rect.width,h=rect.height;$("#sandbox").width=w,$("#sandbox").height=h,$("#turtle").width=w,$("#turtle").height=h,$("#overlay").width=w,$("#overlay").height=h,logo&&turtle&&(turtle.resize(w,h),logo.run("cs"))}window.addEventListener("resize",resize),window.addEventListener("DOMContentLoaded",resize)}(),function(){var sidebars=Array.from($$("#sidebar .choice")).map((function(elem){return elem.id}));sidebars.forEach((function(k){$("#sb-link-"+k).addEventListener("click",(function(){var cl=$("#sidebar").classList;sidebars.forEach((function(sb){cl.remove(sb)})),cl.add(k)}))}))}(),savehook=hook(savehook,(function(name,def){var parent=$("#library .snippets");def?insertSnippet(def,parent,name):removeSnippet(parent,name)})),historyhook=hook(historyhook,(function(entry){var parent;insertSnippet(entry,$("#history .snippets"))})),clearhistoryhook=hook(clearhistoryhook,(function(){for(var parent=$("#history .snippets");parent.firstChild;)parent.removeChild(parent.firstChild)}));var snippets=new Map;function insertSnippet(text,parent,key,options){var snippet;options=options||{},key&&snippets.has(key)?(snippet=snippets.get(key)).innerHTML="":((snippet=document.createElement("div")).className="snippet",snippet.title="Click to edit",snippet.addEventListener("click",(function(){input.setMulti(),input.setValue(text)})),key&&snippets.set(key,snippet));var container=document.createElement("pre");snippet.appendChild(container),"undefined"!=typeof CodeMirror?CodeMirror.runMode(text,"logo",container):container.appendChild(document.createTextNode(text)),options.noScroll||(parent.scrollTimeoutId&&clearTimeout(parent.scrollTimeoutId),parent.scrollTimeoutId=setTimeout((function(){parent.scrollTimeoutId=null,parent.scrollTop=snippet.offsetTop}),100)),snippet.parentElement!==parent&&parent.appendChild(snippet)}function removeSnippet(parent,key){var snippet;key&&snippets.has(key)&&(snippet=snippets.get(key),parent.removeChild(snippet),snippets.delete(key))}window.addEventListener("DOMContentLoaded",(function(){var queryParams={},queryRest;function asyncResult(value){return new Promise((function(resolve){setTimeout((function(){resolve(value)}),0)}))}document.location.search&&document.location.search.substring(1).split("&").forEach((function(entry){var match=/^(\w+)=(.*)$/.exec(entry);match?queryParams[decodeURIComponent(match[1])]=decodeURIComponent(match[2]):queryRest="?"+entry})),$("#overlay").style.fontSize="13px",$("#overlay").style.fontFamily="monospace",$("#overlay").style.color="black";var stream={read:function(s){return Dialog.prompt(s||"")},write:function(){for(var div=$("#overlay"),i=0;i<arguments.length;i+=1)div.innerHTML+=escapeHTML(arguments[i]);return div.scrollTop=div.scrollHeight,asyncResult()},clear:function(){var div;return $("#overlay").innerHTML="",asyncResult()},readback:function(){var div;return asyncResult($("#overlay").innerHTML)},get textsize(){return parseFloat($("#overlay").style.fontSize.replace("px",""))},set textsize(height){$("#overlay").style.fontSize=Math.max(height,1)+"px"},get font(){return $("#overlay").style.fontFamily},set font(name){-1===["serif","sans-serif","cursive","fantasy","monospace"].indexOf(name)&&(name=JSON.stringify(name)),$("#overlay").style.fontFamily=name},get color(){return $("#overlay").style.color},set color(color){$("#overlay").style.color=color}},canvas_element=$("#sandbox"),canvas_ctx=canvas_element.getContext("2d"),turtle_element,turtle_ctx=$("#turtle").getContext("2d");function saveDataAs(dataURL,filename){if(!("download"in document.createElement("a")))return!1;var anchor=document.createElement("a");anchor.href=dataURL,anchor.download=filename;var event=document.createEvent("MouseEvents");return event.initMouseEvent("click",!0,!0,window,null,0,0,0,0,!1,!1,!1,!1,0,null),anchor.dispatchEvent(event),!0}turtle=new CanvasTurtle(canvas_ctx,turtle_ctx,canvas_element.width,canvas_element.height,$("#overlay")),(logo=new LogoInterpreter(turtle,stream,(function(name,def){savehook&&savehook(name,def)}))).run("cs"),initStorage((function(def){logo.run(def)})),$("#savelibrary").addEventListener("click",(function(){var library=logo.procdefs().replace("\n","\r\n"),url;saveDataAs("data:text/plain,"+encodeURIComponent(library),"logo_library.txt")||Dialog.alert("Sorry, not supported by your browser")})),$("#screenshot").addEventListener("click",(function(){var canvas,url;saveDataAs(document.querySelector("#sandbox").toDataURL("image/png"),"logo_drawing.png")||Dialog.alert("Sorry, not supported by your browser")})),$("#clearhistory").addEventListener("click",(function(){confirm(__("Clear history: Are you sure?"))&&clearhistoryhook()})),$("#clearlibrary").addEventListener("click",(function(){confirm(__("Clear library: Are you sure?"))&&logo.run("erall")}));var __=function(s){return s},localizationComplete=function(){function localize(data){var translation,ids,aliases;"page"in data&&("dir"in data.page&&(document.body.dir=data.page.dir),"examples"in data.page&&(examples=data.page.examples),"translations"in data.page&&(translation=data.page.translations,ids=new Set,Object.keys(translation).forEach((function(key){var parts=key.split("."),id=parts[0],attr=parts[1],s=translation[key];ids.add(id);var elem=document.querySelector('[data-l10n-id="'+id+'"]');elem?attr?elem.setAttribute(attr,s):elem.textContent=s:console.warn("Unused translation: "+id)})),Array.from(document.querySelectorAll("[data-l10n-id]")).map((function(element){return element.getAttribute("data-l10n-id")})).filter((function(id){return!ids.has(id)})).forEach((function(id){console.warn("Missing translation: "+id)}))),"messages"in data.page&&(__=function(s){return data.page.messages[s]||s})),"interpreter"in data&&("messages"in data.interpreter&&(logo.localize=function(s){return data.interpreter.messages[s]}),"keywords"in data.interpreter&&(logo.keywordAlias=function(s){return data.interpreter.keywords[s]}),"procedures"in data.interpreter&&(aliases=data.interpreter.procedures,Object.keys(aliases).forEach((function(alias){logo.copydef(alias,aliases[alias])})))),"graphics"in data&&"colors"in data.graphics&&(logo.colorAlias=function(s){return data.graphics.colors[s]})}var lang=queryParams.lang||navigator.language||navigator.userLanguage;return lang?(lang=lang.split("-")[0],document.body.lang=lang,"en"===lang?Promise.resolve():fetch("l10n/lang-"+lang+".json").then((function(response){if(!response.ok)throw Error(response.statusText);return response.text()})).then((function(text){window.json=text,localize(JSON.parse(text))})).catch((function(reason){console.warn('Error loading localization file for "'+lang+'": '+reason.message),document.body.lang="en"}))):Promise.resolve()}(),param;function demo(param){(param=String(param)).length>0&&(param=decodeURIComponent(param.substring(1).replace(/_/g," ")),input.setValue(param),logo.run(param).catch((function(e){Dialog.alert("Error: "+e.message)})))}fetch("l10n/languages.txt").then((function(response){if(!response.ok)throw Error(response.statusText);return response.text()})).then((function(text){var select=$("#select-lang");text.split(/\r?\n/g).forEach((function(entry){var match=/^(\w+)\s+(.*)$/.exec(entry);if(match){var opt=document.createElement("option");opt.value=match[1],opt.textContent=match[2],select.appendChild(opt)}})),select.value=document.body.lang,select.addEventListener("change",(function(){var url=String(document.location);url=url.replace(/[?#].*/,""),document.location=url+"?lang="+select.value}))})),localizationComplete.then(initInput),localizationComplete.then((function(){fetch(examples).then((function(response){if(!response.ok)throw Error(response.statusText);return response.text()})).then((function(text){var parent=$("#examples");text.split(/\n\n/g).forEach((function(line){insertSnippet(line,parent,void 0,{noScroll:!0})}))}))})),demo(queryRest||document.location.hash),window.addEventListener("hashchange",(function(){demo(document.location.hash)}))})),window.TogetherJSConfig={hub_on:{"togetherjs.hello":function(){var visible=turtle.isturtlevisible();TogetherJS.send({type:"init",image:$("#sandbox").toDataURL("image/png"),turtle:turtle.getstate()})},init:function(msg){var context=$("#sandbox").getContext("2d"),image=document.createElement("image");image.src=msg.image,context.drawImage(image,0,0),turtle.setstate(msg.turtle)},run:function(msg){input.run(!0)},clear:function(msg){input.clear(!0)}}};